import"./B5Qt9EMX.js";{class m{constructor(){this._broadcastChannel=typeof BroadcastChannel>"u"?null:new BroadcastChannel("offline"),this._queuedMessages=[],this._onMessageCallback=null,this._broadcastChannel&&(this._broadcastChannel.onmessage=o=>this._OnBroadcastChannelMessage(o))}_OnBroadcastChannelMessage(o){if(this._onMessageCallback){this._onMessageCallback(o);return}this._queuedMessages.push(o)}SetMessageCallback(o){this._onMessageCallback=o;for(let e of this._queuedMessages)this._onMessageCallback(e);this._queuedMessages.length=0}}window.OfflineClientInfo=new m}window.DOMHandler=class{constructor(a,o){this._iRuntime=a,this._componentId=o,this._hasTickCallback=!1,this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(a,o,e,i){this._iRuntime.PostToRuntimeComponent(this._componentId,a,o,e,i)}PostToRuntimeAsync(a,o,e,i){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,a,o,e,i)}_PostToRuntimeMaybeSync(a,o,e){this._iRuntime.UsesWorker()?this.PostToRuntime(a,o,e):this._iRuntime._GetLocalRuntime()._OnMessageFromDOM({type:"event",component:this._componentId,handler:a,dispatchOpts:e||null,data:o,responseId:null})}AddRuntimeMessageHandler(a,o){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,a,o)}AddRuntimeMessageHandlers(a){for(const[o,e]of a)this.AddRuntimeMessageHandler(o,e)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}},window.RateLimiter=class{constructor(a,o){this._callback=a,this._interval=o,this._timerId=-1,this._lastCallTime=-1/0,this._timerCallFunc=()=>this._OnTimer(),this._ignoreReset=!1,this._canRunImmediate=!1}SetCanRunImmediate(a){this._canRunImmediate=!!a}Call(){if(this._timerId!==-1)return;const a=Date.now(),o=a-this._lastCallTime,e=this._interval;o>=e&&this._canRunImmediate?(this._lastCallTime=a,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(e-o,4))}_RunCallback(){this._ignoreReset=!0,this._callback(),this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._lastCallTime=Date.now())}_OnTimer(){this._timerId=-1,this._lastCallTime=Date.now(),this._RunCallback()}_CancelTimer(){this._timerId!==-1&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer(),this._callback=null,this._timerCallFunc=null}};window.DOMElementHandler=class extends self.DOMHandler{constructor(a,o){super(a,o),this._elementMap=new Map,this._autoAttach=!0,this.AddRuntimeMessageHandlers([["create",e=>this._OnCreate(e)],["destroy",e=>this._OnDestroy(e)],["set-visible",e=>this._OnSetVisible(e)],["update-position",e=>this._OnUpdatePosition(e)],["update-state",e=>this._OnUpdateState(e)],["focus",e=>this._OnSetFocus(e)],["set-css-style",e=>this._OnSetCssStyle(e)],["set-attribute",e=>this._OnSetAttribute(e)],["remove-attribute",e=>this._OnRemoveAttribute(e)]]),this.AddDOMElementMessageHandler("get-element",e=>e)}SetAutoAttach(a){this._autoAttach=!!a}AddDOMElementMessageHandler(a,o){this.AddRuntimeMessageHandler(a,e=>{const i=e.elementId,n=this._elementMap.get(i);return o(n,e)})}_OnCreate(a){const o=a.elementId,e=this.CreateElement(o,a);this._elementMap.set(o,e),e.style.boxSizing="border-box",a.isVisible||(e.style.display="none");const i=this._GetFocusElement(e);i.addEventListener("focus",n=>this._OnFocus(o)),i.addEventListener("blur",n=>this._OnBlur(o)),this._autoAttach&&document.body.appendChild(e)}CreateElement(a,o){throw new Error("required override")}DestroyElement(a){}_OnDestroy(a){const o=a.elementId,e=this._elementMap.get(o);this.DestroyElement(e),this._autoAttach&&e.parentElement.removeChild(e),this._elementMap.delete(o)}PostToRuntimeElement(a,o,e){e||(e={}),e.elementId=o,this.PostToRuntime(a,e)}_PostToRuntimeElementMaybeSync(a,o,e){e||(e={}),e.elementId=o,this._PostToRuntimeMaybeSync(a,e)}_OnSetVisible(a){if(!this._autoAttach)return;const o=this._elementMap.get(a.elementId);o.style.display=a.isVisible?"":"none"}_OnUpdatePosition(a){if(!this._autoAttach)return;const o=this._elementMap.get(a.elementId);o.style.left=a.left+"px",o.style.top=a.top+"px",o.style.width=a.width+"px",o.style.height=a.height+"px";const e=a.fontSize;e!==null&&(o.style.fontSize=e+"em")}_OnUpdateState(a){const o=this._elementMap.get(a.elementId);this.UpdateState(o,a)}UpdateState(a,o){throw new Error("required override")}_GetFocusElement(a){return a}_OnFocus(a){this.PostToRuntimeElement("elem-focused",a)}_OnBlur(a){this.PostToRuntimeElement("elem-blurred",a)}_OnSetFocus(a){const o=this._GetFocusElement(this._elementMap.get(a.elementId));a.focus?o.focus():o.blur()}_OnSetCssStyle(a){const o=this._elementMap.get(a.elementId);o.style[a.prop]=a.val}_OnSetAttribute(a){this._elementMap.get(a.elementId).setAttribute(a.name,a.val)}_OnRemoveAttribute(a){this._elementMap.get(a.elementId).removeAttribute(a.name)}GetElementById(a){return this._elementMap.get(a)}};{let e=function(u){const t=document.createElement("script");return t.async=!1,t.type="module",u.isStringSrc?new Promise(s=>{const r="c3_resolve_"+o;++o,self[r]=s,t.textContent=u.str+`

self["${r}"]();`,document.head.appendChild(t)}):new Promise((s,r)=>{t.onload=s,t.onerror=r,t.src=u,document.head.appendChild(t)})},d=function(){if(!i){try{new Worker("blob://",{get type(){n=!0}})}catch{}i=!0}return n},b=function(u){return new Promise((t,s)=>{const r=new FileReader;r.onload=l=>t(l.target.result),r.onerror=l=>s(l),r.readAsArrayBuffer(u)})},k=function(u){return I.has(u)};const m=/(iphone|ipod|ipad|macos|macintosh|mac os x)/i.test(navigator.userAgent),a=/android/i.test(navigator.userAgent);let o=0,i=!1,n=!1,c=new Audio;const _={"audio/webm; codecs=opus":!!c.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!c.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!c.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!c.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!c.canPlayType("audio/mp4"),"audio/mpeg":!!c.canPlayType("audio/mpeg")};c=null;async function y(u){const t=await b(u);return new TextDecoder("utf-8").decode(t)}const R=[];let S=0;const v=8;window.RealFile=window.File;const C=[],P=new Map,A=new Map;let O=0;const E=[];self.runOnStartup=function(t){if(typeof t!="function")throw new Error("runOnStartup called without a function");E.push(t)};const I=new Set(["cordova","playable-ad","instant-games"]);let M=!1;window.RuntimeInterface=class N{constructor(t){if(this._useWorker=t.useWorker,this._messageChannelPort=null,this._runtimeBaseUrl="",this._scriptFolder=t.scriptFolder,this._workerScriptURLs={},this._worker=null,this._localRuntime=null,this._domHandlers=[],this._runtimeDomHandler=null,this._canvas=null,this._isExportingToVideo=!1,this._exportToVideoDuration=0,this._jobScheduler=null,this._rafId=-1,this._rafFunc=()=>this._OnRAFCallback(),this._rafCallbacks=[],this._exportType=t.exportType,this._isFileProtocol=location.protocol.substr(0,4)==="file",this._useWorker&&(typeof OffscreenCanvas>"u"||!navigator.userActivation||!d())&&(this._useWorker=!1),(this._exportType==="playable-ad"||this._exportType==="instant-games")&&(this._useWorker=!1),this._exportType==="cordova"&&this._useWorker)if(a){const s=/Chrome\/(\d+)/i.exec(navigator.userAgent);(!s||!(parseInt(s[1],10)>=90))&&(this._useWorker=!1)}else this._useWorker=!1;this._localFileBlobs=null,this._localFileStrings=null,this._exportType==="html5"&&!window.isSecureContext&&console.warn("[Construct] Warning: the browser indicates this is not a secure context. Some features may be unavailable. Use secure (HTTPS) hosting to ensure all features are available."),this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",s=>this._OnCordovaFetchLocalFile(s)),this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",s=>this._OnCreateJobWorker(s)),this._exportType==="cordova"?document.addEventListener("deviceready",()=>this._Init(t)):this._Init(t)}Release(){this._CancelAnimationFrame(),this._messageChannelPort&&(this._messageChannelPort.onmessage=null,this._messageChannelPort=null),this._worker&&(this._worker.terminate(),this._worker=null),this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null),this._canvas&&(this._canvas.parentElement.removeChild(this._canvas),this._canvas=null)}GetCanvas(){return this._canvas}GetRuntimeBaseURL(){return this._runtimeBaseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsFileProtocol(){return this._isFileProtocol}GetScriptFolder(){return this._scriptFolder}IsiOSCordova(){return m&&this._exportType==="cordova"}IsiOSWebView(){const t=navigator.userAgent;return m&&k(this._exportType)||navigator.standalone||/crios\/|fxios\/|edgios\//i.test(t)}IsAndroid(){return a}IsAndroidWebView(){return a&&k(this._exportType)}async _Init(t){if(this._exportType==="macos-wkwebview"&&this._SendWrapperMessage({type:"ready"}),this._exportType==="playable-ad"){this._localFileBlobs=self.c3_base64files,this._localFileStrings={},await this._ConvertDataUrisToBlobs();for(let r=0,l=t.engineScripts.length;r<l;++r){const h=t.engineScripts[r].toLowerCase();this._localFileStrings.hasOwnProperty(h)?t.engineScripts[r]={isStringSrc:!0,str:this._localFileStrings[h]}:this._localFileBlobs.hasOwnProperty(h)&&(t.engineScripts[r]=URL.createObjectURL(this._localFileBlobs[h]))}}if(t.runtimeBaseUrl)this._runtimeBaseUrl=t.runtimeBaseUrl;else{const r=location.origin;this._runtimeBaseUrl=(r==="null"?"file:///":r)+location.pathname;const l=this._runtimeBaseUrl.lastIndexOf("/");l!==-1&&(this._runtimeBaseUrl=this._runtimeBaseUrl.substr(0,l+1))}t.workerScripts&&(this._workerScriptURLs=t.workerScripts);const s=new MessageChannel;if(this._messageChannelPort=s.port1,this._messageChannelPort.onmessage=r=>this._OnMessageFromRuntime(r.data),window.c3_addPortMessageHandler&&window.c3_addPortMessageHandler(r=>this._OnMessageFromDebugger(r)),this._jobScheduler=new self.JobSchedulerDOM(this),await this._jobScheduler.Init(),typeof window.StatusBar=="object"&&window.StatusBar.hide(),typeof window.AndroidFullScreen=="object")try{await new Promise((r,l)=>{window.AndroidFullScreen.immersiveMode(r,l)})}catch(r){console.error("Failed to enter Android immersive mode: ",r)}this._useWorker?await this._InitWorker(t,s.port2):await this._InitDOM(t,s.port2)}_GetWorkerURL(t){let s;return this._workerScriptURLs.hasOwnProperty(t)?s=this._workerScriptURLs[t]:t.endsWith("/workermain.js")&&this._workerScriptURLs.hasOwnProperty("workermain.js")?s=this._workerScriptURLs["workermain.js"]:this._exportType==="playable-ad"&&this._localFileBlobs.hasOwnProperty(t.toLowerCase())?s=this._localFileBlobs[t.toLowerCase()]:s=t,s instanceof Blob&&(s=URL.createObjectURL(s)),s}async CreateWorker(t,s,r){if(t.startsWith("blob:"))return new Worker(t,r);if(this._exportType==="cordova"&&this._isFileProtocol){let g="";r.isC3MainWorker?g=t:g=this._scriptFolder+t;const p=await this.CordovaFetchLocalFileAsArrayBuffer(g),f=new Blob([p],{type:"application/javascript"});return new Worker(URL.createObjectURL(f),r)}const l=new URL(t,s);if(location.origin!==l.origin){const g=await fetch(l);if(!g.ok)throw new Error("failed to fetch worker script");const p=await g.blob();return new Worker(URL.createObjectURL(p),r)}else return new Worker(l,r)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}_GetCommonRuntimeOptions(t){return{runtimeBaseUrl:this._runtimeBaseUrl,previewUrl:location.href,windowInnerWidth:this._GetWindowInnerWidth(),windowInnerHeight:this._GetWindowInnerHeight(),devicePixelRatio:window.devicePixelRatio,isFullscreen:N.IsDocumentFullscreen(),projectData:t.projectData,previewImageBlobs:window.cr_previewImageBlobs||this._localFileBlobs,previewProjectFileBlobs:window.cr_previewProjectFileBlobs,previewProjectFileSWUrls:window.cr_previewProjectFiles,swClientId:window.cr_swClientId||"",exportType:t.exportType,isDebug:new URLSearchParams(self.location.search).has("debug"),ife:!!self.ife,jobScheduler:this._jobScheduler.GetPortData(),supportedAudioFormats:_,opusWasmScriptUrl:window.cr_opusWasmScriptUrl||this._scriptFolder+"opus.wasm.js",opusWasmBinaryUrl:window.cr_opusWasmBinaryUrl||this._scriptFolder+"opus.wasm.wasm",isFileProtocol:this._isFileProtocol,isiOSCordova:this.IsiOSCordova(),isiOSWebView:this.IsiOSWebView(),isFBInstantAvailable:typeof self.FBInstant<"u"}}async _InitWorker(t,s){const r=this._GetWorkerURL(t.workerMainUrl);this._worker=await this.CreateWorker(r,this._runtimeBaseUrl,{type:"module",name:"Runtime",isC3MainWorker:!0}),this._canvas=document.createElement("canvas"),this._canvas.style.display="none";const l=this._canvas.transferControlToOffscreen();document.body.appendChild(this._canvas),window.c3canvas=this._canvas,self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders();let h=t.workerDependencyScripts||[],g=t.engineScripts;if(h=await Promise.all(h.map(p=>this._MaybeGetCordovaScriptURL(p))),g=await Promise.all(g.map(p=>this._MaybeGetCordovaScriptURL(p))),this._exportType==="cordova")for(let p=0,f=t.projectScripts.length;p<f;++p){const w=t.projectScripts[p],T=w[0];(T===t.mainProjectScript||T==="scriptsInEvents.js"||T.endsWith("/scriptsInEvents.js"))&&(w[1]=await this._MaybeGetCordovaScriptURL(T))}this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(t),{type:"init-runtime",isInWorker:!0,messagePort:s,canvas:l,workerDependencyScripts:h,engineScripts:g,projectScripts:t.projectScripts,mainProjectScript:t.mainProjectScript,projectScriptsStatus:self.C3_ProjectScriptsStatus}),[s,l,...this._jobScheduler.GetPortTransferables()]),this._domHandlers=C.map(p=>new p(this)),this._FindRuntimeDOMHandler(),self.c3_callFunction=(p,f)=>this._runtimeDomHandler._InvokeFunctionFromJS(p,f),this._exportType==="preview"&&(self.goToLastErrorScript=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(t,s){this._canvas=document.createElement("canvas"),this._canvas.style.display="none",document.body.appendChild(this._canvas),window.c3canvas=this._canvas,self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders(),this._domHandlers=C.map(f=>new f(this)),this._FindRuntimeDOMHandler();let r=t.engineScripts.map(f=>typeof f=="string"?new URL(f,this._runtimeBaseUrl).toString():f);Array.isArray(t.workerDependencyScripts)&&r.unshift(...t.workerDependencyScripts),r=await Promise.all(r.map(f=>this._MaybeGetCordovaScriptURL(f))),await Promise.all(r.map(f=>e(f)));const l=self.C3_ProjectScriptsStatus,h=t.mainProjectScript,g=t.projectScripts;for(let[f,w]of g)if(w||(w=f),f===h)try{w=await this._MaybeGetCordovaScriptURL(w),await e(w),this._exportType==="preview"&&!l[f]&&this._ReportProjectMainScriptError(f,"main script did not run to completion")}catch(T){this._ReportProjectMainScriptError(f,T)}else(f==="scriptsInEvents.js"||f.endsWith("/scriptsInEvents.js"))&&(w=await this._MaybeGetCordovaScriptURL(w),await e(w));if(this._exportType==="preview"&&typeof self.C3.ScriptsInEvents!="object"){this._RemoveLoadingMessage();const f="Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax.";console.error("[C3 runtime] "+f),alert(f);return}const p=Object.assign(this._GetCommonRuntimeOptions(t),{isInWorker:!1,messagePort:s,canvas:this._canvas,runOnStartupFunctions:E});this._OnBeforeCreateRuntime(),this._localRuntime=self.C3_CreateRuntime(p),await self.C3_InitRuntime(this._localRuntime,p)}_ReportProjectMainScriptError(t,s){this._RemoveLoadingMessage(),console.error(`[Preview] Failed to load project main script (${t}): `,s),alert(`Failed to load project main script (${t}). Check all your JavaScript code has valid syntax. Press F12 and check the console for error details.`)}_OnBeforeCreateRuntime(){this._RemoveLoadingMessage()}_RemoveLoadingMessage(){const t=window.cr_previewLoadingElem;t&&(t.parentElement.removeChild(t),window.cr_previewLoadingElem=null)}async _OnCreateJobWorker(t){const s=await this._jobScheduler._CreateJobWorker();return{outputPort:s,transferables:[s]}}_GetLocalRuntime(){if(this._useWorker)throw new Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(t,s,r,l,h){this._messageChannelPort.postMessage({type:"event",component:t,handler:s,dispatchOpts:l||null,data:r,responseId:null},h)}PostToRuntimeComponentAsync(t,s,r,l,h){const g=O++,p=new Promise((f,w)=>{A.set(g,{resolve:f,reject:w})});return this._messageChannelPort.postMessage({type:"event",component:t,handler:s,dispatchOpts:l||null,data:r,responseId:g},h),p}_OnMessageFromRuntime(t){const s=t.type;if(s==="event")return this._OnEventFromRuntime(t);if(s==="result")this._OnResultFromRuntime(t);else if(s==="runtime-ready")this._OnRuntimeReady();else if(s==="alert-error")this._RemoveLoadingMessage(),alert(t.message);else if(s==="creating-runtime")this._OnBeforeCreateRuntime();else throw new Error(`unknown message '${s}'`)}_OnEventFromRuntime(t){const s=t.component,r=t.handler,l=t.data,h=t.responseId,g=P.get(s);if(!g){console.warn(`[DOM] No event handlers for component '${s}'`);return}const p=g.get(r);if(!p){console.warn(`[DOM] No handler '${r}' for component '${s}'`);return}let f=null;try{f=p(l)}catch(w){console.error(`Exception in '${s}' handler '${r}':`,w),h!==null&&this._PostResultToRuntime(h,!1,""+w);return}if(h===null)return f;f&&f.then?f.then(w=>this._PostResultToRuntime(h,!0,w)).catch(w=>{console.error(`Rejection from '${s}' handler '${r}':`,w),this._PostResultToRuntime(h,!1,""+w)}):this._PostResultToRuntime(h,!0,f)}_PostResultToRuntime(t,s,r){let l;r&&r.transferables&&(l=r.transferables),this._messageChannelPort.postMessage({type:"result",responseId:t,isOk:s,result:r},l)}_OnResultFromRuntime(t){const s=t.responseId,r=t.isOk,l=t.result,h=A.get(s);r?h.resolve(l):h.reject(l),A.delete(s)}AddRuntimeComponentMessageHandler(t,s,r){let l=P.get(t);if(l||(l=new Map,P.set(t,l)),l.has(s))throw new Error(`[DOM] Component '${t}' already has handler '${s}'`);l.set(s,r)}static AddDOMHandlerClass(t){if(C.includes(t))throw new Error("DOM handler already added");C.push(t)}_FindRuntimeDOMHandler(){for(const t of this._domHandlers)if(t.GetComponentID()==="runtime"){this._runtimeDomHandler=t;return}throw new Error("cannot find runtime DOM handler")}_OnMessageFromDebugger(t){this.PostToRuntimeComponent("debugger","message",t)}_OnRuntimeReady(){for(const t of this._domHandlers)t.Attach()}static IsDocumentFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||M)}static _SetWrapperIsFullscreenFlag(t){M=!!t}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(t){this._rafCallbacks.push(t),this._RequestAnimationFrame()}_RemoveRAFCallback(t){const s=this._rafCallbacks.indexOf(t);if(s===-1)throw new Error("invalid callback");this._rafCallbacks.splice(s,1),this._rafCallbacks.length||this._CancelAnimationFrame()}_RequestAnimationFrame(){this._rafId===-1&&this._rafCallbacks.length&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){this._rafId!==-1&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const t of this._rafCallbacks)t();this._RequestAnimationFrame()}TryPlayMedia(t){this._runtimeDomHandler.TryPlayMedia(t)}RemovePendingPlay(t){this._runtimeDomHandler.RemovePendingPlay(t)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(t){this._runtimeDomHandler.SetSilent(t)}IsAudioFormatSupported(t){return!!_[t]}async _WasmDecodeWebMOpus(t){const s=await this.PostToRuntimeComponentAsync("runtime","opus-decode",{arrayBuffer:t},null,[t]);return new Float32Array(s)}SetIsExportingToVideo(t){this._isExportingToVideo=!0,this._exportToVideoDuration=t}IsExportingToVideo(){return this._isExportingToVideo}GetExportToVideoDuration(){return this._exportToVideoDuration}IsAbsoluteURL(t){return/^(?:[a-z\-]+:)?\/\//.test(t)||t.substr(0,5)==="data:"||t.substr(0,5)==="blob:"}IsRelativeURL(t){return!this.IsAbsoluteURL(t)}async _MaybeGetCordovaScriptURL(t){if(this._exportType==="cordova"&&(t.startsWith("file:")||this._isFileProtocol&&this.IsRelativeURL(t))){let s=t;s.startsWith(this._runtimeBaseUrl)&&(s=s.substr(this._runtimeBaseUrl.length));const r=await this.CordovaFetchLocalFileAsArrayBuffer(s),l=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(l)}else return t}async _OnCordovaFetchLocalFile(t){const s=t.filename;switch(t.as){case"text":return await this.CordovaFetchLocalFileAsText(s);case"buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(s);default:throw new Error("unsupported type")}}_GetPermissionAPI(){const t=window.cordova&&window.cordova.plugins&&window.cordova.plugins.permissions;if(typeof t!="object")throw new Error("Permission API is not loaded");return t}_MapPermissionID(t,s){const r=t[s];if(typeof r!="string")throw new Error("Invalid permission name");return r}_HasPermission(t){const s=this._GetPermissionAPI();return new Promise((r,l)=>s.checkPermission(this._MapPermissionID(s,t),h=>r(!!h.hasPermission),l))}_RequestPermission(t){const s=this._GetPermissionAPI();return new Promise((r,l)=>s.requestPermission(this._MapPermissionID(s,t),h=>r(!!h.hasPermission),l))}async RequestPermissions(t){if(this.GetExportType()!=="cordova"||this.IsiOSCordova())return!0;for(const s of t){if(await this._HasPermission(s))continue;if(await this._RequestPermission(s)===!1)return!1}return!0}async RequirePermissions(...t){if(await this.RequestPermissions(t)===!1)throw new Error("Permission not granted")}CordovaFetchLocalFile(t){const s=window.cordova.file.applicationDirectory+"www/"+t.toLowerCase();return new Promise((r,l)=>{window.resolveLocalFileSystemURL(s,h=>{h.file(r,l)},l)})}async CordovaFetchLocalFileAsText(t){const s=await this.CordovaFetchLocalFile(t);return await y(s)}_CordovaMaybeStartNextArrayBufferRead(){if(!R.length||S>=v)return;S++;const t=R.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(t.filename,t.successCallback,t.errorCallback)}CordovaFetchLocalFileAsArrayBuffer(t){return new Promise((s,r)=>{R.push({filename:t,successCallback:l=>{S--,this._CordovaMaybeStartNextArrayBufferRead(),s(l)},errorCallback:l=>{S--,this._CordovaMaybeStartNextArrayBufferRead(),r(l)}}),this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(t,s,r){try{const l=await this.CordovaFetchLocalFile(t),h=await b(l);s(h)}catch(l){r(l)}}_SendWrapperMessage(t){if(this._exportType==="windows-webview2")window.chrome.webview.postMessage(JSON.stringify(t));else if(this._exportType==="macos-wkwebview")window.webkit.messageHandlers.C3Wrapper.postMessage(JSON.stringify(t));else throw new Error("cannot send wrapper message")}async _ConvertDataUrisToBlobs(){const t=[];for(const[s,r]of Object.entries(this._localFileBlobs))t.push(this._ConvertDataUriToBlobs(s,r));await Promise.all(t)}async _ConvertDataUriToBlobs(t,s){if(typeof s=="object")this._localFileBlobs[t]=new Blob([s.str],{type:s.type}),this._localFileStrings[t]=s.str;else{let r=await this._FetchDataUri(s);r||(r=this._DataURIToBinaryBlobSync(s)),this._localFileBlobs[t]=r}}async _FetchDataUri(t){try{return await(await fetch(t)).blob()}catch(s){return console.warn("Failed to fetch a data: URI. Falling back to a slower workaround. This is probably because the Content Security Policy unnecessarily blocked it. Allow data: URIs in your CSP to avoid this.",s),null}}_DataURIToBinaryBlobSync(t){const s=this._ParseDataURI(t);return this._BinaryStringToBlob(s.data,s.mime_type)}_ParseDataURI(t){const s=t.indexOf(",");if(s<0)throw new URIError("expected comma in data: uri");const r=t.substring(5,s),l=t.substring(s+1),h=r.split(";"),g=h[0]||"",p=h[1],f=h[2];let w;return p==="base64"||f==="base64"?w=atob(l):w=decodeURIComponent(l),{mime_type:g,data:w}}_BinaryStringToBlob(t,s){let r=t.length,l=r>>2,h=new Uint8Array(r),g=new Uint32Array(h.buffer,0,l),p,f;for(p=0,f=0;p<l;++p)g[p]=t.charCodeAt(f++)|t.charCodeAt(f++)<<8|t.charCodeAt(f++)<<16|t.charCodeAt(f++)<<24;let w=r&3;for(;w--;)h[f]=t.charCodeAt(f),++f;return new Blob([h],{type:s})}}}{let a=function(u){return u.sourceCapabilities&&u.sourceCapabilities.firesTouchEvents||u.originalEvent&&u.originalEvent.sourceCapabilities&&u.originalEvent.sourceCapabilities.firesTouchEvents},d=function(u){return new Promise((t,s)=>{const r=document.createElement("link");r.onload=()=>t(r),r.onerror=l=>s(l),r.rel="stylesheet",r.href=u,document.head.appendChild(r)})},c=function(u){return new Promise((t,s)=>{const r=new Image;r.onload=()=>t(r),r.onerror=l=>s(l),r.src=u})},y=function(u){return new Promise((t,s)=>{let r=new FileReader;r.onload=l=>t(l.target.result),r.onerror=l=>s(l),r.readAsText(u)})},R=function(u){do{if(u.parentNode&&u.hasAttribute("contenteditable"))return!0;u=u.parentNode}while(u);return!1},v=function(u){return S.has(u.tagName.toLowerCase())||R(u)},P=function(u){const t=u.target.tagName.toLowerCase();C.has(t)&&u.preventDefault()},A=function(u){(u.metaKey||u.ctrlKey)&&u.preventDefault()},E=function(){try{return window.parent&&window.parent.document.hasFocus()}catch{return!1}},I=function(){const u=document.activeElement;if(!u)return!1;const t=u.tagName.toLowerCase(),s=new Set(["email","number","password","search","tel","text","url"]);return t==="textarea"?!0:t==="input"?s.has(u.type.toLowerCase()||"text"):R(u)};const m=self.RuntimeInterface,o=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),e={dispatchRuntimeEvent:!0,dispatchUserScriptEvent:!0},i={dispatchUserScriptEvent:!0},n={dispatchRuntimeEvent:!0};async function _(u){const t=URL.createObjectURL(u);try{return await c(t)}finally{URL.revokeObjectURL(t)}}async function b(u,t,s){if(!/firefox/i.test(navigator.userAgent))return await _(u);let r=await y(u);const h=new DOMParser().parseFromString(r,"image/svg+xml"),g=h.documentElement;if(g.hasAttribute("width")&&g.hasAttribute("height")){const f=g.getAttribute("width"),w=g.getAttribute("height");if(!f.includes("%")&&!w.includes("%"))return await _(u)}return g.setAttribute("width",t+"px"),g.setAttribute("height",s+"px"),r=new XMLSerializer().serializeToString(h),u=new Blob([r],{type:"image/svg+xml"}),await _(u)}const S=new Set(["input","textarea","datalist","select"]),C=new Set(["canvas","body","html"]);self.C3_GetSvgImageSize=async function(u){const t=await _(u);if(t.width>0&&t.height>0)return[t.width,t.height];{t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.visibility="hidden",document.body.appendChild(t);const s=t.getBoundingClientRect();return document.body.removeChild(t),[s.width,s.height]}},self.C3_RasterSvgImageBlob=async function(u,t,s,r,l){const h=await b(u,t,s),g=document.createElement("canvas");return g.width=r,g.height=l,g.getContext("2d").drawImage(h,0,0,t,s),g};let O=!1;document.addEventListener("pause",()=>O=!0),document.addEventListener("resume",()=>O=!1);const k="runtime",M=class extends self.DOMHandler{constructor(t){super(t,k),this._isFirstSizeUpdate=!0,this._simulatedResizeTimerId=-1,this._targetOrientation="any",this._attachedDeviceOrientationEvent=!1,this._attachedDeviceMotionEvent=!1,this._debugHighlightElem=null,this._isExportToVideo=!1,this._exportVideoProgressMessage="",this._exportVideoUpdateTimerId=-1,this._pointerRawUpdateRateLimiter=null,this._lastPointerRawUpdateEvent=null,this._pointerRawMovementX=0,this._pointerRawMovementY=0,this._enableAndroidVKDetection=!1,this._lastWindowWidth=t._GetWindowInnerWidth(),this._lastWindowHeight=t._GetWindowInnerHeight(),this._virtualKeyboardHeight=0,t.AddRuntimeComponentMessageHandler("canvas","update-size",l=>this._OnUpdateCanvasSize(l)),t.AddRuntimeComponentMessageHandler("runtime","invoke-download",l=>this._OnInvokeDownload(l)),t.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",l=>this._OnRasterSvgImage(l)),t.AddRuntimeComponentMessageHandler("runtime","get-svg-image-size",l=>this._OnGetSvgImageSize(l)),t.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",l=>this._OnSetTargetOrientation(l)),t.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW()),t.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",l=>this._OnPostToDebugger(l)),t.AddRuntimeComponentMessageHandler("runtime","go-to-script",l=>this._OnPostToDebugger(l)),t.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking()),t.AddRuntimeComponentMessageHandler("runtime","debug-highlight",l=>this._OnDebugHighlight(l)),t.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent()),t.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent()),t.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",l=>this._OnAddStylesheet(l)),t.AddRuntimeComponentMessageHandler("runtime","alert",l=>this._OnAlert(l)),t.AddRuntimeComponentMessageHandler("runtime","hide-cordova-splash",()=>this._OnHideCordovaSplash()),t.AddRuntimeComponentMessageHandler("runtime","set-exporting-to-video",l=>this._SetExportingToVideo(l)),t.AddRuntimeComponentMessageHandler("runtime","export-to-video-progress",l=>this._OnExportVideoProgress(l)),t.AddRuntimeComponentMessageHandler("runtime","exported-to-video",l=>this._OnExportedToVideo(l)),t.AddRuntimeComponentMessageHandler("runtime","exported-to-image-sequence",l=>this._OnExportedToImageSequence(l));const s=new Set(["input","textarea","datalist"]);window.addEventListener("contextmenu",l=>{const h=l.target,g=h.tagName.toLowerCase();!s.has(g)&&!R(h)&&l.preventDefault()});const r=t.GetCanvas();if(window.addEventListener("selectstart",P),window.addEventListener("gesturehold",P),r.addEventListener("selectstart",P),r.addEventListener("gesturehold",P),window.addEventListener("touchstart",P,{passive:!1}),typeof PointerEvent<"u"?(window.addEventListener("pointerdown",P,{passive:!1}),r.addEventListener("pointerdown",P)):r.addEventListener("touchstart",P),this._mousePointerLastButtons=0,window.addEventListener("mousedown",l=>{l.button===1&&l.preventDefault()}),window.addEventListener("mousewheel",A,{passive:!1}),window.addEventListener("wheel",A,{passive:!1}),window.addEventListener("resize",()=>this._OnWindowResize()),window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("fullscreenerror",l=>this._OnFullscreenError(l)),window.addEventListener("webkitfullscreenerror",l=>this._OnFullscreenError(l)),window.addEventListener("mozfullscreenerror",l=>this._OnFullscreenError(l)),t.IsiOSWebView())if(window.visualViewport){let l=1/0;window.visualViewport.addEventListener("resize",()=>{const h=window.visualViewport.height;h>l&&(document.scrollingElement.scrollTop=0),l=h})}else window.addEventListener("focusout",()=>{I()||(document.scrollingElement.scrollTop=0)});self.C3WrapperOnMessage=l=>this._OnWrapperMessage(l),this._mediaPendingPlay=new Set,this._mediaRemovedPendingPlay=new WeakSet,this._isSilent=!1}_OnBeforeStartTicking(){return self.setTimeout(()=>{this._enableAndroidVKDetection=!0},1e3),this._iRuntime.GetExportType()==="cordova"?(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):document.addEventListener("visibilitychange",()=>this._OnVisibilityChange(document.hidden)),{isSuspended:!!(document.hidden||O)}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus")),window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{parentHasFocus:E()}),this._mousePointerLastButtons=0}),window.addEventListener("focusin",s=>{v(s.target)&&this._PostRuntimeEvent("keyboard-blur")}),window.addEventListener("keydown",s=>this._OnKeyEvent("keydown",s)),window.addEventListener("keyup",s=>this._OnKeyEvent("keyup",s)),window.addEventListener("dblclick",s=>this._OnMouseEvent("dblclick",s,e)),window.addEventListener("wheel",s=>this._OnMouseWheelEvent("wheel",s)),typeof PointerEvent<"u"?(window.addEventListener("pointerdown",s=>{this._HandlePointerDownFocus(s),this._OnPointerEvent("pointerdown",s)}),this._iRuntime.UsesWorker()&&typeof window.onpointerrawupdate<"u"&&self===self.top?(this._pointerRawUpdateRateLimiter=new self.RateLimiter(()=>this._DoSendPointerRawUpdate(),5),this._pointerRawUpdateRateLimiter.SetCanRunImmediate(!0),window.addEventListener("pointerrawupdate",s=>this._OnPointerRawUpdate(s))):window.addEventListener("pointermove",s=>this._OnPointerEvent("pointermove",s)),window.addEventListener("pointerup",s=>this._OnPointerEvent("pointerup",s)),window.addEventListener("pointercancel",s=>this._OnPointerEvent("pointercancel",s))):(window.addEventListener("mousedown",s=>{this._HandlePointerDownFocus(s),this._OnMouseEventAsPointer("pointerdown",s)}),window.addEventListener("mousemove",s=>this._OnMouseEventAsPointer("pointermove",s)),window.addEventListener("mouseup",s=>this._OnMouseEventAsPointer("pointerup",s)),window.addEventListener("touchstart",s=>{this._HandlePointerDownFocus(s),this._OnTouchEvent("pointerdown",s)}),window.addEventListener("touchmove",s=>this._OnTouchEvent("pointermove",s)),window.addEventListener("touchend",s=>this._OnTouchEvent("pointerup",s)),window.addEventListener("touchcancel",s=>this._OnTouchEvent("pointercancel",s)));const t=()=>this._PlayPendingMedia();window.addEventListener("pointerup",t,!0),window.addEventListener("touchend",t,!0),window.addEventListener("click",t,!0),window.addEventListener("keydown",t,!0),window.addEventListener("gamepadconnected",t,!0),this._iRuntime.IsAndroid()&&!this._iRuntime.IsAndroidWebView()&&navigator.virtualKeyboard&&(navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.addEventListener("geometrychange",()=>{this._OnAndroidVirtualKeyboardChange(this._GetWindowInnerHeight(),navigator.virtualKeyboard.boundingRect.height)}))}_OnAndroidVirtualKeyboardChange(t,s){if(document.body.style.transform="",s>0){const r=document.activeElement;if(r){const l=r.getBoundingClientRect(),h=(l.top+l.bottom)/2,g=(t-s)/2;let p=h-g;p>s&&(p=s),p<0&&(p=0),p>0&&(document.body.style.transform=`translateY(${-p}px)`)}}}_PostRuntimeEvent(t,s){this.PostToRuntime(t,s||null,n)}_GetWindowInnerWidth(){return this._iRuntime._GetWindowInnerWidth()}_GetWindowInnerHeight(){return this._iRuntime._GetWindowInnerHeight()}_OnWindowResize(){if(this._isExportToVideo)return;const t=this._GetWindowInnerWidth(),s=this._GetWindowInnerHeight();if(this._iRuntime.IsAndroidWebView())if(this._enableAndroidVKDetection)if(this._lastWindowWidth===t&&s<this._lastWindowHeight){this._virtualKeyboardHeight=this._lastWindowHeight-s,this._OnAndroidVirtualKeyboardChange(this._lastWindowHeight,this._virtualKeyboardHeight);return}else this._virtualKeyboardHeight>0&&(this._virtualKeyboardHeight=0,this._OnAndroidVirtualKeyboardChange(s,this._virtualKeyboardHeight)),this._lastWindowWidth=t,this._lastWindowHeight=s;else this._lastWindowWidth=t,this._lastWindowHeight=s;this.PostToRuntime("window-resize",{innerWidth:t,innerHeight:s,devicePixelRatio:window.devicePixelRatio,isFullscreen:m.IsDocumentFullscreen()}),this._iRuntime.IsiOSWebView()&&(this._simulatedResizeTimerId!==-1&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(t,s,0))}_ScheduleSimulatedResize(t,s,r){this._simulatedResizeTimerId!==-1&&clearTimeout(this._simulatedResizeTimerId),this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(t,s,r),48)}_OnSimulatedResize(t,s,r){const l=this._GetWindowInnerWidth(),h=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1,l!=t||h!=s?this.PostToRuntime("window-resize",{innerWidth:l,innerHeight:h,devicePixelRatio:window.devicePixelRatio,isFullscreen:m.IsDocumentFullscreen()}):r<10&&this._ScheduleSimulatedResize(l,h,r+1)}_OnSetTargetOrientation(t){this._targetOrientation=t.targetOrientation}_TrySetTargetOrientation(){const t=this._targetOrientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(t).catch(s=>console.warn("[Construct] Failed to lock orientation: ",s));else try{let s=!1;screen.lockOrientation?s=screen.lockOrientation(t):screen.webkitLockOrientation?s=screen.webkitLockOrientation(t):screen.mozLockOrientation?s=screen.mozLockOrientation(t):screen.msLockOrientation&&(s=screen.msLockOrientation(t)),s||console.warn("[Construct] Failed to lock orientation")}catch(s){console.warn("[Construct] Failed to lock orientation: ",s)}}_OnFullscreenChange(){if(this._isExportToVideo)return;const t=m.IsDocumentFullscreen();t&&this._targetOrientation!=="any"&&this._TrySetTargetOrientation(),this.PostToRuntime("fullscreenchange",{isFullscreen:t,innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnFullscreenError(t){console.warn("[Construct] Fullscreen request failed: ",t),this.PostToRuntime("fullscreenerror",{isFullscreen:m.IsDocumentFullscreen(),innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnVisibilityChange(t){t?this._iRuntime._CancelAnimationFrame():this._iRuntime._RequestAnimationFrame(),this.PostToRuntime("visibilitychange",{hidden:t})}_OnKeyEvent(t,s){if(s.key==="Backspace"&&P(s),this._isExportToVideo)return;const r=o.get(s.code)||s.code;this._PostToRuntimeMaybeSync(t,{code:r,key:s.key,which:s.which,repeat:s.repeat,altKey:s.altKey,ctrlKey:s.ctrlKey,metaKey:s.metaKey,shiftKey:s.shiftKey,timeStamp:s.timeStamp},e)}_OnMouseWheelEvent(t,s){this._isExportToVideo||this.PostToRuntime(t,{clientX:s.clientX,clientY:s.clientY,pageX:s.pageX,pageY:s.pageY,deltaX:s.deltaX,deltaY:s.deltaY,deltaZ:s.deltaZ,deltaMode:s.deltaMode,timeStamp:s.timeStamp},e)}_OnMouseEvent(t,s,r){this._isExportToVideo||a(s)||this._PostToRuntimeMaybeSync(t,{button:s.button,buttons:s.buttons,clientX:s.clientX,clientY:s.clientY,pageX:s.pageX,pageY:s.pageY,movementX:s.movementX||0,movementY:s.movementY||0,timeStamp:s.timeStamp},r)}_OnMouseEventAsPointer(t,s){if(this._isExportToVideo||a(s))return;const r=1,l=this._mousePointerLastButtons;(t==="pointerdown"&&l!==0||t==="pointerup"&&s.buttons!==0)&&(t="pointermove"),this._PostToRuntimeMaybeSync(t,{pointerId:r,pointerType:"mouse",button:s.button,buttons:s.buttons,lastButtons:l,clientX:s.clientX,clientY:s.clientY,pageX:s.pageX,pageY:s.pageY,movementX:s.movementX||0,movementY:s.movementY||0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,timeStamp:s.timeStamp},e),this._mousePointerLastButtons=s.buttons,this._OnMouseEvent(s.type,s,i)}_OnPointerEvent(t,s){if(this._isExportToVideo)return;this._pointerRawUpdateRateLimiter&&t!=="pointermove"&&this._pointerRawUpdateRateLimiter.Reset();let r=0;if(s.pointerType==="mouse"&&(r=this._mousePointerLastButtons),this._PostToRuntimeMaybeSync(t,{pointerId:s.pointerId,pointerType:s.pointerType,button:s.button,buttons:s.buttons,lastButtons:r,clientX:s.clientX,clientY:s.clientY,pageX:s.pageX,pageY:s.pageY,movementX:(s.movementX||0)+this._pointerRawMovementX,movementY:(s.movementY||0)+this._pointerRawMovementY,width:s.width||0,height:s.height||0,pressure:s.pressure||0,tangentialPressure:s.tangentialPressure||0,tiltX:s.tiltX||0,tiltY:s.tiltY||0,twist:s.twist||0,timeStamp:s.timeStamp},e),this._pointerRawMovementX=0,this._pointerRawMovementY=0,s.pointerType==="mouse"){let l="mousemove";t==="pointerdown"?l="mousedown":t==="pointerup"&&(l="mouseup"),this._OnMouseEvent(l,s,i),this._mousePointerLastButtons=s.buttons}}_OnPointerRawUpdate(t){this._lastPointerRawUpdateEvent&&(this._pointerRawMovementX+=this._lastPointerRawUpdateEvent.movementX||0,this._pointerRawMovementY+=this._lastPointerRawUpdateEvent.movementY||0),this._lastPointerRawUpdateEvent=t,this._pointerRawUpdateRateLimiter.Call()}_DoSendPointerRawUpdate(){this._OnPointerEvent("pointermove",this._lastPointerRawUpdateEvent),this._lastPointerRawUpdateEvent=null}_OnTouchEvent(t,s){if(!this._isExportToVideo)for(let r=0,l=s.changedTouches.length;r<l;++r){const h=s.changedTouches[r];this._PostToRuntimeMaybeSync(t,{pointerId:h.identifier,pointerType:"touch",button:0,buttons:0,lastButtons:0,clientX:h.clientX,clientY:h.clientY,pageX:h.pageX,pageY:h.pageY,movementX:s.movementX||0,movementY:s.movementY||0,width:(h.radiusX||h.webkitRadiusX||0)*2,height:(h.radiusY||h.webkitRadiusY||0)*2,pressure:h.force||h.webkitForce||0,tangentialPressure:0,tiltX:0,tiltY:0,twist:h.rotationAngle||0,timeStamp:s.timeStamp},e)}}_HandlePointerDownFocus(t){window!==window.top&&window.focus(),this._IsElementCanvasOrDocument(t.target)&&document.activeElement&&!this._IsElementCanvasOrDocument(document.activeElement)&&document.activeElement.blur()}_IsElementCanvasOrDocument(t){return!t||t===document||t===window||t===document.body||t.tagName.toLowerCase()==="canvas"}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",t=>this._OnDeviceOrientation(t)),window.addEventListener("deviceorientationabsolute",t=>this._OnDeviceOrientationAbsolute(t)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",t=>this._OnDeviceMotion(t)))}_OnDeviceOrientation(t){this._isExportToVideo||this.PostToRuntime("deviceorientation",{absolute:!!t.absolute,alpha:t.alpha||0,beta:t.beta||0,gamma:t.gamma||0,timeStamp:t.timeStamp,webkitCompassHeading:t.webkitCompassHeading,webkitCompassAccuracy:t.webkitCompassAccuracy},e)}_OnDeviceOrientationAbsolute(t){this._isExportToVideo||this.PostToRuntime("deviceorientationabsolute",{absolute:!!t.absolute,alpha:t.alpha||0,beta:t.beta||0,gamma:t.gamma||0,timeStamp:t.timeStamp},e)}_OnDeviceMotion(t){if(this._isExportToVideo)return;let s=null;const r=t.acceleration;r&&(s={x:r.x||0,y:r.y||0,z:r.z||0});let l=null;const h=t.accelerationIncludingGravity;h&&(l={x:h.x||0,y:h.y||0,z:h.z||0});let g=null;const p=t.rotationRate;p&&(g={alpha:p.alpha||0,beta:p.beta||0,gamma:p.gamma||0}),this.PostToRuntime("devicemotion",{acceleration:s,accelerationIncludingGravity:l,rotationRate:g,interval:t.interval,timeStamp:t.timeStamp},e)}_OnUpdateCanvasSize(t){const s=this.GetRuntimeInterface();if(s.IsExportingToVideo())return;const r=s.GetCanvas();r.style.width=t.styleWidth+"px",r.style.height=t.styleHeight+"px",r.style.marginLeft=t.marginLeft+"px",r.style.marginTop=t.marginTop+"px",this._isFirstSizeUpdate&&(r.style.display="",this._isFirstSizeUpdate=!1)}_OnInvokeDownload(t){const s=t.url,r=t.filename,l=document.createElement("a"),h=document.body;l.textContent=r,l.href=s,l.download=r,h.appendChild(l),l.click(),h.removeChild(l)}async _OnRasterSvgImage(t){const s=t.blob,r=t.imageWidth,l=t.imageHeight,h=t.surfaceWidth,g=t.surfaceHeight,p=t.imageBitmapOpts,f=await self.C3_RasterSvgImageBlob(s,r,l,h,g);let w;return p?w=await createImageBitmap(f,p):w=await createImageBitmap(f),{imageBitmap:w,transferables:[w]}}async _OnGetSvgImageSize(t){return await self.C3_GetSvgImageSize(t.blob)}async _OnAddStylesheet(t){await d(t.url)}_PlayPendingMedia(){const t=[...this._mediaPendingPlay];if(this._mediaPendingPlay.clear(),!this._isSilent)for(const s of t){const r=s.play();r&&r.catch(l=>{this._mediaRemovedPendingPlay.has(s)||this._mediaPendingPlay.add(s)})}}TryPlayMedia(t){if(typeof t.play!="function")throw new Error("missing play function");this._mediaRemovedPendingPlay.delete(t);let s;try{s=t.play()}catch{this._mediaPendingPlay.add(t);return}s&&s.catch(r=>{this._mediaRemovedPendingPlay.has(t)||this._mediaPendingPlay.add(t)})}RemovePendingPlay(t){this._mediaPendingPlay.delete(t),this._mediaRemovedPendingPlay.add(t)}SetSilent(t){this._isSilent=!!t}_OnHideCordovaSplash(){navigator.splashscreen&&navigator.splashscreen.hide&&navigator.splashscreen.hide()}_OnDebugHighlight(t){if(!t.show){this._debugHighlightElem&&(this._debugHighlightElem.style.display="none");return}this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));const r=this._debugHighlightElem;r.style.display="",r.style.left=t.left-1+"px",r.style.top=t.top-1+"px",r.style.width=t.width+2+"px",r.style.height=t.height+2+"px",r.textContent=t.name}_OnRegisterSW(){window.C3_RegisterSW&&window.C3_RegisterSW()}_OnPostToDebugger(t){window.c3_postToMessagePort&&(t.from="runtime",window.c3_postToMessagePort(t))}_InvokeFunctionFromJS(t,s){return this.PostToRuntimeAsync("js-invoke-function",{name:t,params:s})}_OnAlert(t){alert(t.message)}_OnWrapperMessage(t){t==="entered-fullscreen"?(m._SetWrapperIsFullscreenFlag(!0),this._OnFullscreenChange()):t==="exited-fullscreen"?(m._SetWrapperIsFullscreenFlag(!1),this._OnFullscreenChange()):console.warn("Unknown wrapper message: ",t)}_SetExportingToVideo(t){this._isExportToVideo=!0;const s=document.createElement("h1");s.id="exportToVideoMessage",s.textContent=t.message,document.body.prepend(s),document.body.classList.add("exportingToVideo"),this.GetRuntimeInterface().GetCanvas().style.display="",this._iRuntime.SetIsExportingToVideo(t.duration)}_OnExportVideoProgress(t){this._exportVideoProgressMessage=t.message,this._exportVideoUpdateTimerId===-1&&(this._exportVideoUpdateTimerId=setTimeout(()=>this._DoUpdateExportVideoProgressMessage(),250))}_DoUpdateExportVideoProgressMessage(){this._exportVideoUpdateTimerId=-1;const t=document.getElementById("exportToVideoMessage");t&&(t.textContent=this._exportVideoProgressMessage)}_OnExportedToVideo(t){window.c3_postToMessagePort({type:"exported-video",blob:t.blob,time:t.time})}_OnExportedToImageSequence(t){window.c3_postToMessagePort({type:"exported-image-sequence",blobArr:t.blobArr,time:t.time})}};m.AddDOMHandlerClass(M)}{const m="dispatchworker.js",a="jobworker.js";self.JobSchedulerDOM=class{constructor(e){this._runtimeInterface=e,this._baseUrl=e.GetRuntimeBaseURL(),e.GetExportType()==="preview"?this._baseUrl+="workers/":this._baseUrl+=e.GetScriptFolder(),this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16),this._dispatchWorker=null,this._jobWorkers=[],this._inputPort=null,this._outputPort=null}async Init(){if(this._hasInitialised)throw new Error("already initialised");this._hasInitialised=!0;const e=this._runtimeInterface._GetWorkerURL(m);this._dispatchWorker=await this._runtimeInterface.CreateWorker(e,this._baseUrl,{name:"DispatchWorker"});const i=new MessageChannel;this._inputPort=i.port1,this._dispatchWorker.postMessage({type:"_init","in-port":i.port2},[i.port2]),this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const e=this._jobWorkers.length,i=this._runtimeInterface._GetWorkerURL(a),n=await this._runtimeInterface.CreateWorker(i,this._baseUrl,{name:"JobWorker"+e}),d=new MessageChannel,c=new MessageChannel;return this._dispatchWorker.postMessage({type:"_addJobWorker",port:d.port1},[d.port1]),n.postMessage({type:"init",number:e,"dispatch-port":d.port2,"output-port":c.port2},[d.port2,c.port2]),this._jobWorkers.push(n),c.port1}GetPortData(){return{inputPort:this._inputPort,outputPort:this._outputPort,maxNumWorkers:this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}}}window.C3_IsSupported&&(window.c3_runtimeInterface=new self.RuntimeInterface({useWorker:!1,workerMainUrl:"workermain.js",engineScripts:["scripts/c3runtime.js"],projectScripts:[],mainProjectScript:"",scriptFolder:"scripts/",workerDependencyScripts:[],exportType:"html5"}));{const m=180/Math.PI,a="audio";self.AudioDOMHandler=class extends self.DOMHandler{constructor(e){super(e,a),this._audioContext=null,this._destinationNode=null,this._hasUnblocked=!1,this._hasAttachedUnblockEvents=!1,this._unblockFunc=()=>this._UnblockAudioContext(),this._audioBuffers=[],this._audioInstances=[],this._lastAudioInstance=null,this._lastPlayedTag="",this._lastTickCount=-1,this._pendingTags=new Map,this._masterVolume=1,this._isSilent=!1,this._timeScaleMode=0,this._timeScale=1,this._gameTime=0,this._panningModel="HRTF",this._distanceModel="inverse",this._refDistance=600,this._maxDistance=1e4,this._rolloffFactor=1,this._playMusicAsSound=!1,this._hasAnySoftwareDecodedMusic=!1,this._supportsWebMOpus=this._iRuntime.IsAudioFormatSupported("audio/webm; codecs=opus"),this._effects=new Map,this._analysers=new Set,this._isPendingPostFxState=!1,this._hasStartedOfflineRender=!1,this._microphoneTag="",this._microphoneSource=null,self.C3Audio_OnMicrophoneStream=(i,n)=>this._OnMicrophoneStream(i,n),this._destMediaStreamNode=null,self.C3Audio_GetOutputStream=()=>this._OnGetOutputStream(),self.C3Audio_DOMInterface=this,this.AddRuntimeMessageHandlers([["create-audio-context",i=>this._CreateAudioContext(i)],["play",i=>this._Play(i)],["stop",i=>this._Stop(i)],["stop-all",()=>this._StopAll()],["set-paused",i=>this._SetPaused(i)],["set-volume",i=>this._SetVolume(i)],["fade-volume",i=>this._FadeVolume(i)],["set-master-volume",i=>this._SetMasterVolume(i)],["set-muted",i=>this._SetMuted(i)],["set-silent",i=>this._SetSilent(i)],["set-looping",i=>this._SetLooping(i)],["set-playback-rate",i=>this._SetPlaybackRate(i)],["seek",i=>this._Seek(i)],["preload",i=>this._Preload(i)],["unload",i=>this._Unload(i)],["unload-all",()=>this._UnloadAll()],["set-suspended",i=>this._SetSuspended(i)],["add-effect",i=>this._AddEffect(i)],["set-effect-param",i=>this._SetEffectParam(i)],["remove-effects",i=>this._RemoveEffects(i)],["tick",i=>this._OnTick(i)],["load-state",i=>this._OnLoadState(i)],["offline-render-audio",i=>this._OnOfflineRenderAudio(i)],["offline-render-finish",()=>this._OnOfflineRenderFinish()]])}async _CreateAudioContext(e){if(e.isiOSCordova&&(this._playMusicAsSound=!0),this._timeScaleMode=e.timeScaleMode,this._panningModel=["equalpower","HRTF","soundfield"][e.panningModel],this._distanceModel=["linear","inverse","exponential"][e.distanceModel],this._refDistance=e.refDistance,this._maxDistance=e.maxDistance,this._rolloffFactor=e.rolloffFactor,this._iRuntime.IsExportingToVideo()){this._playMusicAsSound=!0;const n=48e3;this._audioContext=new OfflineAudioContext({numberOfChannels:2,sampleRate:n,length:Math.ceil(this._iRuntime.GetExportToVideoDuration()*n)})}else{const n={latencyHint:e.latencyHint};if(this.SupportsWebMOpus()||(n.sampleRate=48e3),typeof AudioContext<"u")this._audioContext=new AudioContext(n);else if(typeof webkitAudioContext<"u")this._audioContext=new webkitAudioContext(n);else throw new Error("Web Audio API not supported");this._AttachUnblockEvents(),this._audioContext.onstatechange=()=>{this._audioContext.state!=="running"&&this._AttachUnblockEvents(),this.PostToRuntime("audiocontext-state",{audioContextState:this._audioContext.state})}}this._destinationNode=this._audioContext.createGain(),this._destinationNode.connect(this._audioContext.destination);const i=e.listenerPos;this._audioContext.listener.setPosition(i[0],i[1],i[2]),this._audioContext.listener.setOrientation(0,0,1,0,-1,0),self.C3_GetAudioContextCurrentTime=()=>this.GetAudioCurrentTime();try{await Promise.all(e.preloadList.map(n=>this._GetAudioBuffer(n.originalUrl,n.url,n.type,!1)))}catch(n){console.error("[Construct] Preloading sounds failed: ",n)}return{sampleRate:this._audioContext.sampleRate,audioContextState:this._audioContext.state}}_AttachUnblockEvents(){this._hasAttachedUnblockEvents||(this._hasUnblocked=!1,window.addEventListener("pointerup",this._unblockFunc,!0),window.addEventListener("touchend",this._unblockFunc,!0),window.addEventListener("click",this._unblockFunc,!0),window.addEventListener("keydown",this._unblockFunc,!0),this._hasAttachedUnblockEvents=!0)}_DetachUnblockEvents(){this._hasAttachedUnblockEvents&&(this._hasUnblocked=!0,window.removeEventListener("pointerup",this._unblockFunc,!0),window.removeEventListener("touchend",this._unblockFunc,!0),window.removeEventListener("click",this._unblockFunc,!0),window.removeEventListener("keydown",this._unblockFunc,!0),this._hasAttachedUnblockEvents=!1)}_UnblockAudioContext(){if(this._hasUnblocked)return;const e=this._audioContext;e.state==="suspended"&&e.resume&&e.resume();const i=e.createBuffer(1,220,22050),n=e.createBufferSource();n.buffer=i,n.connect(e.destination),n.start(0),e.state==="running"&&this._DetachUnblockEvents()}GetAudioContext(){return this._audioContext}GetAudioCurrentTime(){return this._audioContext.currentTime}GetDestinationNode(){return this._destinationNode}GetDestinationForTag(e){const i=this._effects.get(e.toLowerCase());return i?i[0].GetInputNode():this.GetDestinationNode()}AddEffectForTag(e,i){e=e.toLowerCase();let n=this._effects.get(e);n||(n=[],this._effects.set(e,n)),i._SetIndex(n.length),i._SetTag(e),n.push(i),this._ReconnectEffects(e)}_ReconnectEffects(e){let i=this.GetDestinationNode();const n=this._effects.get(e);if(n&&n.length){i=n[0].GetInputNode();for(let d=0,c=n.length;d<c;++d){const _=n[d];d+1===c?_.ConnectTo(this.GetDestinationNode()):_.ConnectTo(n[d+1].GetInputNode())}}for(const d of this.audioInstancesByTag(e))d.Reconnect(i);this._microphoneSource&&this._microphoneTag===e&&(this._microphoneSource.disconnect(),this._microphoneSource.connect(i))}GetMasterVolume(){return this._masterVolume}IsSilent(){return this._isSilent}GetTimeScaleMode(){return this._timeScaleMode}GetTimeScale(){return this._timeScale}GetGameTime(){return this._gameTime}IsPlayMusicAsSound(){return this._playMusicAsSound}SupportsWebMOpus(){return this._supportsWebMOpus}_SetHasAnySoftwareDecodedMusic(){this._hasAnySoftwareDecodedMusic=!0}GetPanningModel(){return this._panningModel}GetDistanceModel(){return this._distanceModel}GetReferenceDistance(){return this._refDistance}GetMaxDistance(){return this._maxDistance}GetRolloffFactor(){return this._rolloffFactor}DecodeAudioData(e,i){return i?this._iRuntime._WasmDecodeWebMOpus(e).then(n=>{const d=this._audioContext.createBuffer(1,n.length,48e3);return d.getChannelData(0).set(n),d}):new Promise((n,d)=>{this._audioContext.decodeAudioData(e,n,d)})}TryPlayMedia(e){this._iRuntime.TryPlayMedia(e)}RemovePendingPlay(e){this._iRuntime.RemovePendingPlay(e)}ReleaseInstancesForBuffer(e){let i=0;for(let n=0,d=this._audioInstances.length;n<d;++n){const c=this._audioInstances[n];this._audioInstances[i]=c,c.GetBuffer()===e?c.Release():++i}this._audioInstances.length=i}ReleaseAllMusicBuffers(){let e=0;for(let i=0,n=this._audioBuffers.length;i<n;++i){const d=this._audioBuffers[i];this._audioBuffers[e]=d,d.IsMusic()?d.Release():++e}this._audioBuffers.length=e}*audioInstancesByTag(e){if(e)for(const i of this._audioInstances)self.AudioDOMHandler.EqualsNoCase(i.GetTag(),e)&&(yield i);else this._lastAudioInstance&&!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}async _GetAudioBuffer(e,i,n,d,c){for(const y of this._audioBuffers)if(y.GetUrl()===i)return await y.Load(),y;if(c)return null;d&&(this._playMusicAsSound||this._hasAnySoftwareDecodedMusic)&&this.ReleaseAllMusicBuffers();const _=self.C3AudioBuffer.Create(this,e,i,n,d);return this._audioBuffers.push(_),await _.Load(),_}async _GetAudioInstance(e,i,n,d,c){for(const b of this._audioInstances)if(b.GetUrl()===i&&(b.CanBeRecycled()||c))return b.SetTag(d),b;const y=(await this._GetAudioBuffer(e,i,n,c)).CreateInstance(d);return this._audioInstances.push(y),y}_AddPendingTag(e){let i=this._pendingTags.get(e);if(!i){let n=null;i={pendingCount:0,promise:new Promise(c=>n=c),resolve:n},this._pendingTags.set(e,i)}i.pendingCount++}_RemovePendingTag(e){const i=this._pendingTags.get(e);if(!i)throw new Error("expected pending tag");i.pendingCount--,i.pendingCount===0&&(i.resolve(),this._pendingTags.delete(e))}TagReady(e){e||(e=this._lastPlayedTag);const i=this._pendingTags.get(e);return i?i.promise:Promise.resolve()}_MaybeStartTicking(){if(this._analysers.size>0){this._StartTicking();return}for(const e of this._audioInstances)if(e.IsActive()){this._StartTicking();return}}Tick(){for(const n of this._analysers)n.Tick();const e=this.GetAudioCurrentTime();for(const n of this._audioInstances)n.Tick(e);const i=this._audioInstances.filter(n=>n.IsActive()).map(n=>n.GetState());this.PostToRuntime("state",{tickCount:this._lastTickCount,audioInstances:i,analysers:[...this._analysers].map(n=>n.GetData())}),i.length===0&&this._analysers.size===0&&this._StopTicking()}PostTrigger(e,i,n){this.PostToRuntime("trigger",{type:e,tag:i,aiid:n})}async _Play(e){const i=e.originalUrl,n=e.url,d=e.type,c=e.isMusic,_=e.tag,y=e.isLooping,b=e.vol,R=e.pos,S=e.panning;let v=e.off;if(v>0&&!e.trueClock)if(this._audioContext.getOutputTimestamp){const C=this._audioContext.getOutputTimestamp();v=v-C.performanceTime/1e3+C.contextTime}else v=v-performance.now()/1e3+this._audioContext.currentTime;this._lastPlayedTag=_,this._AddPendingTag(_);try{this._lastAudioInstance=await this._GetAudioInstance(i,n,d,_,c),S?(this._lastAudioInstance.SetPannerEnabled(!0),this._lastAudioInstance.SetPan(S.x,S.y,S.angle,S.innerAngle,S.outerAngle,S.outerGain),S.hasOwnProperty("uid")&&this._lastAudioInstance.SetUID(S.uid)):this._lastAudioInstance.SetPannerEnabled(!1),this._lastAudioInstance.Play(y,b,R,v)}catch(C){console.error("[Construct] Audio: error starting playback: ",C);return}finally{this._RemovePendingTag(_)}this._StartTicking()}_Stop(e){const i=e.tag;for(const n of this.audioInstancesByTag(i))n.Stop()}_StopAll(){for(const e of this._audioInstances)e.Stop()}_SetPaused(e){const i=e.tag,n=e.paused;for(const d of this.audioInstancesByTag(i))n?d.Pause():d.Resume();this._MaybeStartTicking()}_SetVolume(e){const i=e.tag,n=e.vol;for(const d of this.audioInstancesByTag(i))d.SetVolume(n)}async _FadeVolume(e){const i=e.tag,n=e.vol,d=e.duration,c=e.stopOnEnd;await this.TagReady(i);for(const _ of this.audioInstancesByTag(i))_.FadeVolume(n,d,c);this._MaybeStartTicking()}_SetMasterVolume(e){this._masterVolume=e.vol,this._destinationNode.gain.value=this._masterVolume}_SetMuted(e){const i=e.tag,n=e.isMuted;for(const d of this.audioInstancesByTag(i))d.SetMuted(n)}_SetSilent(e){this._isSilent=e.isSilent,this._iRuntime.SetSilent(this._isSilent);for(const i of this._audioInstances)i._UpdateMuted()}_SetLooping(e){const i=e.tag,n=e.isLooping;for(const d of this.audioInstancesByTag(i))d.SetLooping(n)}async _SetPlaybackRate(e){const i=e.tag,n=e.rate;await this.TagReady(i);for(const d of this.audioInstancesByTag(i))d.SetPlaybackRate(n)}async _Seek(e){const i=e.tag,n=e.pos;await this.TagReady(i);for(const d of this.audioInstancesByTag(i))d.Seek(n)}async _Preload(e){const i=e.originalUrl,n=e.url,d=e.type,c=e.isMusic;try{await this._GetAudioInstance(i,n,d,"",c)}catch(_){console.error("[Construct] Audio: error preloading: ",_)}}async _Unload(e){const i=e.url,n=e.type,d=e.isMusic,c=await this._GetAudioBuffer("",i,n,d,!0);if(!c)return;c.Release();const _=this._audioBuffers.indexOf(c);_!==-1&&this._audioBuffers.splice(_,1)}_UnloadAll(){for(const e of this._audioBuffers)e.Release();this._audioBuffers.length=0}_SetSuspended(e){const i=e.isSuspended;!i&&this._audioContext.resume&&this._audioContext.resume();for(const n of this._audioInstances)n.SetSuspended(i);i&&this._audioContext.suspend&&this._audioContext.suspend()}_OnTick(e){if(this._timeScale=e.timeScale,this._gameTime=e.gameTime,this._lastTickCount=e.tickCount,this._timeScaleMode!==0)for(const n of this._audioInstances)n._UpdatePlaybackRate();const i=e.listenerPos;i&&this._audioContext.listener.setPosition(i[0],i[1],i[2]);for(const n of e.instPans){const d=n.uid;for(const c of this._audioInstances)c.GetUID()===d&&c.SetPanXYA(n.x,n.y,n.angle)}}async _AddEffect(e){const i=e.type,n=e.tag,d=e.params;let c;if(i==="filter")c=new self.C3AudioFilterFX(this,...d);else if(i==="delay")c=new self.C3AudioDelayFX(this,...d);else if(i==="convolution"){let _=null;try{_=await this._GetAudioBuffer(e.bufferOriginalUrl,e.bufferUrl,e.bufferType,!1)}catch(y){console.log("[Construct] Audio: error loading convolution: ",y);return}c=new self.C3AudioConvolveFX(this,_.GetAudioBuffer(),...d),c._SetBufferInfo(e.bufferOriginalUrl,e.bufferUrl,e.bufferType)}else if(i==="flanger")c=new self.C3AudioFlangerFX(this,...d);else if(i==="phaser")c=new self.C3AudioPhaserFX(this,...d);else if(i==="gain")c=new self.C3AudioGainFX(this,...d);else if(i==="tremolo")c=new self.C3AudioTremoloFX(this,...d);else if(i==="ringmod")c=new self.C3AudioRingModFX(this,...d);else if(i==="distortion")c=new self.C3AudioDistortionFX(this,...d);else if(i==="compressor")c=new self.C3AudioCompressorFX(this,...d);else if(i==="analyser")c=new self.C3AudioAnalyserFX(this,...d);else throw new Error("invalid effect type");this.AddEffectForTag(n,c),this._PostUpdatedFxState()}_SetEffectParam(e){const i=e.tag,n=e.index,d=e.param,c=e.value,_=e.ramp,y=e.time,b=this._effects.get(i);!b||n<0||n>=b.length||(b[n].SetParam(d,c,_,y),this._PostUpdatedFxState())}_RemoveEffects(e){const i=e.tag.toLowerCase(),n=this._effects.get(i);if(!(!n||!n.length)){for(const d of n)d.Release();this._effects.delete(i),this._ReconnectEffects(i)}}_AddAnalyser(e){this._analysers.add(e),this._MaybeStartTicking()}_RemoveAnalyser(e){this._analysers.delete(e)}_PostUpdatedFxState(){this._isPendingPostFxState||(this._isPendingPostFxState=!0,Promise.resolve().then(()=>this._DoPostUpdatedFxState()))}_DoPostUpdatedFxState(){const e={};for(const[i,n]of this._effects)e[i]=n.map(d=>d.GetState());this.PostToRuntime("fxstate",{fxstate:e}),this._isPendingPostFxState=!1}async _OnLoadState(e){const i=e.saveLoadMode;if(i!==3)for(const c of this._audioInstances)c.IsMusic()&&i===1||!c.IsMusic()&&i===2||c.Stop();for(const c of this._effects.values())for(const _ of c)_.Release();this._effects.clear(),this._timeScale=e.timeScale,this._gameTime=e.gameTime;const n=e.listenerPos;this._audioContext.listener.setPosition(n[0],n[1],n[2]),this._isSilent=e.isSilent,this._iRuntime.SetSilent(this._isSilent),this._masterVolume=e.masterVolume,this._destinationNode.gain.value=this._masterVolume;const d=[];for(const c of Object.values(e.effects))d.push(Promise.all(c.map(_=>this._AddEffect(_))));await Promise.all(d),await Promise.all(e.playing.map(c=>this._LoadAudioInstance(c,i))),this._MaybeStartTicking()}async _LoadAudioInstance(e,i){if(i===3)return;const n=e.bufferOriginalUrl,d=e.bufferUrl,c=e.bufferType,_=e.isMusic,y=e.tag,b=e.isLooping,R=e.volume,S=e.playbackTime;if(_&&i===1||!_&&i===2)return;let v=null;try{v=await this._GetAudioInstance(n,d,c,y,_)}catch(C){console.error("[Construct] Audio: error loading audio state: ",C);return}v.LoadPanState(e.pan),v.Play(b,R,S,0),e.isPlaying||v.Pause(),v._LoadAdditionalState(e)}_OnMicrophoneStream(e,i){this._microphoneSource&&this._microphoneSource.disconnect(),this._microphoneTag=i.toLowerCase(),this._microphoneSource=this._audioContext.createMediaStreamSource(e),this._microphoneSource.connect(this.GetDestinationForTag(this._microphoneTag))}_OnGetOutputStream(){return this._destMediaStreamNode||(this._destMediaStreamNode=this._audioContext.createMediaStreamDestination(),this._destinationNode.connect(this._destMediaStreamNode)),this._destMediaStreamNode.stream}async _OnOfflineRenderAudio(e){try{const i=e.time,n=this._audioContext.suspend(i);this._hasStartedOfflineRender?this._audioContext.resume():(this._audioContext.startRendering().then(d=>this._OnOfflineRenderCompleted(d)).catch(d=>this._OnOfflineRenderError(d)),this._hasStartedOfflineRender=!0),await n}catch(i){this._OnOfflineRenderError(i)}}_OnOfflineRenderFinish(){this._audioContext.resume()}_OnOfflineRenderCompleted(e){const i=[];for(let n=0,d=e.numberOfChannels;n<d;++n){const c=e.getChannelData(n);i.push(c.buffer)}this._iRuntime.PostToRuntimeComponent("runtime","offline-audio-render-completed",{duration:e.duration,length:e.length,numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate,channelData:i},null,i)}_OnOfflineRenderError(e){console.error("[Audio] Offline rendering error: ",e)}static EqualsNoCase(e,i){return e.length!==i.length?!1:e===i?!0:e.toLowerCase()===i.toLowerCase()}static ToDegrees(e){return e*m}static DbToLinearNoCap(e){return Math.pow(10,e/20)}static DbToLinear(e){return Math.max(Math.min(self.AudioDOMHandler.DbToLinearNoCap(e),1),0)}static LinearToDbNoCap(e){return Math.log(e)/Math.log(10)*20}static LinearToDb(e){return self.AudioDOMHandler.LinearToDbNoCap(Math.max(Math.min(e,1),0))}static e4(e,i){return 1-Math.exp(-i*e)}},self.RuntimeInterface.AddDOMHandlerClass(self.AudioDOMHandler)}self.C3AudioBuffer=class{constructor(a,o,e,i,n){this._audioDomHandler=a,this._originalUrl=o,this._url=e,this._type=i,this._isMusic=n,this._api="",this._loadState="not-loaded",this._loadPromise=null}Release(){this._loadState="not-loaded",this._audioDomHandler=null,this._loadPromise=null}static Create(a,o,e,i,n){const d=i==="audio/webm; codecs=opus"&&!a.SupportsWebMOpus();return n&&d&&a._SetHasAnySoftwareDecodedMusic(),!n||a.IsPlayMusicAsSound()||d?new self.C3WebAudioBuffer(a,o,e,i,n,d):new self.C3Html5AudioBuffer(a,o,e,i,n)}CreateInstance(a){return this._api==="html5"?new self.C3Html5AudioInstance(this._audioDomHandler,this,a):new self.C3WebAudioInstance(this._audioDomHandler,this,a)}_Load(){}Load(){return this._loadPromise||(this._loadPromise=this._Load()),this._loadPromise}IsLoaded(){}IsLoadedAndDecoded(){}HasFailedToLoad(){return this._loadState==="failed"}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetApi(){return this._api}GetOriginalUrl(){return this._originalUrl}GetUrl(){return this._url}GetContentType(){return this._type}IsMusic(){return this._isMusic}GetDuration(){}};self.C3Html5AudioBuffer=class extends self.C3AudioBuffer{constructor(a,o,e,i,n){super(a,o,e,i,n),this._api="html5",this._audioElem=new Audio,this._audioElem.crossOrigin="anonymous",this._audioElem.autoplay=!1,this._audioElem.preload="auto",this._loadResolve=null,this._loadReject=null,this._reachedCanPlayThrough=!1,this._audioElem.addEventListener("canplaythrough",()=>this._reachedCanPlayThrough=!0),this._outNode=this.GetAudioContext().createGain(),this._mediaSourceNode=null,this._audioElem.addEventListener("canplay",()=>{this._loadResolve&&(this._loadState="loaded",this._loadResolve(),this._loadResolve=null,this._loadReject=null),!(this._mediaSourceNode||!this._audioElem)&&(this._mediaSourceNode=this.GetAudioContext().createMediaElementSource(this._audioElem),this._mediaSourceNode.connect(this._outNode))}),this.onended=null,this._audioElem.addEventListener("ended",()=>{this.onended&&this.onended()}),this._audioElem.addEventListener("error",d=>this._OnError(d))}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._outNode.disconnect(),this._outNode=null,this._mediaSourceNode.disconnect(),this._mediaSourceNode=null,this._audioElem&&!this._audioElem.paused&&this._audioElem.pause(),this.onended=null,this._audioElem=null,super.Release()}_Load(){return this._loadState="loading",new Promise((a,o)=>{this._loadResolve=a,this._loadReject=o,this._audioElem.src=this._url})}_OnError(a){console.error(`[Construct] Audio '${this._url}' error: `,a),this._loadReject&&(this._loadState="failed",this._loadReject(a),this._loadResolve=null,this._loadReject=null)}IsLoaded(){const a=this._audioElem.readyState>=4;return a&&(this._reachedCanPlayThrough=!0),a||this._reachedCanPlayThrough}IsLoadedAndDecoded(){return this.IsLoaded()}GetAudioElement(){return this._audioElem}GetOutputNode(){return this._outNode}GetDuration(){return this._audioElem.duration}};self.C3WebAudioBuffer=class extends self.C3AudioBuffer{constructor(a,o,e,i,n,d){super(a,o,e,i,n),this._api="webaudio",this._audioData=null,this._audioBuffer=null,this._needsSoftwareDecode=!!d}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._audioData=null,this._audioBuffer=null,super.Release()}async _Fetch(){if(this._audioData)return this._audioData;const a=this._audioDomHandler.GetRuntimeInterface();if(a.GetExportType()==="cordova"&&a.IsRelativeURL(this._url)&&a.IsFileProtocol())this._audioData=await a.CordovaFetchLocalFileAsArrayBuffer(this._url);else{const o=await fetch(this._url);if(!o.ok)throw new Error(`error fetching audio data: ${o.status} ${o.statusText}`);this._audioData=await o.arrayBuffer()}}async _Decode(){if(this._audioBuffer)return this._audioBuffer;this._audioBuffer=await this._audioDomHandler.DecodeAudioData(this._audioData,this._needsSoftwareDecode),this._audioData=null}async _Load(){try{this._loadState="loading",await this._Fetch(),await this._Decode(),this._loadState="loaded"}catch(a){this._loadState="failed",console.error(`[Construct] Failed to load audio '${this._url}': `,a)}}IsLoaded(){return!!(this._audioData||this._audioBuffer)}IsLoadedAndDecoded(){return!!this._audioBuffer}GetAudioBuffer(){return this._audioBuffer}GetDuration(){return this._audioBuffer?this._audioBuffer.duration:0}};{let m=0;self.C3AudioInstance=class{constructor(o,e,i){this._audioDomHandler=o,this._buffer=e,this._tag=i,this._aiId=m++,this._gainNode=this.GetAudioContext().createGain(),this._gainNode.connect(this.GetDestinationNode()),this._pannerNode=null,this._isPannerEnabled=!1,this._pannerPosition=[0,0,0],this._pannerOrientation=[0,0,0],this._isStopped=!0,this._isPaused=!1,this._resumeMe=!1,this._isLooping=!1,this._volume=1,this._isMuted=!1,this._playbackRate=1;const n=this._audioDomHandler.GetTimeScaleMode();this._isTimescaled=n===1&&!this.IsMusic()||n===2,this._instUid=-1,this._fadeEndTime=-1,this._stopOnFadeEnd=!1}Release(){this._audioDomHandler=null,this._buffer=null,this._pannerNode&&(this._pannerNode.disconnect(),this._pannerNode=null),this._gainNode.disconnect(),this._gainNode=null}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetDestinationNode(){return this._audioDomHandler.GetDestinationForTag(this._tag)}GetCurrentTime(){return this._isTimescaled?this._audioDomHandler.GetGameTime():performance.now()/1e3}GetOriginalUrl(){return this._buffer.GetOriginalUrl()}GetUrl(){return this._buffer.GetUrl()}GetContentType(){return this._buffer.GetContentType()}GetBuffer(){return this._buffer}IsMusic(){return this._buffer.IsMusic()}SetTag(o){this._tag=o}GetTag(){return this._tag}GetAiId(){return this._aiId}HasEnded(){}CanBeRecycled(){}IsPlaying(){return!this._isStopped&&!this._isPaused&&!this.HasEnded()}IsActive(){return!this._isStopped&&!this.HasEnded()}GetPlaybackTime(){}GetDuration(o){let e=this._buffer.GetDuration();return o&&(e/=this._playbackRate||.001),e}Play(o,e,i,n){}Stop(){}Pause(){}IsPaused(){return this._isPaused}Resume(){}SetVolume(o){this._volume=o,this._gainNode.gain.cancelScheduledValues(0),this._fadeEndTime=-1,this._gainNode.gain.value=this.GetOutputVolume()}FadeVolume(o,e,i){if(this.IsMuted())return;const n=this._gainNode.gain;n.cancelScheduledValues(0);const d=this._audioDomHandler.GetAudioCurrentTime(),c=d+e;n.setValueAtTime(n.value,d),n.linearRampToValueAtTime(o,c),this._volume=o,this._fadeEndTime=c,this._stopOnFadeEnd=i}_UpdateVolume(){this.SetVolume(this._volume)}Tick(o){this._fadeEndTime!==-1&&o>=this._fadeEndTime&&(this._fadeEndTime=-1,this._stopOnFadeEnd&&this.Stop(),this._audioDomHandler.PostTrigger("fade-ended",this._tag,this._aiId))}GetOutputVolume(){const o=this._volume;return isFinite(o)?o:0}SetMuted(o){o=!!o,this._isMuted!==o&&(this._isMuted=o,this._UpdateMuted())}IsMuted(){return this._isMuted}IsSilent(){return this._audioDomHandler.IsSilent()}_UpdateMuted(){}SetLooping(o){}IsLooping(){return this._isLooping}SetPlaybackRate(o){this._playbackRate!==o&&(this._playbackRate=o,this._UpdatePlaybackRate())}_UpdatePlaybackRate(){}GetPlaybackRate(){return this._playbackRate}Seek(o){}SetSuspended(o){}SetPannerEnabled(o){o=!!o,this._isPannerEnabled!==o&&(this._isPannerEnabled=o,this._isPannerEnabled?(this._pannerNode||(this._pannerNode=this.GetAudioContext().createPanner(),this._pannerNode.panningModel=this._audioDomHandler.GetPanningModel(),this._pannerNode.distanceModel=this._audioDomHandler.GetDistanceModel(),this._pannerNode.refDistance=this._audioDomHandler.GetReferenceDistance(),this._pannerNode.maxDistance=this._audioDomHandler.GetMaxDistance(),this._pannerNode.rolloffFactor=this._audioDomHandler.GetRolloffFactor()),this._gainNode.disconnect(),this._gainNode.connect(this._pannerNode),this._pannerNode.connect(this.GetDestinationNode())):(this._pannerNode.disconnect(),this._gainNode.disconnect(),this._gainNode.connect(this.GetDestinationNode())))}SetPan(o,e,i,n,d,c){if(!this._isPannerEnabled)return;this.SetPanXYA(o,e,i);const _=self.AudioDOMHandler.ToDegrees;this._pannerNode.coneInnerAngle=_(n),this._pannerNode.coneOuterAngle=_(d),this._pannerNode.coneOuterGain=c}SetPanXYA(o,e,i){this._isPannerEnabled&&(this._pannerPosition[0]=o,this._pannerPosition[1]=e,this._pannerPosition[2]=0,this._pannerOrientation[0]=Math.cos(i),this._pannerOrientation[1]=Math.sin(i),this._pannerOrientation[2]=0,this._pannerNode.setPosition(...this._pannerPosition),this._pannerNode.setOrientation(...this._pannerOrientation))}SetUID(o){this._instUid=o}GetUID(){return this._instUid}GetResumePosition(){}Reconnect(o){const e=this._pannerNode||this._gainNode;e.disconnect(),e.connect(o)}GetState(){return{aiid:this.GetAiId(),tag:this._tag,duration:this.GetDuration(),volume:this._volume,isPlaying:this.IsPlaying(),playbackTime:this.GetPlaybackTime(),playbackRate:this.GetPlaybackRate(),uid:this._instUid,bufferOriginalUrl:this.GetOriginalUrl(),bufferUrl:"",bufferType:this.GetContentType(),isMusic:this.IsMusic(),isLooping:this.IsLooping(),isMuted:this.IsMuted(),resumePosition:this.GetResumePosition(),pan:this.GetPanState()}}_LoadAdditionalState(o){this.SetPlaybackRate(o.playbackRate),this.SetMuted(o.isMuted)}GetPanState(){if(!this._pannerNode)return null;const o=this._pannerNode;return{pos:this._pannerPosition,orient:this._pannerOrientation,cia:o.coneInnerAngle,coa:o.coneOuterAngle,cog:o.coneOuterGain,uid:this._instUid}}LoadPanState(o){if(!o){this.SetPannerEnabled(!1);return}this.SetPannerEnabled(!0);const e=this._pannerNode,i=e.pos;this._pannerPosition[0]=i[0],this._pannerPosition[1]=i[1],this._pannerPosition[2]=i[2];const n=e.orient;this._pannerOrientation[0]=n[0],this._pannerOrientation[1]=n[1],this._pannerOrientation[2]=n[2],e.setPosition(...this._pannerPosition),e.setOrientation(...this._pannerOrientation),e.coneInnerAngle=e.cia,e.coneOuterAngle=e.coa,e.coneOuterGain=e.cog,this._instUid=e.uid}}}self.C3Html5AudioInstance=class extends self.C3AudioInstance{constructor(a,o,e){super(a,o,e),this._buffer.GetOutputNode().connect(this._gainNode),this._buffer.onended=()=>this._OnEnded()}Release(){this.Stop(),this._buffer.GetOutputNode().disconnect(),super.Release()}GetAudioElement(){return this._buffer.GetAudioElement()}_OnEnded(){this._isStopped=!0,this._instUid=-1,this._audioDomHandler.PostTrigger("ended",this._tag,this._aiId)}HasEnded(){return this.GetAudioElement().ended}CanBeRecycled(){return this._isStopped?!0:this.HasEnded()}GetPlaybackTime(){let a=this.GetAudioElement().currentTime;return this._isLooping||(a=Math.min(a,this.GetDuration())),a}Play(a,o,e,i){const n=this.GetAudioElement();if(n.playbackRate!==1&&(n.playbackRate=1),n.loop!==a&&(n.loop=a),this.SetVolume(o),n.muted&&(n.muted=!1),n.currentTime!==e)try{n.currentTime=e}catch(d){console.warn(`[Construct] Exception seeking audio '${this._buffer.GetUrl()}' to position '${e}': `,d)}this._audioDomHandler.TryPlayMedia(n),this._isStopped=!1,this._isPaused=!1,this._isLooping=a,this._playbackRate=1}Stop(){const a=this.GetAudioElement();a.paused||a.pause(),this._audioDomHandler.RemovePendingPlay(a),this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){if(this._isPaused||this._isStopped||this.HasEnded())return;const a=this.GetAudioElement();a.paused||a.pause(),this._audioDomHandler.RemovePendingPlay(a),this._isPaused=!0}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._isPaused=!1)}_UpdateMuted(){this.GetAudioElement().muted=this._isMuted||this.IsSilent()}SetLooping(a){a=!!a,this._isLooping!==a&&(this._isLooping=a,this.GetAudioElement().loop=a)}_UpdatePlaybackRate(){let a=this._playbackRate;this._isTimescaled&&(a*=this._audioDomHandler.GetTimeScale());try{this.GetAudioElement().playbackRate=a}catch(o){console.warn(`[Construct] Unable to set playback rate '${a}':`,o)}}Seek(a){if(!(this._isStopped||this.HasEnded()))try{this.GetAudioElement().currentTime=a}catch(o){console.warn(`[Construct] Error seeking audio to '${a}': `,o)}}GetResumePosition(){return this.GetPlaybackTime()}SetSuspended(a){a?this.IsPlaying()?(this.GetAudioElement().pause(),this._resumeMe=!0):this._resumeMe=!1:this._resumeMe&&(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._resumeMe=!1)}};self.C3WebAudioInstance=class extends self.C3AudioInstance{constructor(a,o,e){super(a,o,e),this._bufferSource=null,this._onended_handler=i=>this._OnEnded(i),this._hasPlaybackEnded=!0,this._activeSource=null,this._playStartTime=0,this._playFromSeekPos=0,this._resumePosition=0,this._muteVol=1}Release(){this.Stop(),this._ReleaseBufferSource(),this._onended_handler=null,super.Release()}_ReleaseBufferSource(){this._bufferSource&&this._bufferSource.disconnect(),this._bufferSource=null,this._activeSource=null}_OnEnded(a){this._isPaused||this._resumeMe||a.target===this._activeSource&&(this._hasPlaybackEnded=!0,this._isStopped=!0,this._instUid=-1,this._ReleaseBufferSource(),this._audioDomHandler.PostTrigger("ended",this._tag,this._aiId))}HasEnded(){return!this._isStopped&&this._bufferSource&&this._bufferSource.loop||this._isPaused?!1:this._hasPlaybackEnded}CanBeRecycled(){return!this._bufferSource||this._isStopped?!0:this.HasEnded()}GetPlaybackTime(){let a=0;return this._isPaused?a=this._resumePosition:a=this._playFromSeekPos+(this.GetCurrentTime()-this._playStartTime)*this._playbackRate,this._isLooping||(a=Math.min(a,this.GetDuration())),a}Play(a,o,e,i){this._muteVol=1,this.SetVolume(o),this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=a,this._bufferSource.start(i,e),this._hasPlaybackEnded=!1,this._isStopped=!1,this._isPaused=!1,this._isLooping=a,this._playbackRate=1,this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=e}Stop(){if(this._bufferSource)try{this._bufferSource.stop(0)}catch{}this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){this._isPaused||this._isStopped||this.HasEnded()||(this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._isPaused=!0,this._bufferSource.stop(0))}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,this._isPaused=!1)}GetOutputVolume(){return super.GetOutputVolume()*this._muteVol}_UpdateMuted(){this._muteVol=this._isMuted||this.IsSilent()?0:1,this._UpdateVolume()}SetLooping(a){a=!!a,this._isLooping!==a&&(this._isLooping=a,this._bufferSource&&(this._bufferSource.loop=a))}_UpdatePlaybackRate(){let a=this._playbackRate;this._isTimescaled&&(a*=this._audioDomHandler.GetTimeScale()),this._bufferSource&&(this._bufferSource.playbackRate.value=a)}Seek(a){this._isStopped||this.HasEnded()||(this._isPaused?this._resumePosition=a:(this.Pause(),this._resumePosition=a,this.Resume()))}GetResumePosition(){return this._resumePosition}SetSuspended(a){a?this.IsPlaying()?(this._resumeMe=!0,this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._bufferSource.stop(0)):this._resumeMe=!1:this._resumeMe&&(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,this._resumeMe=!1)}_LoadAdditionalState(a){super._LoadAdditionalState(a),this._resumePosition=a.resumePosition}};{class m{constructor(o){this._audioDomHandler=o,this._audioContext=o.GetAudioContext(),this._index=-1,this._tag="",this._type="",this._params=null}Release(){this._audioContext=null}_SetIndex(o){this._index=o}GetIndex(){return this._index}_SetTag(o){this._tag=o}GetTag(){return this._tag}CreateGain(){return this._audioContext.createGain()}GetInputNode(){}ConnectTo(o){}SetAudioParam(o,e,i,n){if(o.cancelScheduledValues(0),n===0){o.value=e;return}const d=this._audioContext.currentTime;switch(n+=d,i){case 0:o.setValueAtTime(e,n);break;case 1:o.setValueAtTime(o.value,d),o.linearRampToValueAtTime(e,n);break;case 2:o.setValueAtTime(o.value,d),o.exponentialRampToValueAtTime(e,n);break}}GetState(){return{type:this._type,tag:this._tag,params:this._params}}}self.C3AudioFilterFX=class extends m{constructor(o,e,i,n,d,c,_){super(o),this._type="filter",this._params=[e,i,n,d,c,_],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=_,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-_,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type=e,this._filterNode.frequency.value=i,this._filterNode.detune.value=n,this._filterNode.Q.value=d,this._filterNode.gain.vlaue=c,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._filterNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(o){this._wetNode.disconnect(),this._wetNode.connect(o),this._dryNode.disconnect(),this._dryNode.connect(o)}GetInputNode(){return this._inputNode}SetParam(o,e,i,n){switch(o){case 0:e=Math.max(Math.min(e/100,1),0),this._params[5]=e,this.SetAudioParam(this._wetNode.gain,e,i,n),this.SetAudioParam(this._dryNode.gain,1-e,i,n);break;case 1:this._params[1]=e,this.SetAudioParam(this._filterNode.frequency,e,i,n);break;case 2:this._params[2]=e,this.SetAudioParam(this._filterNode.detune,e,i,n);break;case 3:this._params[3]=e,this.SetAudioParam(this._filterNode.Q,e,i,n);break;case 4:this._params[4]=e,this.SetAudioParam(this._filterNode.gain,e,i,n);break}}},self.C3AudioDelayFX=class extends m{constructor(o,e,i,n){super(o),this._type="delay",this._params=[e,i,n],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=n,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-n,this._mainNode=this.CreateGain(),this._delayNode=this._audioContext.createDelay(e),this._delayNode.delayTime.value=e,this._delayGainNode=this.CreateGain(),this._delayGainNode.gain.value=i,this._inputNode.connect(this._mainNode),this._inputNode.connect(this._dryNode),this._mainNode.connect(this._wetNode),this._mainNode.connect(this._delayNode),this._delayNode.connect(this._delayGainNode),this._delayGainNode.connect(this._mainNode)}Release(){this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),this._mainNode.disconnect(),this._delayNode.disconnect(),this._delayGainNode.disconnect(),super.Release()}ConnectTo(o){this._wetNode.disconnect(),this._wetNode.connect(o),this._dryNode.disconnect(),this._dryNode.connect(o)}GetInputNode(){return this._inputNode}SetParam(o,e,i,n){const d=self.AudioDOMHandler.DbToLinear;switch(o){case 0:e=Math.max(Math.min(e/100,1),0),this._params[2]=e,this.SetAudioParam(this._wetNode.gain,e,i,n),this.SetAudioParam(this._dryNode.gain,1-e,i,n);break;case 4:this._params[1]=d(e),this.SetAudioParam(this._delayGainNode.gain,d(e),i,n);break;case 5:this._params[0]=e,this.SetAudioParam(this._delayNode.delayTime,e,i,n);break}}},self.C3AudioConvolveFX=class extends m{constructor(o,e,i,n){super(o),this._type="convolution",this._params=[i,n],this._bufferOriginalUrl="",this._bufferUrl="",this._bufferType="",this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=n,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-n,this._convolveNode=this._audioContext.createConvolver(),this._convolveNode.normalize=i,this._convolveNode.buffer=e,this._inputNode.connect(this._convolveNode),this._inputNode.connect(this._dryNode),this._convolveNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._convolveNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(o){this._wetNode.disconnect(),this._wetNode.connect(o),this._dryNode.disconnect(),this._dryNode.connect(o)}GetInputNode(){return this._inputNode}SetParam(o,e,i,n){switch(o){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._wetNode.gain,e,i,n),this.SetAudioParam(this._dryNode.gain,1-e,i,n);break}}_SetBufferInfo(o,e,i){this._bufferOriginalUrl=o,this._bufferUrl=e,this._bufferType=i}GetState(){const o=super.GetState();return o.bufferOriginalUrl=this._bufferOriginalUrl,o.bufferUrl="",o.bufferType=this._bufferType,o}},self.C3AudioFlangerFX=class extends m{constructor(o,e,i,n,d,c){super(o),this._type="flanger",this._params=[e,i,n,d,c],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-c/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=c/2,this._feedbackNode=this.CreateGain(),this._feedbackNode.gain.value=d,this._delayNode=this._audioContext.createDelay(e+i),this._delayNode.delayTime.value=e,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=n,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=i,this._inputNode.connect(this._delayNode),this._inputNode.connect(this._dryNode),this._delayNode.connect(this._wetNode),this._delayNode.connect(this._feedbackNode),this._feedbackNode.connect(this._delayNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._delayNode.delayTime),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._delayNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),this._feedbackNode.disconnect(),super.Release()}ConnectTo(o){this._wetNode.disconnect(),this._wetNode.connect(o),this._dryNode.disconnect(),this._dryNode.connect(o)}GetInputNode(){return this._inputNode}SetParam(o,e,i,n){switch(o){case 0:e=Math.max(Math.min(e/100,1),0),this._params[4]=e,this.SetAudioParam(this._wetNode.gain,e/2,i,n),this.SetAudioParam(this._dryNode.gain,1-e/2,i,n);break;case 6:this._params[1]=e/1e3,this.SetAudioParam(this._oscGainNode.gain,e/1e3,i,n);break;case 7:this._params[2]=e,this.SetAudioParam(this._oscNode.frequency,e,i,n);break;case 8:this._params[3]=e/100,this.SetAudioParam(this._feedbackNode.gain,e/100,i,n);break}}},self.C3AudioPhaserFX=class extends m{constructor(o,e,i,n,d,c,_){super(o),this._type="phaser",this._params=[e,i,n,d,c,_],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-_/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=_/2,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type="allpass",this._filterNode.frequency.value=e,this._filterNode.detune.value=i,this._filterNode.Q.value=n,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=c,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=d,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._filterNode.frequency),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._filterNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),super.Release()}ConnectTo(o){this._wetNode.disconnect(),this._wetNode.connect(o),this._dryNode.disconnect(),this._dryNode.connect(o)}GetInputNode(){return this._inputNode}SetParam(o,e,i,n){switch(o){case 0:e=Math.max(Math.min(e/100,1),0),this._params[5]=e,this.SetAudioParam(this._wetNode.gain,e/2,i,n),this.SetAudioParam(this._dryNode.gain,1-e/2,i,n);break;case 1:this._params[0]=e,this.SetAudioParam(this._filterNode.frequency,e,i,n);break;case 2:this._params[1]=e,this.SetAudioParam(this._filterNode.detune,e,i,n);break;case 3:this._params[2]=e,this.SetAudioParam(this._filterNode.Q,e,i,n);break;case 6:this._params[3]=e,this.SetAudioParam(this._oscGainNode.gain,e,i,n);break;case 7:this._params[4]=e,this.SetAudioParam(this._oscNode.frequency,e,i,n);break}}},self.C3AudioGainFX=class extends m{constructor(o,e){super(o),this._type="gain",this._params=[e],this._node=this.CreateGain(),this._node.gain.value=e}Release(){this._node.disconnect(),super.Release()}ConnectTo(o){this._node.disconnect(),this._node.connect(o)}GetInputNode(){return this._node}SetParam(o,e,i,n){const d=self.AudioDOMHandler.DbToLinear;switch(o){case 4:this._params[0]=d(e),this.SetAudioParam(this._node.gain,d(e),i,n);break}}},self.C3AudioTremoloFX=class extends m{constructor(o,e,i){super(o),this._type="tremolo",this._params=[e,i],this._node=this.CreateGain(),this._node.gain.value=1-i/2,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=e,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=i/2,this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._node.gain),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._node.disconnect(),super.Release()}ConnectTo(o){this._node.disconnect(),this._node.connect(o)}GetInputNode(){return this._node}SetParam(o,e,i,n){switch(o){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._node.gain,1-e/2,i,n),this.SetAudioParam(this._oscGainNode.gain,e/2,i,n);break;case 7:this._params[0]=e,this.SetAudioParam(this._oscNode.frequency,e,i,n);break}}},self.C3AudioRingModFX=class extends m{constructor(o,e,i){super(o),this._type="ringmod",this._params=[e,i],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=i,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-i,this._ringNode=this.CreateGain(),this._ringNode.gain.value=0,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=e,this._oscNode.connect(this._ringNode.gain),this._oscNode.start(0),this._inputNode.connect(this._ringNode),this._inputNode.connect(this._dryNode),this._ringNode.connect(this._wetNode)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._ringNode.disconnect(),this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(o){this._wetNode.disconnect(),this._wetNode.connect(o),this._dryNode.disconnect(),this._dryNode.connect(o)}GetInputNode(){return this._inputNode}SetParam(o,e,i,n){switch(o){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._wetNode.gain,e,i,n),this.SetAudioParam(this._dryNode.gain,1-e,i,n);break;case 7:this._params[0]=e,this.SetAudioParam(this._oscNode.frequency,e,i,n);break}}},self.C3AudioDistortionFX=class extends m{constructor(o,e,i,n,d,c){super(o),this._type="distortion",this._params=[e,i,n,d,c],this._inputNode=this.CreateGain(),this._preGain=this.CreateGain(),this._postGain=this.CreateGain(),this._SetDrive(n,d),this._wetNode=this.CreateGain(),this._wetNode.gain.value=c,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-c,this._waveShaper=this._audioContext.createWaveShaper(),this._curve=new Float32Array(65536),this._GenerateColortouchCurve(e,i),this._waveShaper.curve=this._curve,this._inputNode.connect(this._preGain),this._inputNode.connect(this._dryNode),this._preGain.connect(this._waveShaper),this._waveShaper.connect(this._postGain),this._postGain.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._preGain.disconnect(),this._waveShaper.disconnect(),this._postGain.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}_SetDrive(o,e){o<.01&&(o=.01),this._preGain.gain.value=o,this._postGain.gain.value=Math.pow(1/o,.6)*e}_GenerateColortouchCurve(o,e){for(let d=0;d<32768;++d){let c=d/32768;c=this._Shape(c,o,e),this._curve[32768+d]=c,this._curve[32768-d-1]=-c}}_Shape(o,e,i){const d=1.05*i*e-e,c=o<0?-1:1,_=o<0?-o:o;let y=_<e?_:e+d*self.AudioDOMHandler.e4(_-e,1/d);return y*=c,y}ConnectTo(o){this._wetNode.disconnect(),this._wetNode.connect(o),this._dryNode.disconnect(),this._dryNode.connect(o)}GetInputNode(){return this._inputNode}SetParam(o,e,i,n){switch(o){case 0:e=Math.max(Math.min(e/100,1),0),this._params[4]=e,this.SetAudioParam(this._wetNode.gain,e,i,n),this.SetAudioParam(this._dryNode.gain,1-e,i,n);break}}},self.C3AudioCompressorFX=class extends m{constructor(o,e,i,n,d,c){super(o),this._type="compressor",this._params=[e,i,n,d,c],this._node=this._audioContext.createDynamicsCompressor(),this._node.threshold.value=e,this._node.knee.value=i,this._node.ratio.value=n,this._node.attack.value=d,this._node.release.value=c}Release(){this._node.disconnect(),super.Release()}ConnectTo(o){this._node.disconnect(),this._node.connect(o)}GetInputNode(){return this._node}SetParam(o,e,i,n){}},self.C3AudioAnalyserFX=class extends m{constructor(o,e,i){super(o),this._type="analyser",this._params=[e,i],this._node=this._audioContext.createAnalyser(),this._node.fftSize=e,this._node.smoothingTimeConstant=i,this._freqBins=new Float32Array(this._node.frequencyBinCount),this._signal=new Uint8Array(e),this._peak=0,this._rms=0,this._audioDomHandler._AddAnalyser(this)}Release(){this._audioDomHandler._RemoveAnalyser(this),this._node.disconnect(),super.Release()}Tick(){this._node.getFloatFrequencyData(this._freqBins),this._node.getByteTimeDomainData(this._signal);const o=this._node.fftSize;this._peak=0;let e=0;for(let n=0;n<o;++n){let d=(this._signal[n]-128)/128;d<0&&(d=-d),this._peak<d&&(this._peak=d),e+=d*d}const i=self.AudioDOMHandler.LinearToDb;this._peak=i(this._peak),this._rms=i(Math.sqrt(e/o))}ConnectTo(o){this._node.disconnect(),this._node.connect(o)}GetInputNode(){return this._node}SetParam(o,e,i,n){}GetData(){return{tag:this.GetTag(),index:this.GetIndex(),peak:this._peak,rms:this._rms,binCount:this._node.frequencyBinCount,freqBins:this._freqBins}}}}{const m="touch",a=class extends self.DOMHandler{constructor(e){super(e,m),this.AddRuntimeMessageHandler("request-permission",i=>this._OnRequestPermission(i))}async _OnRequestPermission(e){const i=e.type;let n=!0;i===0?n=await this._RequestOrientationPermission():i===1&&(n=await this._RequestMotionPermission()),this.PostToRuntime("permission-result",{type:i,result:n})}async _RequestOrientationPermission(){if(!self.DeviceOrientationEvent||!self.DeviceOrientationEvent.requestPermission)return!0;try{return await self.DeviceOrientationEvent.requestPermission()==="granted"}catch(e){return console.warn("[Touch] Failed to request orientation permission: ",e),!1}}async _RequestMotionPermission(){if(!self.DeviceMotionEvent||!self.DeviceMotionEvent.requestPermission)return!0;try{return await self.DeviceMotionEvent.requestPermission()==="granted"}catch(e){return console.warn("[Touch] Failed to request motion permission: ",e),!1}}};self.RuntimeInterface.AddDOMHandlerClass(a)}{const m="browser",a=class extends self.DOMHandler{constructor(e){super(e,m),this._exportType="",this.AddRuntimeMessageHandlers([["get-initial-state",i=>this._OnGetInitialState(i)],["ready-for-sw-messages",()=>this._OnReadyForSWMessages()],["alert",i=>this._OnAlert(i)],["close",()=>this._OnClose()],["set-focus",i=>this._OnSetFocus(i)],["vibrate",i=>this._OnVibrate(i)],["lock-orientation",i=>this._OnLockOrientation(i)],["unlock-orientation",()=>this._OnUnlockOrientation()],["navigate",i=>this._OnNavigate(i)],["request-fullscreen",i=>this._OnRequestFullscreen(i)],["exit-fullscreen",()=>this._OnExitFullscreen()],["set-hash",i=>this._OnSetHash(i)]]),window.addEventListener("online",()=>this._OnOnlineStateChanged(!0)),window.addEventListener("offline",()=>this._OnOnlineStateChanged(!1)),window.addEventListener("hashchange",()=>this._OnHashChange()),document.addEventListener("backbutton",()=>this._OnCordovaBackButton())}_OnGetInitialState(e){return this._exportType=e.exportType,{location:location.toString(),isOnline:!!navigator.onLine,referrer:document.referrer,title:document.title,isCookieEnabled:!!navigator.cookieEnabled,screenWidth:screen.width,screenHeight:screen.height,windowOuterWidth:window.outerWidth,windowOuterHeight:window.outerHeight,isConstructArcade:typeof window.is_scirra_arcade<"u"}}_OnReadyForSWMessages(){!window.C3_RegisterSW||!window.OfflineClientInfo||window.OfflineClientInfo.SetMessageCallback(e=>this.PostToRuntime("sw-message",e.data))}_OnOnlineStateChanged(e){this.PostToRuntime("online-state",{isOnline:e})}_OnCordovaBackButton(){this.PostToRuntime("backbutton")}GetNWjsWindow(){return this._exportType==="nwjs"?nw.Window.get():null}_OnAlert(e){alert(e.message)}_OnClose(){navigator.app&&navigator.app.exitApp?navigator.app.exitApp():navigator.device&&navigator.device.exitApp?navigator.device.exitApp():window.close()}_OnSetFocus(e){const i=e.isFocus;if(this._exportType==="nwjs"){const n=this.GetNWjsWindow();i?n.focus():n.blur()}else i?window.focus():window.blur()}_OnVibrate(e){navigator.vibrate&&navigator.vibrate(e.pattern)}_OnLockOrientation(e){const i=e.orientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(i).catch(n=>console.warn("[Construct] Failed to lock orientation: ",n));else try{let n=!1;screen.lockOrientation?n=screen.lockOrientation(i):screen.webkitLockOrientation?n=screen.webkitLockOrientation(i):screen.mozLockOrientation?n=screen.mozLockOrientation(i):screen.msLockOrientation&&(n=screen.msLockOrientation(i)),n||console.warn("[Construct] Failed to lock orientation")}catch(n){console.warn("[Construct] Failed to lock orientation: ",n)}}_OnUnlockOrientation(){try{screen.orientation&&screen.orientation.unlock?screen.orientation.unlock():screen.unlockOrientation?screen.unlockOrientation():screen.webkitUnlockOrientation?screen.webkitUnlockOrientation():screen.mozUnlockOrientation?screen.mozUnlockOrientation():screen.msUnlockOrientation&&screen.msUnlockOrientation()}catch{}}_OnNavigate(e){const i=e.type;if(i==="back")navigator.app&&navigator.app.backHistory?navigator.app.backHistory():window.history.back();else if(i==="forward")window.history.forward();else if(i==="reload")location.reload();else if(i==="url"){const n=e.url,d=e.target,c=e.exportType;self.cordova&&self.cordova.InAppBrowser?self.cordova.InAppBrowser.open(n,"_system"):c==="preview"||c==="windows-webview2"?window.open(n,"_blank"):this._isConstructArcade||(d===2?window.top.location=n:d===1?window.parent.location=n:window.location=n)}else if(i==="new-window"){const n=e.url,d=e.tag;self.cordova&&self.cordova.InAppBrowser?self.cordova.InAppBrowser.open(n,"_system"):window.open(n,d)}}_OnRequestFullscreen(e){if(this._exportType==="windows-webview2"||this._exportType==="macos-wkwebview")self.RuntimeInterface._SetWrapperIsFullscreenFlag(!0),this._iRuntime._SendWrapperMessage({type:"set-fullscreen",fullscreen:!0});else{const i={navigationUI:"auto"},n=e.navUI;n===1?i.navigationUI="hide":n===2&&(i.navigationUI="show");const d=document.documentElement;d.requestFullscreen?d.requestFullscreen(i):d.mozRequestFullScreen?d.mozRequestFullScreen(i):d.msRequestFullscreen?d.msRequestFullscreen(i):d.webkitRequestFullScreen&&(typeof Element.ALLOW_KEYBOARD_INPUT<"u"?d.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):d.webkitRequestFullScreen())}}_OnExitFullscreen(){this._exportType==="windows-webview2"||this._exportType==="macos-wkwebview"?(self.RuntimeInterface._SetWrapperIsFullscreenFlag(!1),this._iRuntime._SendWrapperMessage({type:"set-fullscreen",fullscreen:!1})):document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen?document.msExitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()}_OnSetHash(e){location.hash=e.hash}_OnHashChange(){this.PostToRuntime("hashchange",{location:location.toString()})}};self.RuntimeInterface.AddDOMHandlerClass(a)}window.C3_RegisterSW=async function(){if(navigator.serviceWorker)try{const a=await navigator.serviceWorker.register("sw.js",{scope:"./"});console.info("Registered service worker on "+a.scope)}catch(a){console.warn("Failed to register service worker: ",a)}};
