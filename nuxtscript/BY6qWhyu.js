import"./B5Qt9EMX.js";window.DOMHandler=class{constructor(t,e){this._iRuntime=t,this._componentId=e,this._hasTickCallback=!1,this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(t,e,i,s){this._iRuntime.PostToRuntimeComponent(this._componentId,t,e,i,s)}PostToRuntimeAsync(t,e,i,s){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,t,e,i,s)}_PostToRuntimeMaybeSync(t,e,i){this._iRuntime.UsesWorker()?this.PostToRuntime(t,e,i):this._iRuntime._GetLocalRuntime()._OnMessageFromDOM({type:"event",component:this._componentId,handler:t,dispatchOpts:i||null,data:e,responseId:null})}AddRuntimeMessageHandler(t,e){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,t,e)}AddRuntimeMessageHandlers(t){for(const[e,i]of t)this.AddRuntimeMessageHandler(e,i)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}};window.RateLimiter=class{constructor(t,e){this._callback=t,this._interval=e,this._timerId=-1,this._lastCallTime=-1/0,this._timerCallFunc=()=>this._OnTimer(),this._canRunImmediate=this._ignoreReset=!1}SetCanRunImmediate(t){this._canRunImmediate=!!t}Call(){if(this._timerId===-1){var t=Date.now(),e=t-this._lastCallTime,i=this._interval;e>=i&&this._canRunImmediate?(this._lastCallTime=t,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(i-e,4))}}_RunCallback(){this._ignoreReset=!0,this._callback(),this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._lastCallTime=Date.now())}_OnTimer(){this._timerId=-1,this._lastCallTime=Date.now(),this._RunCallback()}_CancelTimer(){this._timerId!==-1&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer(),this._timerCallFunc=this._callback=null}};class B{constructor(e){this._elem=e,this._hadFirstUpdate=!1,this._isVisibleFlag=!0,this._htmlZIndex=this._actualHtmlIndex=this._wantHtmlIndex=-1}SetVisibleFlag(e){this._isVisibleFlag=!!e}GetVisibleFlag(){return this._isVisibleFlag}HadFirstUpdate(){return this._hadFirstUpdate}SetHadFirstUpdate(){this._hadFirstUpdate=!0}GetWantHTMLIndex(){return this._wantHtmlIndex}SetWantHTMLIndex(e){this._wantHtmlIndex=e}GetActualHTMLIndex(){return this._actualHtmlIndex}SetActualHTMLIndex(e){this._actualHtmlIndex=e}SetHTMLZIndex(e){this._htmlZIndex=e}GetHTMLZIndex(){return this._htmlZIndex}GetElement(){return this._elem}}window.DOMElementHandler=class extends self.DOMHandler{constructor(t,e){super(t,e),this._elementMap=new Map,this._autoAttach=!0,this.AddRuntimeMessageHandlers([["create",i=>this._OnCreate(i)],["destroy",i=>this._OnDestroy(i)],["set-visible",i=>this._OnSetVisible(i)],["update-position",i=>this._OnUpdatePosition(i)],["update-state",i=>this._OnUpdateState(i)],["focus",i=>this._OnSetFocus(i)],["set-css-style",i=>this._OnSetCssStyle(i)],["set-attribute",i=>this._OnSetAttribute(i)],["remove-attribute",i=>this._OnRemoveAttribute(i)]]),this.AddDOMElementMessageHandler("get-element",i=>i)}SetAutoAttach(t){this._autoAttach=!!t}AddDOMElementMessageHandler(t,e){this.AddRuntimeMessageHandler(t,i=>{const s=this.GetElementById(i.elementId);return e(s,i)})}_OnCreate(t){const e=t.elementId,i=this.CreateElement(e,t),s=new B(i);this._elementMap.set(e,s),i.style.boxSizing="border-box",i.style.display="none",s.SetVisibleFlag(t.isVisible);var n=this._GetFocusElement(i);n.addEventListener("focus",o=>this._OnFocus(e)),n.addEventListener("blur",o=>this._OnBlur(e)),n=t.htmlIndex,s.SetWantHTMLIndex(n),s.SetHTMLZIndex(t.htmlZIndex),this._autoAttach&&(t=this.GetRuntimeInterface().GetAvailableHTMLIndex(n),s.SetActualHTMLIndex(t),this.GetRuntimeInterface().GetHTMLWrapElement(t).appendChild(i))}CreateElement(t,e){throw Error("required override")}DestroyElement(t){}_OnDestroy(t){t=t.elementId;const e=this.GetElementById(t);this.DestroyElement(e),this._autoAttach&&e.parentElement.removeChild(e),this._elementMap.delete(t)}PostToRuntimeElement(t,e,i){i||(i={}),i.elementId=e,this.PostToRuntime(t,i)}_PostToRuntimeElementMaybeSync(t,e,i){i||(i={}),i.elementId=e,this._PostToRuntimeMaybeSync(t,i)}_OnSetVisible(t){if(this._autoAttach){var e=this._elementMap.get(t.elementId),i=e.GetElement();e.HadFirstUpdate()?i.style.display=t.isVisible?"":"none":e.SetVisibleFlag(t.isVisible)}}_OnUpdatePosition(t){if(this._autoAttach){var e=this._elementMap.get(t.elementId),i=e.GetElement(),s=this.GetRuntimeInterface();i.style.left=t.left+"px",i.style.top=t.top+"px",i.style.width=t.width+"px",i.style.height=t.height+"px";var n=t.fontSize;n!==null&&(i.style.fontSize=n+"em"),n=t.htmlIndex,e.SetWantHTMLIndex(n),n=s.GetAvailableHTMLIndex(n),n!==e.GetActualHTMLIndex()&&(i.remove(),s.GetHTMLWrapElement(n).appendChild(i),e.SetActualHTMLIndex(n),s._UpdateHTMLElementsZOrder()),t=t.htmlZIndex,t!==e.GetHTMLZIndex()&&(e.SetHTMLZIndex(t),s._UpdateHTMLElementsZOrder()),e.HadFirstUpdate()||(e.SetHadFirstUpdate(),e.GetVisibleFlag()&&(i.style.display=""))}}_OnHTMLLayersChanged(){if(this._autoAttach)for(const e of this._elementMap.values()){const i=this.GetRuntimeInterface().GetAvailableHTMLIndex(e.GetWantHTMLIndex());var t=e.GetActualHTMLIndex();i!==-1&&t!==-1&&i!==t&&(t=e.GetElement(),t.remove(),this.GetRuntimeInterface().GetHTMLWrapElement(i).appendChild(t),e.SetActualHTMLIndex(i))}}_GetAllElementStatesForZOrderUpdate(){return this._autoAttach?[...this._elementMap.values()]:null}_OnUpdateState(t){const e=this.GetElementById(t.elementId);this.UpdateState(e,t)}UpdateState(t,e){throw Error("required override")}_GetFocusElement(t){return t}_OnFocus(t){this.PostToRuntimeElement("elem-focused",t)}_OnBlur(t){this.PostToRuntimeElement("elem-blurred",t)}_OnSetFocus(t){const e=this._GetFocusElement(this.GetElementById(t.elementId));t.focus?e.focus():e.blur()}_OnSetCssStyle(t){const e=this.GetElementById(t.elementId),i=t.prop;t=t.val,i.startsWith("--")?e.style.setProperty(i,t):e.style[i]=t}_OnSetAttribute(t){this.GetElementById(t.elementId).setAttribute(t.name,t.val)}_OnRemoveAttribute(t){this.GetElementById(t.elementId).removeAttribute(t.name)}GetElementById(t){const e=this._elementMap.get(t);if(!e)throw Error(`no element with id ${t}`);return e.GetElement()}};const k=/(iphone|ipod|ipad|macos|macintosh|mac os x)/i.test(navigator.userAgent),C=/android/i.test(navigator.userAgent),V=/safari/i.test(navigator.userAgent)&&!/(chrome|chromium|edg\/|OPR\/|nwjs)/i.test(navigator.userAgent);let x=0;function P(t){const e=document.createElement("script");return e.async=!1,e.type="module",t.isStringSrc?new Promise(i=>{const s="c3_resolve_"+x;++x,self[s]=i,e.textContent=t.str+`

self["${s}"]();`,document.head.appendChild(e)}):new Promise((i,s)=>{e.onload=i,e.onerror=s,e.src=t,document.head.appendChild(e)})}async function j(){if(!navigator.userActivation||typeof OffscreenCanvas>"u")return!1;try{let t=!1;const e=new Blob([`
	self.addEventListener("message", () =>
	{
		try {
			const offscreenCanvas = new OffscreenCanvas(32, 32);
			const gl = offscreenCanvas.getContext("webgl");
			self.postMessage(!!gl);
		}
		catch (err)
		{
			console.warn("Feature detection worker error:", err);
			self.postMessage(false);
		}
	});`],{type:"text/javascript"}),i=new Worker(URL.createObjectURL(e),{get type(){t=!0}}),s=await new Promise(n=>{i.addEventListener("message",o=>{i.terminate(),n(o.data)}),i.postMessage("")});return t&&s}catch(t){return console.warn("Error feature detecting worker mode: ",t),!1}}let f=new Audio;const N={"audio/webm; codecs=opus":!!f.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!f.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!f.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!f.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!f.canPlayType("audio/mp4"),"audio/mpeg":!!f.canPlayType("audio/mpeg")};f=null;async function q(t){return t=await D(t),new TextDecoder("utf-8").decode(t)}function D(t){return new Promise((e,i)=>{const s=new FileReader;s.onload=n=>e(n.target.result),s.onerror=n=>i(n),s.readAsArrayBuffer(t)})}const R=[];let y=0;window.RealFile=window.File;const v=[],T=new Map,A=new Map;let z=0;const H=[];self.runOnStartup=function(t){if(typeof t!="function")throw Error("runOnStartup called without a function");H.push(t)};const X=new Set(["cordova","playable-ad","instant-games"]);function G(t){return X.has(t)}let L=!1;window.RuntimeInterface=class S{constructor(e){if(this._useWorker=e.useWorker,this._messageChannelPort=null,this._runtimeBaseUrl="",this._scriptFolder=e.scriptFolder,this._workerScriptURLs={},this._localRuntime=this._worker=null,this._domHandlers=[],this._runtimeDomHandler=null,this._isFirstSizeUpdate=!0,this._canvasLayers=[],this._pendingRemoveElements=[],this._pendingUpdateHTMLZOrder=!1,this._updateHTMLZOrderRAFCallback=()=>this._DoUpdateHTMLElementsZOrder(),this._isExportingToVideo=!1,this._exportToVideoDuration=0,this._jobScheduler=null,this._rafId=-1,this._rafFunc=()=>this._OnRAFCallback(),this._rafCallbacks=new Set,this._wrapperInitResolve=null,this._wrapperComponentIds=[],this._exportType=e.exportType,this._isFileProtocol=location.protocol.substr(0,4)==="file",(this._exportType==="playable-ad"||this._exportType==="instant-games")&&(this._useWorker=!1),V&&(this._useWorker=!1),this._exportType==="cordova"&&this._useWorker&&C){const i=/Chrome\/(\d+)/i.exec(navigator.userAgent);i&&90<=parseInt(i[1],10)||(this._useWorker=!1)}this.IsAnyWebView2Wrapper()?self.chrome.webview.addEventListener("message",i=>this._OnWrapperMessage(i.data)):this._exportType==="macos-wkwebview"&&(self.C3WrapperOnMessage=i=>this._OnWrapperMessage(i)),this._localFileStrings=this._localFileBlobs=null,this._exportType!=="html5"||window.isSecureContext||console.warn("[Construct] Warning: the browser indicates this is not a secure context. Some features may be unavailable. Use secure (HTTPS) hosting to ensure all features are available."),this.AddRuntimeComponentMessageHandler("canvas","update-size",i=>this._OnUpdateCanvasSize(i)),this.AddRuntimeComponentMessageHandler("canvas","set-html-layer-count",i=>this._OnSetHTMLLayerCount(i)),this.AddRuntimeComponentMessageHandler("canvas","cleanup-html-layers",()=>this._OnCleanUpHTMLLayers()),this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",i=>this._OnCordovaFetchLocalFile(i)),this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",i=>this._OnCreateJobWorker(i)),this.AddRuntimeComponentMessageHandler("runtime","send-wrapper-extension-message",i=>this._OnSendWrapperExtensionMessage(i)),this._exportType==="cordova"?document.addEventListener("deviceready",()=>this._Init(e)):this._Init(e)}Release(){this._CancelAnimationFrame(),this._messageChannelPort&&(this._messageChannelPort=this._messageChannelPort.onmessage=null),this._worker&&(this._worker.terminate(),this._worker=null),this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null);for(const{canvas:e,htmlWrap:i}of this._canvasLayers)e.remove(),i.remove();this._canvasLayers.length=0}GetMainCanvas(){return this._canvasLayers[0].canvas}GetAvailableHTMLIndex(e){return Math.min(e,this._canvasLayers.length-1)}GetHTMLWrapElement(e){if(0>e||e>=this._canvasLayers.length)throw new RangeError("invalid canvas layer");return this._canvasLayers[e].htmlWrap}GetRuntimeBaseURL(){return this._runtimeBaseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsFileProtocol(){return this._isFileProtocol}GetScriptFolder(){return this._scriptFolder}IsiOSCordova(){return k&&this._exportType==="cordova"}IsiOSWebView(){const e=navigator.userAgent;return k&&G(this._exportType)||navigator.standalone||/crios\/|fxios\/|edgios\//i.test(e)}IsAndroid(){return C}IsAndroidWebView(){return C&&G(this._exportType)}IsWindowsWebView2(){return this._exportType==="windows-webview2"||!!(this._exportType==="preview"&&window.chrome&&window.chrome.webview&&window.chrome.webview.postMessage)}IsAnyWebView2Wrapper(){return this.IsWindowsWebView2()||this._exportType==="xbox-uwp-webview2"}async _Init(e){if(this._useWorker&&!await j()&&(this._useWorker=!1),this._exportType==="macos-wkwebview"?this._SendWrapperMessage({type:"ready"}):this.IsAnyWebView2Wrapper()&&(this._SetupWebView2Polyfills(),this._wrapperComponentIds=(await this._InitWrapper()).registeredComponentIds),this._exportType==="playable-ad"){this._localFileBlobs=self.c3_base64files,this._localFileStrings={},await this._ConvertDataUrisToBlobs();for(let s=0,n=e.engineScripts.length;s<n;++s){var i=e.engineScripts[s];this._localFileStrings.hasOwnProperty(i)?e.engineScripts[s]={isStringSrc:!0,str:this._localFileStrings[i]}:this._localFileBlobs.hasOwnProperty(i)&&(e.engineScripts[s]=URL.createObjectURL(this._localFileBlobs[i]))}e.workerDependencyScripts=[]}if(this._exportType==="nwjs"&&self.nw&&self.nw.App.manifest["c3-steam-mode"]){let s=0;this._AddRAFCallback(()=>{s++,document.body.style.opacity=s%2===0?"1":"0.999"})}if(e.runtimeBaseUrl?this._runtimeBaseUrl=e.runtimeBaseUrl:(i=location.origin,this._runtimeBaseUrl=(i==="null"?"file:///":i)+location.pathname,i=this._runtimeBaseUrl.lastIndexOf("/"),i!==-1&&(this._runtimeBaseUrl=this._runtimeBaseUrl.substr(0,i+1))),e.workerScripts&&(this._workerScriptURLs=e.workerScripts),i=new MessageChannel,this._messageChannelPort=i.port1,this._messageChannelPort.onmessage=s=>this._OnMessageFromRuntime(s.data),window.c3_addPortMessageHandler&&window.c3_addPortMessageHandler(s=>this._OnMessageFromDebugger(s)),this._jobScheduler=new self.JobSchedulerDOM(this),await this._jobScheduler.Init(),typeof window.StatusBar=="object"&&window.StatusBar.hide(),typeof window.AndroidFullScreen=="object")try{await new Promise((s,n)=>{window.AndroidFullScreen.immersiveMode(s,n)})}catch(s){console.error("Failed to enter Android immersive mode: ",s)}this._useWorker?await this._InitWorker(e,i.port2):await this._InitDOM(e,i.port2)}_GetWorkerURL(e){return e=this._workerScriptURLs.hasOwnProperty(e)?this._workerScriptURLs[e]:e.endsWith("/workermain.js")&&this._workerScriptURLs.hasOwnProperty("workermain.js")?this._workerScriptURLs["workermain.js"]:this._exportType==="playable-ad"&&this._localFileBlobs.hasOwnProperty(e)?this._localFileBlobs[e]:e,e instanceof Blob&&(e=URL.createObjectURL(e)),e}async CreateWorker(e,i,s){if(e.startsWith("blob:"))return new Worker(e,s);if(this._exportType==="cordova"&&this._isFileProtocol)return e=await this.CordovaFetchLocalFileAsArrayBuffer(s.isC3MainWorker?e:this._scriptFolder+e),e=new Blob([e],{type:"application/javascript"}),new Worker(URL.createObjectURL(e),s);if(e=new URL(e,i),location.origin!==e.origin){if(e=await fetch(e),!e.ok)throw Error("failed to fetch worker script");return e=await e.blob(),new Worker(URL.createObjectURL(e),s)}return new Worker(e,s)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}GetCssDisplayMode(){if(this.IsAnyWebView2Wrapper())return"standalone";const e=this.GetExportType();return new Set(["cordova","nwjs","macos-wkwebview"]).has(e)?"standalone":window.matchMedia("(display-mode: fullscreen)").matches?"fullscreen":window.matchMedia("(display-mode: standalone)").matches?"standalone":window.matchMedia("(display-mode: minimal-ui)").matches?"minimal-ui":navigator.standalone?"standalone":"browser"}_GetCommonRuntimeOptions(e){return{runtimeBaseUrl:this._runtimeBaseUrl,previewUrl:location.href,windowInnerWidth:this._GetWindowInnerWidth(),windowInnerHeight:this._GetWindowInnerHeight(),cssDisplayMode:this.GetCssDisplayMode(),devicePixelRatio:window.devicePixelRatio,isFullscreen:S.IsDocumentFullscreen(),projectData:e.projectData,previewImageBlobs:window.cr_previewImageBlobs||this._localFileBlobs,previewProjectFileBlobs:window.cr_previewProjectFileBlobs,previewProjectFileSWUrls:window.cr_previewProjectFiles,swClientId:window.cr_swClientId||"",exportType:e.exportType,isDebug:new URLSearchParams(self.location.search).has("debug"),ife:!!self.ife,jobScheduler:this._jobScheduler.GetPortData(),supportedAudioFormats:N,opusWasmScriptUrl:window.cr_opusWasmScriptUrl||this._scriptFolder+"opus.wasm.js",opusWasmBinaryUrl:window.cr_opusWasmBinaryUrl||this._scriptFolder+"opus.wasm.wasm",isFileProtocol:this._isFileProtocol,isiOSCordova:this.IsiOSCordova(),isiOSWebView:this.IsiOSWebView(),isWindowsWebView2:this.IsWindowsWebView2(),isAnyWebView2Wrapper:this.IsAnyWebView2Wrapper(),wrapperComponentIds:this._wrapperComponentIds,isFBInstantAvailable:typeof self.FBInstant<"u"}}async _InitWorker(e,i){const s=this._GetWorkerURL(e.workerMainUrl);this._exportType==="preview"?(this._worker=new Worker("previewworker.js",{type:"module",name:"Runtime"}),await new Promise((d,h)=>{const u=_=>{this._worker.removeEventListener("message",u),_.data&&_.data.type==="ok"?d():h()};this._worker.addEventListener("message",u),this._worker.postMessage({type:"construct-worker-init",import:new URL(s,this._runtimeBaseUrl).toString()})})):this._worker=await this.CreateWorker(s,this._runtimeBaseUrl,{type:"module",name:"Runtime",isC3MainWorker:!0});const n=document.createElement("canvas");n.style.display="none";const o=n.transferControlToOffscreen();document.body.appendChild(n);const a=document.createElement("div");a.className="c3htmlwrap",document.body.appendChild(a),this._canvasLayers.push({canvas:n,htmlWrap:a}),window.c3canvas=n,self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders();let r=e.workerDependencyScripts||[],l=e.engineScripts;if(r=await Promise.all(r.map(d=>this._MaybeGetCordovaScriptURL(d))),l=await Promise.all(l.map(d=>this._MaybeGetCordovaScriptURL(d))),this._exportType==="cordova")for(let d=0,h=e.projectScripts.length;d<h;++d){const u=e.projectScripts[d],_=u[0];(_===e.mainProjectScript||_==="scriptsInEvents.js"||_.endsWith("/scriptsInEvents.js"))&&(u[1]=await this._MaybeGetCordovaScriptURL(_))}this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(e),{type:"init-runtime",isInWorker:!0,messagePort:i,canvas:o,workerDependencyScripts:r,engineScripts:l,projectScripts:e.projectScripts,mainProjectScript:e.mainProjectScript,projectScriptsStatus:self.C3_ProjectScriptsStatus}),[i,o,...this._jobScheduler.GetPortTransferables()]),this._domHandlers=v.map(d=>new d(this)),this._FindRuntimeDOMHandler(),this._runtimeDomHandler._AddDefaultCanvasEventHandlers(n),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(a),this._runtimeDomHandler._EnableWindowResizeEvent(),self.c3_callFunction=(d,h)=>this._runtimeDomHandler._InvokeFunctionFromJS(d,h),this._exportType==="preview"&&(self.goToLastErrorScript=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(e,i){const s=document.createElement("canvas");s.style.display="none",document.body.appendChild(s);var n=document.createElement("div");if(n.className="c3htmlwrap",document.body.appendChild(n),this._canvasLayers.push({canvas:s,htmlWrap:n}),window.c3canvas=s,self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders(),this._domHandlers=v.map(r=>new r(this)),this._FindRuntimeDOMHandler(),this._runtimeDomHandler._AddDefaultCanvasEventHandlers(s),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(n),n=e.engineScripts.map(r=>typeof r=="string"?new URL(r,this._runtimeBaseUrl).toString():r),Array.isArray(e.workerDependencyScripts)){var o=[...e.workerDependencyScripts].map(r=>r instanceof Blob?URL.createObjectURL(r):r);n.unshift(...o)}n=await Promise.all(n.map(r=>this._MaybeGetCordovaScriptURL(r))),await Promise.all(n.map(r=>P(r))),n=self.C3_ProjectScriptsStatus,o=e.mainProjectScript;const a=e.projectScripts;for(let[r,l]of a)if(l||(l=r),r===o)try{l=await this._MaybeGetCordovaScriptURL(l),await P(l),this._exportType!=="preview"||n[r]||this._ReportProjectMainScriptError(r,"main script did not run to completion")}catch(d){this._ReportProjectMainScriptError(r,d)}else(r==="scriptsInEvents.js"||r.endsWith("/scriptsInEvents.js"))&&(l=await this._MaybeGetCordovaScriptURL(l),await P(l));this._exportType==="preview"&&typeof self.C3.ScriptsInEvents!="object"?(this._RemoveLoadingMessage(),console.error("[C3 runtime] Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax."),alert("Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax.")):(e=Object.assign(this._GetCommonRuntimeOptions(e),{isInWorker:!1,messagePort:i,canvas:s,runOnStartupFunctions:H}),this._runtimeDomHandler._EnableWindowResizeEvent(),this._OnBeforeCreateRuntime(),this._localRuntime=self.C3_CreateRuntime(e),await self.C3_InitRuntime(this._localRuntime,e))}_ReportProjectMainScriptError(e,i){this._RemoveLoadingMessage(),console.error(`[Preview] Failed to load project main script (${e}): `,i),alert(`Failed to load project main script (${e}). Check all your JavaScript code has valid syntax. Press F12 and check the console for error details.`)}_OnBeforeCreateRuntime(){this._RemoveLoadingMessage()}_RemoveLoadingMessage(){const e=window.cr_previewLoadingElem;e&&(e.parentElement.removeChild(e),window.cr_previewLoadingElem=null)}async _OnCreateJobWorker(e){return e=await this._jobScheduler._CreateJobWorker(),{outputPort:e,transferables:[e]}}_OnUpdateCanvasSize(e){if(!this.IsExportingToVideo()){var i=e.styleWidth+"px",s=e.styleHeight+"px",n=e.marginLeft+"px",o=e.marginTop+"px";for(const{canvas:a,htmlWrap:r}of this._canvasLayers)a.style.width=i,a.style.height=s,a.style.marginLeft=n,a.style.marginTop=o,r.style.width=i,r.style.height=s,r.style.marginLeft=n,r.style.marginTop=o,this._isFirstSizeUpdate&&(a.style.display="",r.style.display="");document.documentElement.style.setProperty("--construct-scale",e.displayScale),this._isFirstSizeUpdate=!1}}_OnSetHTMLLayerCount(e){var i=e.count,s=e.immediate;const n=e.styleWidth+"px",o=e.styleHeight+"px",a=e.marginLeft+"px";e=e.marginTop+"px";const r=[],l=[];if(i<this._canvasLayers.length)for(;this._canvasLayers.length>i;){const{canvas:d,htmlWrap:h}=this._canvasLayers.pop();h.remove(),this._useWorker&&!s?this._pendingRemoveElements.push(d):d.remove()}else if(i>this._canvasLayers.length)for(let d=0,h=i-this._canvasLayers.length;d<h;++d)i=document.createElement("canvas"),i.classList.add("c3overlay"),this._useWorker?(s=i.transferControlToOffscreen(),r.push(s),l.push(s)):r.push(i),document.body.appendChild(i),s=document.createElement("div"),s.classList.add("c3htmlwrap","c3overlay"),document.body.appendChild(s),i.style.width=n,i.style.height=o,i.style.marginLeft=a,i.style.marginTop=e,s.style.width=n,s.style.height=o,s.style.marginLeft=a,s.style.marginTop=e,this._runtimeDomHandler._AddDefaultCanvasEventHandlers(i),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(s),this._canvasLayers.push({canvas:i,htmlWrap:s});for(const d of this._domHandlers)d instanceof window.DOMElementHandler&&d._OnHTMLLayersChanged();return this._UpdateHTMLElementsZOrder(),{addedCanvases:r,transferables:l}}_OnCleanUpHTMLLayers(){for(const e of this._pendingRemoveElements)e.remove();this._pendingRemoveElements.length=0}_UpdateHTMLElementsZOrder(){this._pendingUpdateHTMLZOrder||(this._pendingUpdateHTMLZOrder=!0,this._AddRAFCallback(this._updateHTMLZOrderRAFCallback))}_DoUpdateHTMLElementsZOrder(){this._RemoveRAFCallback(this._updateHTMLZOrderRAFCallback),this._pendingUpdateHTMLZOrder=!1;let e=[];for(var i of this._domHandlers)if(i instanceof window.DOMElementHandler){var s=i._GetAllElementStatesForZOrderUpdate();s&&e.push(...s)}e.sort((a,r)=>{const l=a.GetActualHTMLIndex(),d=r.GetActualHTMLIndex();return l!==d?l-d:(a=a.GetHTMLZIndex(),r=r.GetHTMLZIndex(),a-r)});let n=s=i=0,o=e.length;for(;n<o;++n){const a=e[n];a.GetActualHTMLIndex()!==i&&(this._DoUpdateHTMLElementsZOrderOnHTMLLayer(i,e.slice(s,n)),i=a.GetActualHTMLIndex(),s=n)}s<n&&this._DoUpdateHTMLElementsZOrderOnHTMLLayer(i,e.slice(s,n))}_DoUpdateHTMLElementsZOrderOnHTMLLayer(e,i){if(!(1>=i.length||e>=this._canvasLayers.length)){i=i.map(l=>l.GetElement());var s=new Set(i);e=this.GetHTMLWrapElement(e);for(var n=Array.from(e.children).filter(l=>s.has(l)),o=0,a=Math.min(i.length,n.length);o<a&&i[o]===n[o];++o);for(var r=o;r<a;++r)n[r].remove();for(r=o;r<a;++r)e.appendChild(i[r])}}_GetLocalRuntime(){if(this._useWorker)throw Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(e,i,s,n,o){this._messageChannelPort.postMessage({type:"event",component:e,handler:i,dispatchOpts:n||null,data:s,responseId:null},o)}PostToRuntimeComponentAsync(e,i,s,n,o){const a=z++,r=new Promise((l,d)=>{A.set(a,{resolve:l,reject:d})});return this._messageChannelPort.postMessage({type:"event",component:e,handler:i,dispatchOpts:n||null,data:s,responseId:a},o),r}_OnMessageFromRuntime(e){const i=e.type;if(i==="event")return this._OnEventFromRuntime(e);if(i==="result")this._OnResultFromRuntime(e);else if(i==="runtime-ready")this._OnRuntimeReady();else if(i==="alert-error")this._RemoveLoadingMessage(),alert(e.message);else if(i==="creating-runtime")this._OnBeforeCreateRuntime();else throw Error(`unknown message '${i}'`)}_OnEventFromRuntime(e){const i=e.component,s=e.handler,n=e.data,o=e.responseId;if(e=T.get(i))if(e=e.get(s)){var a=null;try{a=e(n)}catch(r){console.error(`Exception in '${i}' handler '${s}':`,r),o!==null&&this._PostResultToRuntime(o,!1,""+r);return}if(o===null)return a;a&&a.then?a.then(r=>this._PostResultToRuntime(o,!0,r)).catch(r=>{console.error(`Rejection from '${i}' handler '${s}':`,r),this._PostResultToRuntime(o,!1,""+r)}):this._PostResultToRuntime(o,!0,a)}else console.warn(`[DOM] No handler '${s}' for component '${i}'`);else console.warn(`[DOM] No event handlers for component '${i}'`)}_PostResultToRuntime(e,i,s){let n;s&&s.transferables&&(n=s.transferables),this._messageChannelPort.postMessage({type:"result",responseId:e,isOk:i,result:s},n)}_OnResultFromRuntime(e){const i=e.responseId,s=e.isOk;e=e.result;const n=A.get(i);s?n.resolve(e):n.reject(e),A.delete(i)}AddRuntimeComponentMessageHandler(e,i,s){let n=T.get(e);if(n||(n=new Map,T.set(e,n)),n.has(i))throw Error(`[DOM] Component '${e}' already has handler '${i}'`);n.set(i,s)}static AddDOMHandlerClass(e){if(v.includes(e))throw Error("DOM handler already added");v.push(e)}_FindRuntimeDOMHandler(){for(const e of this._domHandlers)if(e.GetComponentID()==="runtime"){this._runtimeDomHandler=e;return}throw Error("cannot find runtime DOM handler")}_OnMessageFromDebugger(e){this.PostToRuntimeComponent("debugger","message",e)}_OnRuntimeReady(){for(const e of this._domHandlers)e.Attach()}static IsDocumentFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||L)}static _SetWrapperIsFullscreenFlag(e){L=!!e}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(e){this._rafCallbacks.add(e),this._RequestAnimationFrame()}_RemoveRAFCallback(e){this._rafCallbacks.delete(e),this._rafCallbacks.size===0&&this._CancelAnimationFrame()}_RequestAnimationFrame(){this._rafId===-1&&0<this._rafCallbacks.size&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){this._rafId!==-1&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const e of this._rafCallbacks)e();this._RequestAnimationFrame()}TryPlayMedia(e){this._runtimeDomHandler.TryPlayMedia(e)}RemovePendingPlay(e){this._runtimeDomHandler.RemovePendingPlay(e)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(e){this._runtimeDomHandler.SetSilent(e)}IsAudioFormatSupported(e){return!!N[e]}async _WasmDecodeWebMOpus(e){return e=await this.PostToRuntimeComponentAsync("runtime","opus-decode",{arrayBuffer:e},null,[e]),new Float32Array(e)}SetIsExportingToVideo(e){this._isExportingToVideo=!0,this._exportToVideoDuration=e}IsExportingToVideo(){return this._isExportingToVideo}GetExportToVideoDuration(){return this._exportToVideoDuration}IsAbsoluteURL(e){return/^(?:[a-z\-]+:)?\/\//.test(e)||e.substr(0,5)==="data:"||e.substr(0,5)==="blob:"}IsRelativeURL(e){return!this.IsAbsoluteURL(e)}async _MaybeGetCordovaScriptURL(e){return this._exportType==="cordova"&&(e.startsWith("file:")||this._isFileProtocol&&this.IsRelativeURL(e))?(e.startsWith(this._runtimeBaseUrl)&&(e=e.substr(this._runtimeBaseUrl.length)),e=await this.CordovaFetchLocalFileAsArrayBuffer(e),e=new Blob([e],{type:"application/javascript"}),URL.createObjectURL(e)):e}async _OnCordovaFetchLocalFile(e){const i=e.filename;switch(e.as){case"text":return await this.CordovaFetchLocalFileAsText(i);case"buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(i);default:throw Error("unsupported type")}}_GetPermissionAPI(){const e=window.cordova&&window.cordova.plugins&&window.cordova.plugins.permissions;if(typeof e!="object")throw Error("Permission API is not loaded");return e}_MapPermissionID(e,i){if(e=e[i],typeof e!="string")throw Error("Invalid permission name");return e}_HasPermission(e){const i=this._GetPermissionAPI();return new Promise((s,n)=>i.checkPermission(this._MapPermissionID(i,e),o=>s(!!o.hasPermission),n))}_RequestPermission(e){const i=this._GetPermissionAPI();return new Promise((s,n)=>i.requestPermission(this._MapPermissionID(i,e),o=>s(!!o.hasPermission),n))}async RequestPermissions(e){if(this.GetExportType()!=="cordova"||this.IsiOSCordova())return!0;for(const i of e)if(!await this._HasPermission(i)&&await this._RequestPermission(i)===!1)return!1;return!0}async RequirePermissions(...e){if(await this.RequestPermissions(e)===!1)throw Error("Permission not granted")}CordovaFetchLocalFile(e){const i=window.cordova.file.applicationDirectory+"www/"+e;return new Promise((s,n)=>{window.resolveLocalFileSystemURL(i,o=>{o.file(s,n)},n)})}async CordovaFetchLocalFileAsText(e){return e=await this.CordovaFetchLocalFile(e),await q(e)}_CordovaMaybeStartNextArrayBufferRead(){if(R.length&&!(8<=y)){y++;var e=R.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(e.filename,e.successCallback,e.errorCallback)}}CordovaFetchLocalFileAsArrayBuffer(e){return new Promise((i,s)=>{R.push({filename:e,successCallback:n=>{y--,this._CordovaMaybeStartNextArrayBufferRead(),i(n)},errorCallback:n=>{y--,this._CordovaMaybeStartNextArrayBufferRead(),s(n)}}),this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(e,i,s){try{const n=await this.CordovaFetchLocalFile(e),o=await D(n);i(o)}catch(n){s(n)}}_OnWrapperMessage(e){if(e==="entered-fullscreen")S._SetWrapperIsFullscreenFlag(!0),this._runtimeDomHandler._OnFullscreenChange();else if(e==="exited-fullscreen")S._SetWrapperIsFullscreenFlag(!1),this._runtimeDomHandler._OnFullscreenChange();else if(typeof e=="object"){const i=e.type;i==="wrapper-init-response"?(this._wrapperInitResolve(e),this._wrapperInitResolve=null):i==="extension-message"?this.PostToRuntimeComponent("runtime","wrapper-extension-message",e):console.warn("Unknown wrapper message: ",e)}else console.warn("Unknown wrapper message: ",e)}_OnSendWrapperExtensionMessage(e){this._SendWrapperMessage({type:"extension-message",componentId:e.componentId,messageId:e.messageId,params:e.params||[],asyncId:e.asyncId})}_SendWrapperMessage(e){this.IsAnyWebView2Wrapper()?window.chrome.webview.postMessage(JSON.stringify(e)):this._exportType==="macos-wkwebview"&&window.webkit.messageHandlers.C3Wrapper.postMessage(JSON.stringify(e))}_SetupWebView2Polyfills(){window.moveTo=(e,i)=>{this._SendWrapperMessage({type:"set-window-position",windowX:Math.ceil(e),windowY:Math.ceil(i)})},window.resizeTo=(e,i)=>{this._SendWrapperMessage({type:"set-window-size",windowWidth:Math.ceil(e),windowHeight:Math.ceil(i)})}}_InitWrapper(){return this.IsAnyWebView2Wrapper()?new Promise(e=>{this._wrapperInitResolve=e,this._SendWrapperMessage({type:"wrapper-init"})}):Promise.resolve()}async _ConvertDataUrisToBlobs(){const e=[];for(const[i,s]of Object.entries(this._localFileBlobs))e.push(this._ConvertDataUriToBlobs(i,s));await Promise.all(e)}async _ConvertDataUriToBlobs(e,i){if(typeof i=="object")this._localFileBlobs[e]=new Blob([i.str],{type:i.type}),this._localFileStrings[e]=i.str;else{let s=await this._FetchDataUri(i);s||(s=this._DataURIToBinaryBlobSync(i)),this._localFileBlobs[e]=s}}async _FetchDataUri(e){try{return await(await fetch(e)).blob()}catch(i){return console.warn("Failed to fetch a data: URI. Falling back to a slower workaround. This is probably because the Content Security Policy unnecessarily blocked it. Allow data: URIs in your CSP to avoid this.",i),null}}_DataURIToBinaryBlobSync(e){return e=this._ParseDataURI(e),this._BinaryStringToBlob(e.data,e.mime_type)}_ParseDataURI(e){var i=e.indexOf(",");if(0>i)throw new URIError("expected comma in data: uri");var s=e.substring(5,i);e=e.substring(i+1),i=s.split(";"),s=i[0]||"";const n=i[2];return e=i[1]==="base64"||n==="base64"?atob(e):decodeURIComponent(e),{mime_type:s,data:e}}_BinaryStringToBlob(e,i){var s=e.length;let n=s>>2,o=new Uint8Array(s),a=new Uint32Array(o.buffer,0,n),r,l;for(l=r=0;r<n;++r)a[r]=e.charCodeAt(l++)|e.charCodeAt(l++)<<8|e.charCodeAt(l++)<<16|e.charCodeAt(l++)<<24;for(s&=3;s--;)o[l]=e.charCodeAt(l),++l;return new Blob([o],{type:i})}};const g=self.RuntimeInterface;function Y(t){return t.sourceCapabilities&&t.sourceCapabilities.firesTouchEvents||t.originalEvent&&t.originalEvent.sourceCapabilities&&t.originalEvent.sourceCapabilities.firesTouchEvents}const K=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),m={dispatchRuntimeEvent:!0,dispatchUserScriptEvent:!0},O={dispatchUserScriptEvent:!0},Z={dispatchRuntimeEvent:!0};function $(t){return new Promise((e,i)=>{const s=document.createElement("link");s.onload=()=>e(s),s.onerror=n=>i(n),s.rel="stylesheet",s.href=t,document.head.appendChild(s)})}function J(t){return new Promise((e,i)=>{const s=new Image;s.onload=()=>e(s),s.onerror=n=>i(n),s.src=t})}async function W(t){t=URL.createObjectURL(t);try{return await J(t)}finally{URL.revokeObjectURL(t)}}function U(t){do{if(t.parentNode&&t.hasAttribute("contenteditable"))return!0;t=t.parentNode}while(t);return!1}const Q=new Set(["input","textarea","datalist","select"]);function ee(t){return Q.has(t.tagName.toLowerCase())||U(t)}const te=new Set(["canvas","body","html"]);function p(t){if(t.target.tagName){var e=t.target.tagName.toLowerCase();te.has(e)&&t.preventDefault()}}function E(t){t.target.tagName&&t.target.classList.contains("c3htmlwrap")&&t.preventDefault()}function b(t){(t.metaKey||t.ctrlKey)&&t.preventDefault()}self.C3_GetSvgImageSize=async function(t){if(t=await W(t),0<t.width&&0<t.height)return[t.width,t.height];t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.visibility="hidden",document.body.appendChild(t);const e=t.getBoundingClientRect();return document.body.removeChild(t),[e.width,e.height]};self.C3_RasterSvgImageBlob=async function(t,e,i,s,n){t=await W(t);const o=document.createElement("canvas");return o.width=s,o.height=n,o.getContext("2d").drawImage(t,0,0,e,i),o};let M=!1;document.addEventListener("pause",()=>M=!0);document.addEventListener("resume",()=>M=!1);function ie(){try{return window.parent&&window.parent.document.hasFocus()}catch{return!1}}g.AddDOMHandlerClass(class extends self.DOMHandler{constructor(t){super(t,"runtime"),this._enableWindowResizeEvent=!1,this._simulatedResizeTimerId=-1,this._targetOrientation="any",this._pageVisibilityIsHidden=this._attachedDeviceMotionEvent=this._attachedDeviceOrientationEvent=!1,this._screenReaderTextWrap=document.createElement("div"),this._screenReaderTextWrap.className="c3-screen-reader-text",this._screenReaderTextWrap.setAttribute("aria-live","polite"),document.body.appendChild(this._screenReaderTextWrap),this._debugHighlightElem=null,this._isExportToVideo=!1,this._exportVideoProgressMessage="",this._exportVideoUpdateTimerId=-1,this._enableAndroidVKDetection=!1,this._lastWindowWidth=t._GetWindowInnerWidth(),this._lastWindowHeight=t._GetWindowInnerHeight(),this._vkTranslateYOffset=this._virtualKeyboardHeight=0,t.AddRuntimeComponentMessageHandler("runtime","invoke-download",i=>this._OnInvokeDownload(i)),t.AddRuntimeComponentMessageHandler("runtime","load-webfonts",i=>this._OnLoadWebFonts(i)),t.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",i=>this._OnRasterSvgImage(i)),t.AddRuntimeComponentMessageHandler("runtime","get-svg-image-size",i=>this._OnGetSvgImageSize(i)),t.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",i=>this._OnSetTargetOrientation(i)),t.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW()),t.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",i=>this._OnPostToDebugger(i)),t.AddRuntimeComponentMessageHandler("runtime","go-to-script",i=>this._OnPostToDebugger(i)),t.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking()),t.AddRuntimeComponentMessageHandler("runtime","debug-highlight",i=>this._OnDebugHighlight(i)),t.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent()),t.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent()),t.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",i=>this._OnAddStylesheet(i)),t.AddRuntimeComponentMessageHandler("runtime","script-create-worker",i=>this._OnScriptCreateWorker(i)),t.AddRuntimeComponentMessageHandler("runtime","alert",i=>this._OnAlert(i)),t.AddRuntimeComponentMessageHandler("runtime","screen-reader-text",i=>this._OnScreenReaderTextEvent(i)),t.AddRuntimeComponentMessageHandler("runtime","hide-cordova-splash",()=>this._OnHideCordovaSplash()),t.AddRuntimeComponentMessageHandler("runtime","set-exporting-to-video",i=>this._SetExportingToVideo(i)),t.AddRuntimeComponentMessageHandler("runtime","export-to-video-progress",i=>this._OnExportVideoProgress(i)),t.AddRuntimeComponentMessageHandler("runtime","exported-to-video",i=>this._OnExportedToVideo(i)),t.AddRuntimeComponentMessageHandler("runtime","exported-to-image-sequence",i=>this._OnExportedToImageSequence(i));const e=new Set(["input","textarea","datalist"]);if(window.addEventListener("contextmenu",i=>{const s=i.target,n=s.tagName.toLowerCase();e.has(n)||U(s)||i.preventDefault()}),window.addEventListener("selectstart",p),window.addEventListener("gesturehold",p),window.addEventListener("touchstart",p,{passive:!1}),window.addEventListener("pointerdown",p,{passive:!1}),this._mousePointerLastButtons=0,window.addEventListener("mousedown",i=>{i.button===1&&i.preventDefault()}),window.addEventListener("mousewheel",b,{passive:!1}),window.addEventListener("wheel",b,{passive:!1}),window.addEventListener("resize",()=>this._OnWindowResize()),window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("fullscreenerror",i=>this._OnFullscreenError(i)),window.addEventListener("webkitfullscreenerror",i=>this._OnFullscreenError(i)),window.addEventListener("mozfullscreenerror",i=>this._OnFullscreenError(i)),t.IsiOSWebView()){let i=1/0;window.visualViewport.addEventListener("resize",()=>{const s=window.visualViewport.height;s>i&&(document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0),i=s}),document.documentElement.setAttribute("ioswebview","")}this._mediaPendingPlay=new Set,this._mediaRemovedPendingPlay=new WeakSet,this._isSilent=!1}_AddDefaultCanvasEventHandlers(t){t.addEventListener("selectstart",p),t.addEventListener("gesturehold",p),t.addEventListener("pointerdown",p)}_AddDefaultHTMLWrapEventHandlers(t){t.addEventListener("selectstart",E),t.addEventListener("gesturehold",E),t.addEventListener("touchstart",E)}_OnBeforeStartTicking(){return self.setTimeout(()=>{this._enableAndroidVKDetection=!0},1e3),this._iRuntime.GetExportType()==="cordova"?(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):document.addEventListener("visibilitychange",()=>this._OnVisibilityChange(document.visibilityState==="hidden")),this._pageVisibilityIsHidden=!(document.visibilityState!=="hidden"&&!M),{isSuspended:this._pageVisibilityIsHidden}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus")),window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{parentHasFocus:ie()}),this._mousePointerLastButtons=0}),window.addEventListener("focusin",e=>{ee(e.target)&&this._PostRuntimeEvent("keyboard-blur")}),window.addEventListener("keydown",e=>this._OnKeyEvent("keydown",e)),window.addEventListener("keyup",e=>this._OnKeyEvent("keyup",e)),window.addEventListener("mousedown",e=>this._OnMouseEvent("mousedown",e,O)),window.addEventListener("mousemove",e=>this._OnMouseEvent("mousemove",e,O)),window.addEventListener("mouseup",e=>this._OnMouseEvent("mouseup",e,O)),window.addEventListener("dblclick",e=>this._OnMouseEvent("dblclick",e,m)),window.addEventListener("wheel",e=>this._OnMouseWheelEvent("wheel",e,m)),window.addEventListener("pointerdown",e=>{this._HandlePointerDownFocus(e),this._OnPointerEvent("pointerdown",e)}),this._iRuntime.UsesWorker()&&typeof window.onpointerrawupdate<"u"&&self===self.top?window.addEventListener("pointerrawupdate",e=>this._OnPointerRawUpdate(e)):window.addEventListener("pointermove",e=>this._OnPointerEvent("pointermove",e)),window.addEventListener("pointerup",e=>this._OnPointerEvent("pointerup",e)),window.addEventListener("pointercancel",e=>this._OnPointerEvent("pointercancel",e));const t=()=>this._PlayPendingMedia();window.addEventListener("pointerup",t,!0),window.addEventListener("touchend",t,!0),window.addEventListener("click",t,!0),window.addEventListener("keydown",t,!0),window.addEventListener("gamepadconnected",t,!0),this._iRuntime.IsAndroid()&&!this._iRuntime.IsAndroidWebView()&&navigator.virtualKeyboard&&(navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.addEventListener("geometrychange",()=>{this._OnAndroidVirtualKeyboardChange(this._GetWindowInnerHeight(),navigator.virtualKeyboard.boundingRect.height)})),this._iRuntime.IsiOSWebView()&&(document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0)}_OnAndroidVirtualKeyboardChange(t,e){if(document.body.style.position="",document.body.style.overflow="",document.body.style.transform="",this._vkTranslateYOffset=0,0<e){var i=document.activeElement;i&&(i=i.getBoundingClientRect(),t=(i.top+i.bottom)/2-(t-e)/2,t>e&&(t=e),0>t&&(t=0),0<t&&(document.body.style.position="absolute",document.body.style.overflow="visible",document.body.style.transform=`translateY(${-t}px)`,this._vkTranslateYOffset=t))}}_PostRuntimeEvent(t,e){this.PostToRuntime(t,e||null,Z)}_GetWindowInnerWidth(){return this._iRuntime._GetWindowInnerWidth()}_GetWindowInnerHeight(){return this._iRuntime._GetWindowInnerHeight()}_EnableWindowResizeEvent(){this._enableWindowResizeEvent=!0,this._lastWindowWidth=this._iRuntime._GetWindowInnerWidth(),this._lastWindowHeight=this._iRuntime._GetWindowInnerHeight()}_OnWindowResize(){if(!this._isExportToVideo&&this._enableWindowResizeEvent){var t=this._GetWindowInnerWidth(),e=this._GetWindowInnerHeight();if(this._iRuntime.IsAndroidWebView()){if(this._enableAndroidVKDetection){if(this._lastWindowWidth===t&&e<this._lastWindowHeight){this._virtualKeyboardHeight=this._lastWindowHeight-e,this._OnAndroidVirtualKeyboardChange(this._lastWindowHeight,this._virtualKeyboardHeight);return}0<this._virtualKeyboardHeight&&(this._virtualKeyboardHeight=0,this._OnAndroidVirtualKeyboardChange(e,this._virtualKeyboardHeight))}this._lastWindowWidth=t,this._lastWindowHeight=e}this.PostToRuntime("window-resize",{innerWidth:t,innerHeight:e,devicePixelRatio:window.devicePixelRatio,isFullscreen:g.IsDocumentFullscreen(),cssDisplayMode:this._iRuntime.GetCssDisplayMode()}),this._iRuntime.IsiOSWebView()&&(this._simulatedResizeTimerId!==-1&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(t,e,0))}}_ScheduleSimulatedResize(t,e,i){this._simulatedResizeTimerId!==-1&&clearTimeout(this._simulatedResizeTimerId),this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(t,e,i),48)}_OnSimulatedResize(t,e,i){const s=this._GetWindowInnerWidth(),n=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1,s!=t||n!=e?this.PostToRuntime("window-resize",{innerWidth:s,innerHeight:n,devicePixelRatio:window.devicePixelRatio,isFullscreen:g.IsDocumentFullscreen(),cssDisplayMode:this._iRuntime.GetCssDisplayMode()}):10>i&&this._ScheduleSimulatedResize(s,n,i+1)}_OnSetTargetOrientation(t){this._targetOrientation=t.targetOrientation}_TrySetTargetOrientation(){const t=this._targetOrientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(t).catch(e=>console.warn("[Construct] Failed to lock orientation: ",e));else try{let e=!1;screen.lockOrientation?e=screen.lockOrientation(t):screen.webkitLockOrientation?e=screen.webkitLockOrientation(t):screen.mozLockOrientation?e=screen.mozLockOrientation(t):screen.msLockOrientation&&(e=screen.msLockOrientation(t)),e||console.warn("[Construct] Failed to lock orientation")}catch(e){console.warn("[Construct] Failed to lock orientation: ",e)}}_OnFullscreenChange(){if(!this._isExportToVideo){var t=g.IsDocumentFullscreen();t&&this._targetOrientation!=="any"&&this._TrySetTargetOrientation(),this.PostToRuntime("fullscreenchange",{isFullscreen:t,innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}}_OnFullscreenError(t){console.warn("[Construct] Fullscreen request failed: ",t),this.PostToRuntime("fullscreenerror",{isFullscreen:g.IsDocumentFullscreen(),innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnVisibilityChange(t){this._pageVisibilityIsHidden!==t&&((this._pageVisibilityIsHidden=t)?this._iRuntime._CancelAnimationFrame():this._iRuntime._RequestAnimationFrame(),this.PostToRuntime("visibilitychange",{hidden:t}),!t&&this._iRuntime.IsiOSWebView()&&(t=()=>{document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0},setTimeout(t,50),setTimeout(t,100),setTimeout(t,250),setTimeout(t,500)))}_OnKeyEvent(t,e){if(e.key==="Backspace"&&p(e),this._iRuntime.GetExportType()==="nwjs"&&e.key==="u"&&(e.ctrlKey||e.metaKey)&&e.preventDefault(),!this._isExportToVideo){var i=K.get(e.code)||e.code;this._PostToRuntimeMaybeSync(t,{code:i,key:e.key,which:e.which,repeat:e.repeat,altKey:e.altKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey,timeStamp:e.timeStamp},m)}}_OnMouseWheelEvent(t,e,i){this._isExportToVideo||this.PostToRuntime(t,{clientX:e.clientX,clientY:e.clientY+this._vkTranslateYOffset,pageX:e.pageX,pageY:e.pageY+this._vkTranslateYOffset,deltaX:e.deltaX,deltaY:e.deltaY,deltaZ:e.deltaZ,deltaMode:e.deltaMode,timeStamp:e.timeStamp},i)}_OnMouseEvent(t,e,i){this._isExportToVideo||Y(e)||this._PostToRuntimeMaybeSync(t,{button:e.button,buttons:e.buttons,clientX:e.clientX,clientY:e.clientY+this._vkTranslateYOffset,pageX:e.pageX,pageY:e.pageY+this._vkTranslateYOffset,movementX:e.movementX||0,movementY:e.movementY||0,timeStamp:e.timeStamp},i)}_OnPointerEvent(t,e){if(!this._isExportToVideo){var i=0;e.pointerType==="mouse"&&(i=this._mousePointerLastButtons),this._PostToRuntimeMaybeSync(t,{pointerId:e.pointerId,pointerType:e.pointerType,button:e.button,buttons:e.buttons,lastButtons:i,clientX:e.clientX,clientY:e.clientY+this._vkTranslateYOffset,pageX:e.pageX,pageY:e.pageY+this._vkTranslateYOffset,movementX:e.movementX||0,movementY:e.movementY||0,width:e.width||0,height:e.height||0,pressure:e.pressure||0,tangentialPressure:e.tangentialPressure||0,tiltX:e.tiltX||0,tiltY:e.tiltY||0,twist:e.twist||0,timeStamp:e.timeStamp},m),e.pointerType==="mouse"&&(this._mousePointerLastButtons=e.buttons)}}_OnPointerRawUpdate(t){this._OnPointerEvent("pointermove",t)}_OnTouchEvent(t,e){if(!this._isExportToVideo)for(let i=0,s=e.changedTouches.length;i<s;++i){const n=e.changedTouches[i];this._PostToRuntimeMaybeSync(t,{pointerId:n.identifier,pointerType:"touch",button:0,buttons:0,lastButtons:0,clientX:n.clientX,clientY:n.clientY+this._vkTranslateYOffset,pageX:n.pageX,pageY:n.pageY+this._vkTranslateYOffset,movementX:e.movementX||0,movementY:e.movementY||0,width:2*(n.radiusX||n.webkitRadiusX||0),height:2*(n.radiusY||n.webkitRadiusY||0),pressure:n.force||n.webkitForce||0,tangentialPressure:0,tiltX:0,tiltY:0,twist:n.rotationAngle||0,timeStamp:e.timeStamp},m)}}_HandlePointerDownFocus(t){window!==window.top&&window.focus(),this._IsElementCanvasOrDocument(t.target)&&document.activeElement&&!this._IsElementCanvasOrDocument(document.activeElement)&&document.activeElement.blur()}_IsElementCanvasOrDocument(t){return!t||t===document||t===window||t===document.body||t.tagName.toLowerCase()==="canvas"}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",t=>this._OnDeviceOrientation(t)),window.addEventListener("deviceorientationabsolute",t=>this._OnDeviceOrientationAbsolute(t)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",t=>this._OnDeviceMotion(t)))}_OnDeviceOrientation(t){this._isExportToVideo||this.PostToRuntime("deviceorientation",{absolute:!!t.absolute,alpha:t.alpha||0,beta:t.beta||0,gamma:t.gamma||0,timeStamp:t.timeStamp,webkitCompassHeading:t.webkitCompassHeading,webkitCompassAccuracy:t.webkitCompassAccuracy},m)}_OnDeviceOrientationAbsolute(t){this._isExportToVideo||this.PostToRuntime("deviceorientationabsolute",{absolute:!!t.absolute,alpha:t.alpha||0,beta:t.beta||0,gamma:t.gamma||0,timeStamp:t.timeStamp},m)}_OnDeviceMotion(t){if(!this._isExportToVideo){var e=null,i=t.acceleration;i&&(e={x:i.x||0,y:i.y||0,z:i.z||0}),i=null;var s=t.accelerationIncludingGravity;s&&(i={x:s.x||0,y:s.y||0,z:s.z||0}),s=null;var n=t.rotationRate;n&&(s={alpha:n.alpha||0,beta:n.beta||0,gamma:n.gamma||0}),this.PostToRuntime("devicemotion",{acceleration:e,accelerationIncludingGravity:i,rotationRate:s,interval:t.interval,timeStamp:t.timeStamp},m)}}_OnInvokeDownload(t){const e=t.url;t=t.filename;const i=document.createElement("a"),s=document.body;i.textContent=t,i.href=e,i.download=t,s.appendChild(i),i.click(),s.removeChild(i)}async _OnLoadWebFonts(t){await Promise.all(t.webfonts.map(async e=>{e=new FontFace(e.name,`url('${e.url}')`),document.fonts.add(e),await e.load()}))}async _OnRasterSvgImage(t){var e=t.imageBitmapOpts;return t=await self.C3_RasterSvgImageBlob(t.blob,t.imageWidth,t.imageHeight,t.surfaceWidth,t.surfaceHeight),e=e?await createImageBitmap(t,e):await createImageBitmap(t),{imageBitmap:e,transferables:[e]}}async _OnGetSvgImageSize(t){return await self.C3_GetSvgImageSize(t.blob)}async _OnAddStylesheet(t){await $(t.url)}_PlayPendingMedia(){var t=[...this._mediaPendingPlay];if(this._mediaPendingPlay.clear(),!this._isSilent)for(const e of t)(t=e.play())&&t.catch(i=>{this._mediaRemovedPendingPlay.has(e)||this._mediaPendingPlay.add(e)})}TryPlayMedia(t){if(typeof t.play!="function")throw Error("missing play function");this._mediaRemovedPendingPlay.delete(t);let e;try{e=t.play()}catch{this._mediaPendingPlay.add(t);return}e&&e.catch(i=>{this._mediaRemovedPendingPlay.has(t)||this._mediaPendingPlay.add(t)})}RemovePendingPlay(t){this._mediaPendingPlay.delete(t),this._mediaRemovedPendingPlay.add(t)}SetSilent(t){this._isSilent=!!t}_OnHideCordovaSplash(){navigator.splashscreen&&navigator.splashscreen.hide&&navigator.splashscreen.hide()}_OnDebugHighlight(t){if(t.show){this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));var e=this._debugHighlightElem;e.style.display="",e.style.left=t.left-1+"px",e.style.top=t.top-1+"px",e.style.width=t.width+2+"px",e.style.height=t.height+2+"px",e.textContent=t.name}else this._debugHighlightElem&&(this._debugHighlightElem.style.display="none")}_OnRegisterSW(){window.C3_RegisterSW&&window.C3_RegisterSW()}_OnPostToDebugger(t){window.c3_postToMessagePort&&(t.from="runtime",window.c3_postToMessagePort(t))}_InvokeFunctionFromJS(t,e){return this.PostToRuntimeAsync("js-invoke-function",{name:t,params:e})}_OnScriptCreateWorker(t){const e=t.port2;new Worker(t.url,t.opts).postMessage({type:"construct-worker-init",port2:e},[e])}_OnAlert(t){alert(t.message)}_OnScreenReaderTextEvent(t){var e=t.type;e==="create"?(e=document.createElement("p"),e.id="c3-sr-"+t.id,e.textContent=t.text,this._screenReaderTextWrap.appendChild(e)):e==="update"?(e=document.getElementById("c3-sr-"+t.id))?e.textContent=t.text:console.warn(`[Construct] Missing screen reader text with id ${t.id}`):e==="release"?(e=document.getElementById("c3-sr-"+t.id))?e.remove():console.warn(`[Construct] Missing screen reader text with id ${t.id}`):console.warn(`[Construct] Unknown screen reader text update '${e}'`)}_SetExportingToVideo(t){this._isExportToVideo=!0;const e=document.createElement("h1");e.id="exportToVideoMessage",e.textContent=t.message,document.body.prepend(e),document.body.classList.add("exportingToVideo"),this.GetRuntimeInterface().GetMainCanvas().style.display="",this._iRuntime.SetIsExportingToVideo(t.duration)}_OnExportVideoProgress(t){this._exportVideoProgressMessage=t.message,this._exportVideoUpdateTimerId===-1&&(this._exportVideoUpdateTimerId=setTimeout(()=>this._DoUpdateExportVideoProgressMessage(),250))}_DoUpdateExportVideoProgressMessage(){this._exportVideoUpdateTimerId=-1;const t=document.getElementById("exportToVideoMessage");t&&(t.textContent=this._exportVideoProgressMessage)}_OnExportedToVideo(t){window.c3_postToMessagePort({type:"exported-video",arrayBuffer:t.arrayBuffer,contentType:t.contentType,time:t.time})}_OnExportedToImageSequence(t){window.c3_postToMessagePort({type:"exported-image-sequence",blobArr:t.blobArr,time:t.time,gif:t.gif})}});self.JobSchedulerDOM=class{constructor(t){this._runtimeInterface=t,this._baseUrl=t.GetRuntimeBaseURL(),t.GetExportType()==="preview"?this._baseUrl+="workers/":this._baseUrl+=t.GetScriptFolder(),this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16),this._dispatchWorker=null,this._jobWorkers=[],this._outputPort=this._inputPort=null}_GetWorkerScriptFolder(){return this._runtimeInterface.GetExportType()==="playable-ad"?this._runtimeInterface.GetScriptFolder():""}async Init(){if(this._hasInitialised)throw Error("already initialised");this._hasInitialised=!0;var t=this._runtimeInterface._GetWorkerURL(this._GetWorkerScriptFolder()+"dispatchworker.js");this._dispatchWorker=await this._runtimeInterface.CreateWorker(t,this._baseUrl,{name:"DispatchWorker"}),t=new MessageChannel,this._inputPort=t.port1,this._dispatchWorker.postMessage({type:"_init","in-port":t.port2},[t.port2]),this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const t=this._jobWorkers.length;var e=this._runtimeInterface._GetWorkerURL(this._GetWorkerScriptFolder()+"jobworker.js");e=await this._runtimeInterface.CreateWorker(e,this._baseUrl,{name:"JobWorker"+t});const i=new MessageChannel,s=new MessageChannel;return this._dispatchWorker.postMessage({type:"_addJobWorker",port:i.port1},[i.port1]),e.postMessage({type:"init",number:t,"dispatch-port":i.port2,"output-port":s.port2},[i.port2,s.port2]),this._jobWorkers.push(e),s.port1}GetPortData(){return{inputPort:this._inputPort,outputPort:this._outputPort,maxNumWorkers:this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}};window.C3_Is_Supported&&(window.c3_runtimeInterface=new self.RuntimeInterface({useWorker:!0,workerMainUrl:"workermain.js",engineScripts:["scripts/c3runtime.js"],projectScripts:[],mainProjectScript:"",scriptFolder:"scripts/",workerDependencyScripts:[],exportType:"html5"}));let w=null,I=null;window.addEventListener("beforeinstallprompt",t=>(t.preventDefault(),w=t,I&&I._OnBeforeInstallPrompt(),!1));function se(t,e){return t?e?Array.from(document.querySelectorAll(t)):(t=document.querySelector(t))?[t]:[]:[document.documentElement]}function F(){}self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMHandler{constructor(t){super(t,"browser"),this._exportType="",this.AddRuntimeMessageHandlers([["get-initial-state",e=>this._OnGetInitialState(e)],["ready-for-sw-messages",()=>this._OnReadyForSWMessages()],["alert",e=>this._OnAlert(e)],["close",()=>this._OnClose()],["set-focus",e=>this._OnSetFocus(e)],["vibrate",e=>this._OnVibrate(e)],["lock-orientation",e=>this._OnLockOrientation(e)],["unlock-orientation",()=>this._OnUnlockOrientation()],["navigate",e=>this._OnNavigate(e)],["request-fullscreen",e=>this._OnRequestFullscreen(e)],["exit-fullscreen",()=>this._OnExitFullscreen()],["set-hash",e=>this._OnSetHash(e)],["set-document-css-style",e=>this._OnSetDocumentCSSStyle(e)],["get-document-css-style",e=>this._OnGetDocumentCSSStyle(e)],["set-window-size",e=>this._OnSetWindowSize(e)],["set-window-position",e=>this._OnSetWindowPosition(e)],["request-install",()=>this._OnRequestInstall()]]),window.addEventListener("online",()=>this._OnOnlineStateChanged(!0)),window.addEventListener("offline",()=>this._OnOnlineStateChanged(!1)),window.addEventListener("hashchange",()=>this._OnHashChange()),document.addEventListener("backbutton",()=>this._OnCordovaBackButton())}Attach(){w?this._OnBeforeInstallPrompt():I=this,window.addEventListener("appinstalled",()=>this._OnAppInstalled())}_OnGetInitialState(t){return this._exportType=t.exportType,{location:location.toString(),isOnline:!!navigator.onLine,referrer:document.referrer,title:document.title,isCookieEnabled:!!navigator.cookieEnabled,screenWidth:screen.width,screenHeight:screen.height,windowOuterWidth:window.outerWidth,windowOuterHeight:window.outerHeight,isConstructArcade:typeof window.is_scirra_arcade<"u"}}_OnReadyForSWMessages(){window.C3_RegisterSW&&window.OfflineClientInfo&&window.OfflineClientInfo.SetMessageCallback(t=>this.PostToRuntime("sw-message",t.data))}_OnBeforeInstallPrompt(){this.PostToRuntime("install-available")}async _OnRequestInstall(){if(!w)return{result:"unavailable"};try{return w.prompt(),{result:(await w.userChoice).outcome}}catch(t){return console.error("[Construct] Requesting install failed: ",t),{result:"failed"}}}_OnAppInstalled(){this.PostToRuntime("app-installed")}_OnOnlineStateChanged(t){this.PostToRuntime("online-state",{isOnline:t})}_OnCordovaBackButton(){this.PostToRuntime("backbutton")}GetNWjsWindow(){return this._exportType==="nwjs"?nw.Window.get():null}_OnAlert(t){alert(t.message)}_OnClose(){navigator.app&&navigator.app.exitApp?navigator.app.exitApp():navigator.device&&navigator.device.exitApp?navigator.device.exitApp():window.close()}_OnSetFocus(t){if(t=t.isFocus,this._exportType==="nwjs"){const e=this.GetNWjsWindow();t?e.focus():e.blur()}else t?window.focus():window.blur()}_OnVibrate(t){navigator.vibrate&&navigator.vibrate(t.pattern)}_OnLockOrientation(t){if(t=t.orientation,screen.orientation&&screen.orientation.lock)screen.orientation.lock(t).catch(e=>console.warn("[Construct] Failed to lock orientation: ",e));else try{let e=!1;screen.lockOrientation?e=screen.lockOrientation(t):screen.webkitLockOrientation?e=screen.webkitLockOrientation(t):screen.mozLockOrientation?e=screen.mozLockOrientation(t):screen.msLockOrientation&&(e=screen.msLockOrientation(t)),e||console.warn("[Construct] Failed to lock orientation")}catch(e){console.warn("[Construct] Failed to lock orientation: ",e)}}_OnUnlockOrientation(){try{screen.orientation&&screen.orientation.unlock?screen.orientation.unlock():screen.unlockOrientation?screen.unlockOrientation():screen.webkitUnlockOrientation?screen.webkitUnlockOrientation():screen.mozUnlockOrientation?screen.mozUnlockOrientation():screen.msUnlockOrientation&&screen.msUnlockOrientation()}catch{}}_OnNavigate(t){var e=t.type;if(e==="back")navigator.app&&navigator.app.backHistory?navigator.app.backHistory():window.history.back();else if(e==="forward")window.history.forward();else if(e==="reload")location.reload();else if(e==="url"){e=t.url;const i=t.target;t=t.exportType,self.cordova&&self.cordova.InAppBrowser?self.cordova.InAppBrowser.open(e,"_system"):t==="preview"||this._iRuntime.IsAnyWebView2Wrapper()?window.open(e,"_blank"):this._isConstructArcade||(i===2?window.top.location=e:i===1?window.parent.location=e:window.location=e)}else e==="new-window"&&(e=t.url,t=t.tag,self.cordova&&self.cordova.InAppBrowser?self.cordova.InAppBrowser.open(e,"_system"):window.open(e,t))}_OnRequestFullscreen(t){if(this._iRuntime.IsAnyWebView2Wrapper()||this._exportType==="macos-wkwebview")self.RuntimeInterface._SetWrapperIsFullscreenFlag(!0),this._iRuntime._SendWrapperMessage({type:"set-fullscreen",fullscreen:!0});else{const e={navigationUI:"auto"};t=t.navUI,t===1?e.navigationUI="hide":t===2&&(e.navigationUI="show"),t=document.documentElement;let i;t.requestFullscreen?i=t.requestFullscreen(e):t.mozRequestFullScreen?i=t.mozRequestFullScreen(e):t.msRequestFullscreen?i=t.msRequestFullscreen(e):t.webkitRequestFullScreen&&(i=typeof Element.ALLOW_KEYBOARD_INPUT<"u"?t.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):t.webkitRequestFullScreen()),i instanceof Promise&&i.catch(F)}}_OnExitFullscreen(){if(this._iRuntime.IsAnyWebView2Wrapper()||this._exportType==="macos-wkwebview")self.RuntimeInterface._SetWrapperIsFullscreenFlag(!1),this._iRuntime._SendWrapperMessage({type:"set-fullscreen",fullscreen:!1});else{let t;document.exitFullscreen?t=document.exitFullscreen():document.mozCancelFullScreen?t=document.mozCancelFullScreen():document.msExitFullscreen?t=document.msExitFullscreen():document.webkitCancelFullScreen&&(t=document.webkitCancelFullScreen()),t instanceof Promise&&t.catch(F)}}_OnSetHash(t){location.hash=t.hash}_OnHashChange(){this.PostToRuntime("hashchange",{location:location.toString()})}_OnSetDocumentCSSStyle(t){const e=t.prop,i=t.value,s=t.selector;t=t["is-all"];try{const n=se(s,t);for(const o of n)e.startsWith("--")?o.style.setProperty(e,i):o.style[e]=i}catch(n){console.warn("[Browser] Failed to set style: ",n)}}_OnGetDocumentCSSStyle(t){const e=t.prop;t=t.selector;try{const i=document.querySelector(t);return i?{isOk:!0,result:window.getComputedStyle(i).getPropertyValue(e)}:{isOk:!1}}catch(i){return console.warn("[Browser] Failed to get style: ",i),{isOk:!1}}}_OnSetWindowSize(t){window.resizeTo(t.windowWidth,t.windowHeight)}_OnSetWindowPosition(t){window.moveTo(t.windowX,t.windowY)}});self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMHandler{constructor(t){super(t,"touch"),this.AddRuntimeMessageHandler("request-permission",e=>this._OnRequestPermission(e))}async _OnRequestPermission(t){t=t.type;let e=!0;t===0?e=await this._RequestOrientationPermission():t===1&&(e=await this._RequestMotionPermission()),this.PostToRuntime("permission-result",{type:t,result:e})}async _RequestOrientationPermission(){if(!self.DeviceOrientationEvent||!self.DeviceOrientationEvent.requestPermission)return!0;try{return await self.DeviceOrientationEvent.requestPermission()==="granted"}catch(t){return console.warn("[Touch] Failed to request orientation permission: ",t),!1}}async _RequestMotionPermission(){if(!self.DeviceMotionEvent||!self.DeviceMotionEvent.requestPermission)return!0;try{return await self.DeviceMotionEvent.requestPermission()==="granted"}catch(t){return console.warn("[Touch] Failed to request motion permission: ",t),!1}}});const ne=180/Math.PI;self.AudioDOMHandler=class extends self.DOMHandler{constructor(t){super(t,"audio"),this._destinationNode=this._audioContext=null,this._hasAttachedUnblockEvents=this._hasUnblocked=!1,this._unblockFunc=()=>this._UnblockAudioContext(),this._audioBuffers=[],this._audioInstances=[],this._lastAudioInstance=null,this._lastPlayedTags=[],this._loadedAudioUrls=new Set,this._lastTickCount=-1,this._pendingTags=new Map,this._masterVolume=1,this._isSilent=!1,this._timeScaleMode=0,this._timeScale=1,this._gameTime=0,this._panningModel="HRTF",this._distanceModel="inverse",this._refDistance=600,this._maxDistance=1e4,this._rolloffFactor=1,this._lastListenerPos=[0,0,0],this._lastListenerOrientation=[0,0,-1,0,1,0],this._hasAnySoftwareDecodedMusic=this._playMusicAsSound=!1,this._supportsWebMOpus=this._iRuntime.IsAudioFormatSupported("audio/webm; codecs=opus"),this._effects=new Map,this._analysers=new Set,this._hasStartedOfflineRender=this._isPendingPostFxState=!1,this._microphoneTag="",this._microphoneSource=null,self.C3Audio_OnMicrophoneStream=(e,i)=>this._OnMicrophoneStream(e,i),this._destMediaStreamNode=null,self.C3Audio_GetOutputStream=()=>this._OnGetOutputStream(),self.C3Audio_DOMInterface=this,this.AddRuntimeMessageHandlers([["create-audio-context",e=>this._CreateAudioContext(e)],["play",e=>this._Play(e)],["stop",e=>this._Stop(e)],["stop-all",()=>this._StopAll()],["set-paused",e=>this._SetPaused(e)],["set-volume",e=>this._SetVolume(e)],["fade-volume",e=>this._FadeVolume(e)],["set-master-volume",e=>this._SetMasterVolume(e)],["set-muted",e=>this._SetMuted(e)],["set-silent",e=>this._SetSilent(e)],["set-looping",e=>this._SetLooping(e)],["set-playback-rate",e=>this._SetPlaybackRate(e)],["set-stereo-pan",e=>this._SetStereoPan(e)],["seek",e=>this._Seek(e)],["preload",e=>this._Preload(e)],["unload",e=>this._Unload(e)],["unload-all",()=>this._UnloadAll()],["set-suspended",e=>this._SetSuspended(e)],["add-effect",e=>this._AddEffect(e)],["set-effect-param",e=>this._SetEffectParam(e)],["remove-effects",e=>this._RemoveEffects(e)],["tick",e=>this._OnTick(e)],["load-state",e=>this._OnLoadState(e)],["offline-render-audio",e=>this._OnOfflineRenderAudio(e)],["offline-render-finish",()=>this._OnOfflineRenderFinish()]])}async _CreateAudioContext(t){if((t.isiOSCordova||t.isSafari)&&(this._playMusicAsSound=!0),this._timeScaleMode=t.timeScaleMode,this._panningModel=["equalpower","HRTF","soundfield"][t.panningModel],this._distanceModel=["linear","inverse","exponential"][t.distanceModel],this._refDistance=t.refDistance,this._maxDistance=t.maxDistance,this._rolloffFactor=t.rolloffFactor,this._iRuntime.IsExportingToVideo())this._playMusicAsSound=!0,this._audioContext=new OfflineAudioContext({numberOfChannels:2,sampleRate:48e3,length:Math.ceil(48e3*this._iRuntime.GetExportToVideoDuration())});else{var e={latencyHint:t.latencyHint};if(this.SupportsWebMOpus()||(e.sampleRate=48e3),typeof AudioContext<"u")this._audioContext=new AudioContext(e);else if(typeof webkitAudioContext<"u")this._audioContext=new webkitAudioContext(e);else throw Error("Web Audio API not supported");this._AttachUnblockEvents(),this._audioContext.onstatechange=()=>{this._audioContext.state!=="running"&&this._AttachUnblockEvents(),this.PostToRuntime("audiocontext-state",{audioContextState:this._audioContext.state})}}this._destinationNode=this._audioContext.createGain(),this._destinationNode.connect(this._audioContext.destination),e=t.listenerPos,this._lastListenerPos[0]=e[0],this._lastListenerPos[1]=e[1],this._lastListenerPos[2]=e[2],this._audioContext.listener.setPosition(e[0],e[1],e[2]),this._audioContext.listener.setOrientation(...this._lastListenerOrientation),self.C3_GetAudioContextCurrentTime=()=>this.GetAudioCurrentTime();try{await Promise.all(t.preloadList.map(i=>this._GetAudioBuffer(i.originalUrl,i.url,i.type,!1)))}catch(i){console.error("[Construct] Preloading sounds failed: ",i)}return{sampleRate:this._audioContext.sampleRate,audioContextState:this._audioContext.state,outputLatency:this._audioContext.outputLatency||0}}_AttachUnblockEvents(){this._hasAttachedUnblockEvents||(this._hasUnblocked=!1,window.addEventListener("pointerup",this._unblockFunc,!0),window.addEventListener("touchend",this._unblockFunc,!0),window.addEventListener("click",this._unblockFunc,!0),window.addEventListener("keydown",this._unblockFunc,!0),this._hasAttachedUnblockEvents=!0)}_DetachUnblockEvents(){this._hasAttachedUnblockEvents&&(this._hasUnblocked=!0,window.removeEventListener("pointerup",this._unblockFunc,!0),window.removeEventListener("touchend",this._unblockFunc,!0),window.removeEventListener("click",this._unblockFunc,!0),window.removeEventListener("keydown",this._unblockFunc,!0),this._hasAttachedUnblockEvents=!1)}_UnblockAudioContext(){if(!this._hasUnblocked){var t=this._audioContext;t.state==="suspended"&&t.resume&&t.resume();var e=t.createBuffer(1,220,22050),i=t.createBufferSource();i.buffer=e,i.connect(t.destination),i.start(0),t.state==="running"&&this._DetachUnblockEvents()}}_MatchTagLists(t,e){for(const i of e){e=!1;for(const s of t)if(self.AudioDOMHandler.EqualsNoCase(s,i)){e=!0;break}if(!e)return!1}return!0}GetAudioContext(){return this._audioContext}GetAudioCurrentTime(){return this._audioContext.currentTime}GetDestinationNode(){return this._destinationNode}GetAudioContextExtern(){return this.GetAudioContext()}GetDestinationNodeExtern(){return this.GetDestinationNode()}GetDestinationForTag(t){return(t=this._effects.get(t.toLowerCase()))?t[0].GetInputNode():this.GetDestinationNode()}AddEffectForTag(t,e){t=t.toLowerCase();let i=this._effects.get(t);i||(i=[],this._effects.set(t,i)),e._SetIndex(i.length),e._SetTag(t),i.push(e),this._ReconnectEffects(t)}_ReconnectEffects(t){t=t.toLowerCase();let e=this.GetDestinationNode();const i=this._effects.get(t);if(i&&i.length){e=i[0].GetInputNode();for(let s=0,n=i.length;s<n;++s){const o=i[s];s+1===n?o.ConnectTo(this.GetDestinationNode()):o.ConnectTo(i[s+1].GetInputNode())}}for(const s of this.audioInstancesByEffectTag(t))s.Reconnect(e);this._microphoneSource&&this._microphoneTag===t&&(this._microphoneSource.disconnect(),this._microphoneSource.connect(e))}GetMasterVolume(){return this._masterVolume}IsSilent(){return this._isSilent}GetTimeScaleMode(){return this._timeScaleMode}GetTimeScale(){return this._timeScale}GetGameTime(){return this._gameTime}IsPlayMusicAsSound(){return this._playMusicAsSound}SupportsWebMOpus(){return this._supportsWebMOpus}_SetHasAnySoftwareDecodedMusic(){this._hasAnySoftwareDecodedMusic=!0}GetPanningModel(){return this._panningModel}GetDistanceModel(){return this._distanceModel}GetReferenceDistance(){return this._refDistance}GetMaxDistance(){return this._maxDistance}GetRolloffFactor(){return this._rolloffFactor}DecodeAudioData(t,e){return e?this._iRuntime._WasmDecodeWebMOpus(t).then(i=>{const s=this._audioContext.createBuffer(1,i.length,48e3);return s.getChannelData(0).set(i),s}):new Promise((i,s)=>{this._audioContext.decodeAudioData(t,i,s)})}TryPlayMedia(t){this._iRuntime.TryPlayMedia(t)}RemovePendingPlay(t){this._iRuntime.RemovePendingPlay(t)}ReleaseInstancesForBuffer(t){let e=0;for(let i=0,s=this._audioInstances.length;i<s;++i){const n=this._audioInstances[i];this._audioInstances[e]=n,n.GetBuffer()===t?n.Release():++e}this._audioInstances.length=e}ReleaseAllMusicBuffers(){let t=0;for(let e=0,i=this._audioBuffers.length;e<i;++e){const s=this._audioBuffers[e];this._audioBuffers[t]=s,s.IsMusic()?s.Release():++t}this._audioBuffers.length=t}*audioInstancesMatchingTags(t){if(0<t.length)for(const e of this._audioInstances)this._MatchTagLists(e.GetTags(),t)&&(yield e);else this._lastAudioInstance&&!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}*audioInstancesByEffectTag(t){if(t)for(const e of this._audioInstances)self.AudioDOMHandler.EqualsNoCase(e.GetEffectTag(),t)&&(yield e);else this._lastAudioInstance&&!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}async _GetAudioBuffer(t,e,i,s,n){for(const o of this._audioBuffers)if(o.GetUrl()===e)return await o.Load(),o;return n?null:(s&&(this._playMusicAsSound||this._hasAnySoftwareDecodedMusic)&&this.ReleaseAllMusicBuffers(),e=self.C3AudioBuffer.Create(this,t,e,i,s),this._audioBuffers.push(e),await e.Load(),this._loadedAudioUrls.has(t)||(this.PostToRuntime("buffer-metadata",{originalUrl:t,duration:e.GetDuration()}),this._loadedAudioUrls.add(t)),e)}async _GetAudioInstance(t,e,i,s,n){for(const o of this._audioInstances)if(o.GetUrl()===e&&(o.CanBeRecycled()||n))return o.SetTags(s),o;return t=(await this._GetAudioBuffer(t,e,i,n)).CreateInstance(s),this._audioInstances.push(t),t}_AddPendingTags(t){t=t.join(" ");let e=this._pendingTags.get(t);if(!e){let i=null;e={pendingCount:0,promise:new Promise(s=>i=s),resolve:i},this._pendingTags.set(t,e)}e.pendingCount++}_RemovePendingTags(t){t=t.join(" ");const e=this._pendingTags.get(t);if(!e)throw Error("expected pending tag");e.pendingCount--,e.pendingCount===0&&(e.resolve(),this._pendingTags.delete(t))}TagsReady(t){return t=(t.length===0?this._lastPlayedTags:t).join(" "),(t=this._pendingTags.get(t))?t.promise:Promise.resolve()}_MaybeStartTicking(){if(0<this._analysers.size)this._StartTicking();else for(const t of this._audioInstances)if(t.IsActive()){this._StartTicking();break}}Tick(){for(var t of this._analysers)t.Tick();t=this.GetAudioCurrentTime();for(var e of this._audioInstances)e.Tick(t);e=this._audioInstances.filter(i=>i.IsActive()).map(i=>i.GetState()),this.PostToRuntime("state",{tickCount:this._lastTickCount,outputLatency:this._audioContext.outputLatency||0,audioInstances:e,analysers:[...this._analysers].map(i=>i.GetData())}),e.length===0&&this._analysers.size===0&&this._StopTicking()}PostTrigger(t,e,i){this.PostToRuntime("trigger",{type:t,tags:e,aiid:i})}async _Play(t){const e=t.originalUrl,i=t.url,s=t.type,n=t.isMusic,o=t.tags,a=t.isLooping,r=t.vol,l=t.pos,d=t.panning,h=t.stereoPan;let u=t.off;0<u&&!t.trueClock&&(this._audioContext.getOutputTimestamp?(t=this._audioContext.getOutputTimestamp(),u=u-t.performanceTime/1e3+t.contextTime):u=u-performance.now()/1e3+this._audioContext.currentTime),this._lastPlayedTags=o.slice(0),this._AddPendingTags(o);try{this._lastAudioInstance=await this._GetAudioInstance(e,i,s,o,n),d?(this._lastAudioInstance.SetPannerEnabled(!0),this._lastAudioInstance.SetPan(d.x,d.y,d.z,d.angle,d.innerAngle,d.outerAngle,d.outerGain),d.hasOwnProperty("uid")&&this._lastAudioInstance.SetUID(d.uid)):typeof h=="number"&&h!==0?(this._lastAudioInstance.SetStereoPannerEnabled(!0),this._lastAudioInstance.SetStereoPan(h)):(this._lastAudioInstance.SetPannerEnabled(!1),this._lastAudioInstance.SetStereoPannerEnabled(!1)),this._lastAudioInstance.Play(a,r,l,u)}catch(_){console.error("[Construct] Audio: error starting playback: ",_);return}finally{this._RemovePendingTags(o)}this._StartTicking()}_Stop(t){t=t.tags;for(const e of this.audioInstancesMatchingTags(t))e.Stop()}_StopAll(){for(const t of this._audioInstances)t.Stop()}_SetPaused(t){const e=t.tags;t=t.paused;for(const i of this.audioInstancesMatchingTags(e))t?i.Pause():i.Resume();this._MaybeStartTicking()}_SetVolume(t){const e=t.tags;t=t.vol;for(const i of this.audioInstancesMatchingTags(e))i.SetVolume(t)}_SetStereoPan(t){const e=t.tags;t=t.p;for(const i of this.audioInstancesMatchingTags(e))i.SetStereoPannerEnabled(!0),i.SetStereoPan(t)}async _FadeVolume(t){const e=t.tags,i=t.vol,s=t.duration;t=t.stopOnEnd,await this.TagsReady(e);for(const n of this.audioInstancesMatchingTags(e))n.FadeVolume(i,s,t);this._MaybeStartTicking()}_SetMasterVolume(t){this._masterVolume=t.vol,this._destinationNode.gain.value=this._masterVolume}_SetMuted(t){const e=t.tags;t=t.isMuted;for(const i of this.audioInstancesMatchingTags(e))i.SetMuted(t)}_SetSilent(t){this._isSilent=t.isSilent,this._iRuntime.SetSilent(this._isSilent);for(const e of this._audioInstances)e._UpdateMuted()}_SetLooping(t){const e=t.tags;t=t.isLooping;for(const i of this.audioInstancesMatchingTags(e))i.SetLooping(t)}async _SetPlaybackRate(t){const e=t.tags;t=t.rate,await this.TagsReady(e);for(const i of this.audioInstancesMatchingTags(e))i.SetPlaybackRate(t)}async _Seek(t){const e=t.tags;t=t.pos,await this.TagsReady(e);for(const i of this.audioInstancesMatchingTags(e))i.Seek(t)}async _Preload(t){const e=t.originalUrl,i=t.url,s=t.type;t=t.isMusic;try{await this._GetAudioInstance(e,i,s,"",t)}catch(n){console.error("[Construct] Audio: error preloading: ",n)}}async _Unload(t){(t=await this._GetAudioBuffer("",t.url,t.type,t.isMusic,!0))&&(t.Release(),t=this._audioBuffers.indexOf(t),t!==-1&&this._audioBuffers.splice(t,1))}_UnloadAll(){for(const t of this._audioBuffers)t.Release();this._audioBuffers.length=0}_SetSuspended(t){t=t.isSuspended,!t&&this._audioContext.resume&&this._audioContext.resume();for(const e of this._audioInstances)e.SetSuspended(t);t&&this._audioContext.suspend&&this._audioContext.suspend()}_OnTick(t){if(this._timeScale=t.timeScale,this._gameTime=t.gameTime,this._lastTickCount=t.tickCount,this._timeScaleMode!==0)for(var e of this._audioInstances)e._UpdatePlaybackRate();if(!(e=t.listenerPos)||this._lastListenerPos[0]===e[0]&&this._lastListenerPos[1]===e[1]&&this._lastListenerPos[2]===e[2]||(this._lastListenerPos[0]=e[0],this._lastListenerPos[1]=e[1],this._lastListenerPos[2]=e[2],this._audioContext.listener.setPosition(e[0],e[1],e[2])),(e=t.listenerOrientation)&&(this._lastListenerOrientation[0]!==e[0]||this._lastListenerOrientation[1]!==e[1]||this._lastListenerOrientation[2]!==e[2]||this._lastListenerOrientation[3]!==e[3]||this._lastListenerOrientation[4]!==e[4]||this._lastListenerOrientation[5]!==e[5])){for(let i=0;6>i;++i)this._lastListenerOrientation[i]=e[i];this._audioContext.listener.setOrientation(...this._lastListenerOrientation)}for(const i of t.instPans){t=i.uid;for(const s of this._audioInstances)s.GetUID()===t&&s.SetPanXYZA(i.x,i.y,i.z,i.angle)}}async _AddEffect(t){const e=t.type;var i=t.hasOwnProperty("tags")?t.tags:[t.tag];const s=t.params;let n;if(e==="convolution")try{n=await this._GetAudioBuffer(t.bufferOriginalUrl,t.bufferUrl,t.bufferType,!1)}catch(o){console.log("[Construct] Audio: error loading convolution: ",o);return}for(const o of i){if(e==="filter")i=new self.C3AudioFilterFX(this,...s);else if(e==="delay")i=new self.C3AudioDelayFX(this,...s);else if(e==="convolution")i=new self.C3AudioConvolveFX(this,n.GetAudioBuffer(),...s),i._SetBufferInfo(t.bufferOriginalUrl,t.bufferUrl,t.bufferType);else if(e==="flanger")i=new self.C3AudioFlangerFX(this,...s);else if(e==="phaser")i=new self.C3AudioPhaserFX(this,...s);else if(e==="gain")i=new self.C3AudioGainFX(this,...s);else if(e==="stereopan")i=new self.C3AudioStereoPanFX(this,...s);else if(e==="tremolo")i=new self.C3AudioTremoloFX(this,...s);else if(e==="ringmod")i=new self.C3AudioRingModFX(this,...s);else if(e==="distortion")i=new self.C3AudioDistortionFX(this,...s);else if(e==="compressor")i=new self.C3AudioCompressorFX(this,...s);else if(e==="analyser")i=new self.C3AudioAnalyserFX(this,...s);else throw Error("invalid effect type");this.AddEffectForTag(o,i)}this._PostUpdatedFxState()}_SetEffectParam(t){var e=t.tags;const i=t.index,s=t.param,n=t.value,o=t.ramp;t=t.time;for(const a of e)e=this._effects.get(a.toLowerCase()),!e||0>i||i>=e.length||e[i].SetParam(s,n,o,t);this._PostUpdatedFxState()}_RemoveEffects(t){t=t.tags;for(const e of t){t=e.toLowerCase();const i=this._effects.get(t);if(!i||!i.length)break;for(const s of i)s.Release();this._effects.delete(t),this._ReconnectEffects(t)}}_AddAnalyser(t){this._analysers.add(t),this._MaybeStartTicking()}_RemoveAnalyser(t){this._analysers.delete(t)}_PostUpdatedFxState(){this._isPendingPostFxState||(this._isPendingPostFxState=!0,Promise.resolve().then(()=>this._DoPostUpdatedFxState()))}_DoPostUpdatedFxState(){const t={};for(const[e,i]of this._effects)t[e]=i.map(s=>s.GetState());this.PostToRuntime("fxstate",{fxstate:t}),this._isPendingPostFxState=!1}async _OnLoadState(t){const e=t.saveLoadMode;if(e!==3){var i=[];for(var s of this._audioInstances)s.IsMusic()&&e===1||!s.IsMusic()&&e===2?i.push(s):s.Release();this._audioInstances=i}for(const n of this._effects.values())for(const o of n)o.Release();if(this._effects.clear(),this._timeScale=t.timeScale,this._gameTime=t.gameTime,i=t.listenerPos,this._lastListenerPos[0]=i[0],this._lastListenerPos[1]=i[1],this._lastListenerPos[2]=i[2],this._audioContext.listener.setPosition(i[0],i[1],i[2]),i=t.listenerOrientation,Array.isArray(i)){for(s=0;6>s;++s)this._lastListenerOrientation[s]=i[s];this._audioContext.listener.setOrientation(...this._lastListenerOrientation)}this._isSilent=t.isSilent,this._iRuntime.SetSilent(this._isSilent),this._masterVolume=t.masterVolume,this._destinationNode.gain.value=this._masterVolume,i=[];for(const n of Object.values(t.effects))i.push(Promise.all(n.map(o=>this._AddEffect(o))));await Promise.all(i),await Promise.all(t.playing.map(n=>this._LoadAudioInstance(n,e))),this._MaybeStartTicking()}async _LoadAudioInstance(t,e){if(e!==3){var i=t.bufferOriginalUrl,s=t.bufferUrl,n=t.bufferType,o=t.isMusic,a=t.tags,r=t.isLooping,l=t.volume,d=t.playbackTime;if((!o||e!==1)&&(o||e!==2)){e=null;try{e=await this._GetAudioInstance(i,s,n,a,o)}catch(h){console.error("[Construct] Audio: error loading audio state: ",h);return}e.LoadPanState(t.pan),e.LoadStereoPanState(t.stereoPan),e.Play(r,l,d,0),t.isPlaying||e.Pause(),e._LoadAdditionalState(t)}}}_OnMicrophoneStream(t,e){this._microphoneSource&&this._microphoneSource.disconnect(),this._microphoneTag=e.toLowerCase(),this._microphoneSource=this._audioContext.createMediaStreamSource(t),this._microphoneSource.connect(this.GetDestinationForTag(this._microphoneTag))}_OnGetOutputStream(){return this._destMediaStreamNode||(this._destMediaStreamNode=this._audioContext.createMediaStreamDestination(),this._destinationNode.connect(this._destMediaStreamNode)),this._destMediaStreamNode.stream}async _OnOfflineRenderAudio(t){try{const e=this._audioContext.suspend(t.time);this._hasStartedOfflineRender?this._audioContext.resume():(this._audioContext.startRendering().then(i=>this._OnOfflineRenderCompleted(i)).catch(i=>this._OnOfflineRenderError(i)),this._hasStartedOfflineRender=!0),await e}catch(e){this._OnOfflineRenderError(e)}}_OnOfflineRenderFinish(){this._audioContext.resume()}_OnOfflineRenderCompleted(t){const e=[];for(let i=0,s=t.numberOfChannels;i<s;++i){const n=t.getChannelData(i);e.push(n.buffer)}this._iRuntime.PostToRuntimeComponent("runtime","offline-audio-render-completed",{duration:t.duration,length:t.length,numberOfChannels:t.numberOfChannels,sampleRate:t.sampleRate,channelData:e},null,e)}_OnOfflineRenderError(t){console.error("[Audio] Offline rendering error: ",t)}static EqualsNoCase(t,e){return t===e||t.normalize().toLowerCase()===e.normalize().toLowerCase()}static ToDegrees(t){return t*ne}static DbToLinearNoCap(t){return Math.pow(10,t/20)}static DbToLinear(t){return Math.max(Math.min(self.AudioDOMHandler.DbToLinearNoCap(t),1),0)}static LinearToDbNoCap(t){return Math.log(t)/Math.log(10)*20}static LinearToDb(t){return self.AudioDOMHandler.LinearToDbNoCap(Math.max(Math.min(t,1),0))}static e4(t,e){return 1-Math.exp(-e*t)}};self.RuntimeInterface.AddDOMHandlerClass(self.AudioDOMHandler);self.C3AudioBuffer=class{constructor(t,e,i,s,n){this._audioDomHandler=t,this._originalUrl=e,this._url=i,this._type=s,this._isMusic=n,this._api="",this._loadState="not-loaded",this._loadPromise=null}Release(){this._loadState="not-loaded",this._loadPromise=this._audioDomHandler=null}static Create(t,e,i,s,n){const o=s==="audio/webm; codecs=opus"&&!t.SupportsWebMOpus();return n&&o&&t._SetHasAnySoftwareDecodedMusic(),!n||t.IsPlayMusicAsSound()||o?new self.C3WebAudioBuffer(t,e,i,s,n,o):new self.C3Html5AudioBuffer(t,e,i,s,n)}CreateInstance(t){return this._api==="html5"?new self.C3Html5AudioInstance(this._audioDomHandler,this,t):new self.C3WebAudioInstance(this._audioDomHandler,this,t)}_Load(){}Load(){return this._loadPromise||(this._loadPromise=this._Load()),this._loadPromise}IsLoaded(){}IsLoadedAndDecoded(){}HasFailedToLoad(){return this._loadState==="failed"}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetApi(){return this._api}GetOriginalUrl(){return this._originalUrl}GetUrl(){return this._url}GetContentType(){return this._type}IsMusic(){return this._isMusic}GetDuration(){}};self.C3Html5AudioBuffer=class extends self.C3AudioBuffer{constructor(t,e,i,s,n){super(t,e,i,s,n),this._api="html5",this._audioElem=new Audio,this._audioElem.crossOrigin="anonymous",this._audioElem.autoplay=!1,this._audioElem.preload="auto",this._loadReject=this._loadResolve=null,this._reachedCanPlayThrough=!1,this._audioElem.addEventListener("canplaythrough",()=>this._reachedCanPlayThrough=!0),this._outNode=this.GetAudioContext().createGain(),this._mediaSourceNode=null,this._audioElem.addEventListener("canplay",()=>{this._loadResolve&&(this._loadState="loaded",this._loadResolve(),this._loadReject=this._loadResolve=null),!this._mediaSourceNode&&this._audioElem&&(this._mediaSourceNode=this.GetAudioContext().createMediaElementSource(this._audioElem),this._mediaSourceNode.connect(this._outNode))}),this.onended=null,this._audioElem.addEventListener("ended",()=>{this.onended&&this.onended()}),this._audioElem.addEventListener("error",o=>this._OnError(o))}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._outNode.disconnect(),this._outNode=null,this._mediaSourceNode.disconnect(),this._mediaSourceNode=null,this._audioElem&&!this._audioElem.paused&&this._audioElem.pause(),this._audioElem=this.onended=null,super.Release()}_Load(){return this._loadState="loading",new Promise((t,e)=>{this._loadResolve=t,this._loadReject=e,this._audioElem.src=this._url})}_OnError(t){console.error(`[Construct] Audio '${this._url}' error: `,t),this._loadReject&&(this._loadState="failed",this._loadReject(t),this._loadReject=this._loadResolve=null)}IsLoaded(){const t=4<=this._audioElem.readyState;return t&&(this._reachedCanPlayThrough=!0),t||this._reachedCanPlayThrough}IsLoadedAndDecoded(){return this.IsLoaded()}GetAudioElement(){return this._audioElem}GetOutputNode(){return this._outNode}GetDuration(){return this._audioElem.duration}};self.C3WebAudioBuffer=class extends self.C3AudioBuffer{constructor(t,e,i,s,n,o){super(t,e,i,s,n),this._api="webaudio",this._audioBuffer=this._audioData=null,this._needsSoftwareDecode=!!o}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._audioBuffer=this._audioData=null,super.Release()}async _Fetch(){if(this._audioData)return this._audioData;var t=this._audioDomHandler.GetRuntimeInterface();if(t.GetExportType()==="cordova"&&t.IsRelativeURL(this._url)&&t.IsFileProtocol())this._audioData=await t.CordovaFetchLocalFileAsArrayBuffer(this._url);else{if(t=await fetch(this._url),!t.ok)throw Error(`error fetching audio data: ${t.status} ${t.statusText}`);this._audioData=await t.arrayBuffer()}}async _Decode(){if(this._audioBuffer)return this._audioBuffer;this._audioBuffer=await this._audioDomHandler.DecodeAudioData(this._audioData,this._needsSoftwareDecode),this._audioData=null}async _Load(){try{this._loadState="loading",await this._Fetch(),await this._Decode(),this._loadState="loaded"}catch(t){this._loadState="failed",console.error(`[Construct] Failed to load audio '${this._url}': `,t)}}IsLoaded(){return!(!this._audioData&&!this._audioBuffer)}IsLoadedAndDecoded(){return!!this._audioBuffer}GetAudioBuffer(){return this._audioBuffer}GetDuration(){return this._audioBuffer?this._audioBuffer.duration:0}};let oe=0;self.C3AudioInstance=class{constructor(t,e,i){this._audioDomHandler=t,this._buffer=e,this._tags=i,this._aiId=oe++,this._gainNode=this.GetAudioContext().createGain(),this._gainNode.connect(this.GetDestinationNode()),this._pannerNode=null,this._isPannerEnabled=!1,this._pannerPosition=[0,0,0],this._pannerOrientation=[0,0,0],this._pannerConeParams=[0,0,0],this._stereoPannerNode=null,this._isStereoPannerEnabled=!1,this._stereoPan=0,this._isStopped=!0,this._isLooping=this._resumeMe=this._isPaused=!1,this._volume=1,this._isMuted=!1,this._playbackRate=1,t=this._audioDomHandler.GetTimeScaleMode(),this._isTimescaled=t===1&&!this.IsMusic()||t===2,this._fadeEndTime=this._instUid=-1,this._stopOnFadeEnd=!1}Release(){this._buffer=this._audioDomHandler=null,this._pannerNode&&(this._pannerNode.disconnect(),this._pannerNode=null),this._stereoPannerNode&&(this._stereoPannerNode.disconnect(),this._stereoPannerNode=null),this._gainNode.disconnect(),this._gainNode=null}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}SetTags(t){this._tags=t}GetTags(){return this._tags}GetEffectTag(){return 0<this._tags.length?this._tags[0]:""}GetDestinationNode(){return this._audioDomHandler.GetDestinationForTag(this.GetEffectTag())}GetCurrentTime(){return this._isTimescaled?this._audioDomHandler.GetGameTime():performance.now()/1e3}GetOriginalUrl(){return this._buffer.GetOriginalUrl()}GetUrl(){return this._buffer.GetUrl()}GetContentType(){return this._buffer.GetContentType()}GetBuffer(){return this._buffer}IsMusic(){return this._buffer.IsMusic()}GetAiId(){return this._aiId}HasEnded(){}CanBeRecycled(){}IsPlaying(){return!this._isStopped&&!this._isPaused&&!this.HasEnded()}IsActive(){return!this._isStopped&&!this.HasEnded()}GetPlaybackTime(){}GetDuration(t){let e=this._buffer.GetDuration();return t&&(e/=this._playbackRate||.001),e}Play(t,e,i,s){}Stop(){}Pause(){}IsPaused(){return this._isPaused}Resume(){}SetVolume(t){this._volume=t,this._gainNode.gain.cancelScheduledValues(0),this._fadeEndTime=-1,this._gainNode.gain.value=this.GetOutputVolume()}FadeVolume(t,e,i){if(!this.IsMuted()){var s=this._gainNode.gain;s.cancelScheduledValues(0);var n=this._audioDomHandler.GetAudioCurrentTime();e=n+e,s.setValueAtTime(s.value,n),s.linearRampToValueAtTime(t,e),this._volume=t,this._fadeEndTime=e,this._stopOnFadeEnd=i}}_UpdateVolume(){this.SetVolume(this._volume)}Tick(t){this._fadeEndTime!==-1&&t>=this._fadeEndTime&&(this._fadeEndTime=-1,this._stopOnFadeEnd&&this.Stop(),this._audioDomHandler.PostTrigger("fade-ended",this._tags,this._aiId))}GetOutputVolume(){const t=this._volume;return isFinite(t)?t:0}SetMuted(t){t=!!t,this._isMuted!==t&&(this._isMuted=t,this._UpdateMuted())}IsMuted(){return this._isMuted}IsSilent(){return this._audioDomHandler.IsSilent()}_UpdateMuted(){}SetLooping(t){}IsLooping(){return this._isLooping}SetPlaybackRate(t){this._playbackRate!==t&&(this._playbackRate=t,this._UpdatePlaybackRate())}_UpdatePlaybackRate(){}GetPlaybackRate(){return this._playbackRate}Seek(t){}SetSuspended(t){}SetPannerEnabled(t){t=!!t,this._isPannerEnabled!==t&&((this._isPannerEnabled=t)?(this.SetStereoPannerEnabled(!1),this._pannerNode||(this._pannerNode=this.GetAudioContext().createPanner(),this._pannerNode.panningModel=this._audioDomHandler.GetPanningModel(),this._pannerNode.distanceModel=this._audioDomHandler.GetDistanceModel(),this._pannerNode.refDistance=this._audioDomHandler.GetReferenceDistance(),this._pannerNode.maxDistance=this._audioDomHandler.GetMaxDistance(),this._pannerNode.rolloffFactor=this._audioDomHandler.GetRolloffFactor()),this._gainNode.disconnect(),this._gainNode.connect(this._pannerNode),this._pannerNode.connect(this.GetDestinationNode())):(this._pannerNode.disconnect(),this._gainNode.disconnect(),this._gainNode.connect(this.GetDestinationNode())))}SetPan(t,e,i,s,n,o,a){this._isPannerEnabled&&(this.SetPanXYZA(t,e,i,s),t=self.AudioDOMHandler.ToDegrees,this._pannerConeParams[0]!==t(n)&&(this._pannerConeParams[0]=t(n),this._pannerNode.coneInnerAngle=t(n)),this._pannerConeParams[1]!==t(o)&&(this._pannerConeParams[1]=t(o),this._pannerNode.coneOuterAngle=t(o)),this._pannerConeParams[2]!==a&&(this._pannerConeParams[2]=a,this._pannerNode.coneOuterGain=a))}SetPanXYZA(t,e,i,s){if(this._isPannerEnabled){var n=this._pannerPosition,o=this._pannerOrientation,a=Math.cos(s);s=Math.sin(s),(n[0]!==t||n[1]!==e||n[2]!==i)&&(n[0]=t,n[1]=e,n[2]=i,this._pannerNode.setPosition(...n)),(o[0]!==a||o[1]!==s||o[2]!==0)&&(o[0]=a,o[1]=s,o[2]=0,this._pannerNode.setOrientation(...o))}}SetStereoPannerEnabled(t){t=!!t,this._isStereoPannerEnabled!==t&&((this._isStereoPannerEnabled=t)?(this.SetPannerEnabled(!1),this._stereoPannerNode=this.GetAudioContext().createStereoPanner(),this._gainNode.disconnect(),this._gainNode.connect(this._stereoPannerNode),this._stereoPannerNode.connect(this.GetDestinationNode())):(this._stereoPannerNode.disconnect(),this._stereoPannerNode=null,this._gainNode.disconnect(),this._gainNode.connect(this.GetDestinationNode())))}SetStereoPan(t){this._isStereoPannerEnabled&&this._stereoPan!==t&&(this._stereoPan=this._stereoPannerNode.pan.value=t)}SetUID(t){this._instUid=t}GetUID(){return this._instUid}GetResumePosition(){}Reconnect(t){const e=this._stereoPannerNode||this._pannerNode||this._gainNode;e.disconnect(),e.connect(t)}GetState(){return{aiid:this.GetAiId(),tags:this._tags,duration:this.GetDuration(),volume:this._fadeEndTime===-1?this._volume:this._gainNode.gain.value,isPlaying:this.IsPlaying(),playbackTime:this.GetPlaybackTime(),playbackRate:this.GetPlaybackRate(),uid:this._instUid,bufferOriginalUrl:this.GetOriginalUrl(),bufferUrl:"",bufferType:this.GetContentType(),isMusic:this.IsMusic(),isLooping:this.IsLooping(),isMuted:this.IsMuted(),resumePosition:this.GetResumePosition(),pan:this.GetPanState(),stereoPan:this.GetStereoPanState()}}_LoadAdditionalState(t){this.SetPlaybackRate(t.playbackRate),this.SetMuted(t.isMuted)}GetPanState(){if(!this._pannerNode)return null;const t=this._pannerNode;return{pos:this._pannerPosition,orient:this._pannerOrientation,cia:t.coneInnerAngle,coa:t.coneOuterAngle,cog:t.coneOuterGain,uid:this._instUid}}LoadPanState(t){if(t){this.SetPannerEnabled(!0);var e=this._pannerNode,i=t.pos;this._pannerPosition[0]=i[0],this._pannerPosition[1]=i[1],this._pannerPosition[2]=i[2],i=t.orient,this._pannerOrientation[0]=i[0],this._pannerOrientation[1]=i[1],this._pannerOrientation[2]=i[2],e.setPosition(...this._pannerPosition),e.setOrientation(...this._pannerOrientation),this._pannerConeParams[0]=t.cia,this._pannerConeParams[1]=t.coa,this._pannerConeParams[2]=t.cog,e.coneInnerAngle=t.cia,e.coneOuterAngle=t.coa,e.coneOuterGain=t.cog,this._instUid=t.uid}else this.SetPannerEnabled(!1)}GetStereoPanState(){return this._stereoPannerNode?this._stereoPan:null}LoadStereoPanState(t){typeof t!="number"?this.SetStereoPannerEnabled(!1):(this.SetStereoPannerEnabled(!0),this.SetStereoPan(t))}};self.C3Html5AudioInstance=class extends self.C3AudioInstance{constructor(t,e,i){super(t,e,i),this._buffer.GetOutputNode().connect(this._gainNode),this._buffer.onended=()=>this._OnEnded()}Release(){this.Stop(),this._buffer.GetOutputNode().disconnect(),super.Release()}GetAudioElement(){return this._buffer.GetAudioElement()}_OnEnded(){this._isStopped=!0,this._instUid=-1,this._audioDomHandler.PostTrigger("ended",this._tags,this._aiId)}HasEnded(){return this.GetAudioElement().ended}CanBeRecycled(){return this._isStopped?!0:this.HasEnded()}GetPlaybackTime(){let t=this.GetAudioElement().currentTime;return this._isLooping||(t=Math.min(t,this.GetDuration())),t}Play(t,e,i,s){if(s=this.GetAudioElement(),s.playbackRate!==1&&(s.playbackRate=1),s.loop!==t&&(s.loop=t),this.SetVolume(e),this._isMuted=!1,s.muted&&(s.muted=!1),s.currentTime!==i)try{s.currentTime=i}catch(n){console.warn(`[Construct] Exception seeking audio '${this._buffer.GetUrl()}' to position '${i}': `,n)}this._audioDomHandler.TryPlayMedia(s),this._isPaused=this._isStopped=!1,this._isLooping=t,this._playbackRate=1}Stop(){const t=this.GetAudioElement();t.paused||t.pause(),this._audioDomHandler.RemovePendingPlay(t),this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){if(!(this._isPaused||this._isStopped||this.HasEnded())){var t=this.GetAudioElement();t.paused||t.pause(),this._audioDomHandler.RemovePendingPlay(t),this._isPaused=!0}}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._isPaused=!1)}_UpdateMuted(){this.GetAudioElement().muted=this._isMuted||this.IsSilent()}SetLooping(t){t=!!t,this._isLooping!==t&&(this._isLooping=t,this.GetAudioElement().loop=t)}_UpdatePlaybackRate(){let t=this._playbackRate;this._isTimescaled&&(t*=this._audioDomHandler.GetTimeScale());try{this.GetAudioElement().playbackRate=t}catch(e){console.warn(`[Construct] Unable to set playback rate '${t}':`,e)}}Seek(t){if(!this._isStopped&&!this.HasEnded())try{this.GetAudioElement().currentTime=t}catch(e){console.warn(`[Construct] Error seeking audio to '${t}': `,e)}}GetResumePosition(){return this.GetPlaybackTime()}SetSuspended(t){t?this.IsPlaying()?(this.GetAudioElement().pause(),this._resumeMe=!0):this._resumeMe=!1:this._resumeMe&&(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._resumeMe=!1)}};self.C3WebAudioInstance=class extends self.C3AudioInstance{constructor(t,e,i){super(t,e,i),this._bufferSource=null,this._onended_handler=s=>this._OnEnded(s),this._hasPlaybackEnded=!0,this._activeSource=null,this._resumePosition=this._playFromSeekPos=this._playStartTime=0,this._muteVol=1}Release(){this.Stop(),this._ReleaseBufferSource(),this._onended_handler=null,super.Release()}_ReleaseBufferSource(){this._bufferSource&&(this._bufferSource.onended=null,this._bufferSource.disconnect(),this._bufferSource.buffer=null),this._activeSource=this._bufferSource=null}_OnEnded(t){this._isPaused||this._resumeMe||t.target!==this._activeSource||(this._isStopped=this._hasPlaybackEnded=!0,this._instUid=-1,this._ReleaseBufferSource(),this._audioDomHandler.PostTrigger("ended",this._tags,this._aiId))}HasEnded(){return!this._isStopped&&this._bufferSource&&this._bufferSource.loop||this._isPaused?!1:this._hasPlaybackEnded}CanBeRecycled(){return!this._bufferSource||this._isStopped?!0:this.HasEnded()}GetPlaybackTime(){let t;return t=this._isPaused?this._resumePosition:this._playFromSeekPos+(this.GetCurrentTime()-this._playStartTime)*this._playbackRate,this._isLooping||(t=Math.min(t,this.GetDuration())),t}Play(t,e,i,s){this._isMuted=!1,this._muteVol=1,this.SetVolume(e),this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=t,this._bufferSource.start(s,i),this._isPaused=this._isStopped=this._hasPlaybackEnded=!1,this._isLooping=t,this._playbackRate=1,this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=i}Stop(){if(this._bufferSource)try{this._bufferSource.stop(0)}catch{}this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){this._isPaused||this._isStopped||this.HasEnded()||(this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._isPaused=!0,this._bufferSource.stop(0))}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,this._isPaused=!1)}GetOutputVolume(){return super.GetOutputVolume()*this._muteVol}_UpdateMuted(){this._muteVol=this._isMuted||this.IsSilent()?0:1,this._UpdateVolume()}SetLooping(t){t=!!t,this._isLooping!==t&&(this._isLooping=t,this._bufferSource&&(this._bufferSource.loop=t))}_UpdatePlaybackRate(){let t=this._playbackRate;this._isTimescaled&&(t*=this._audioDomHandler.GetTimeScale()),this._bufferSource&&(this._bufferSource.playbackRate.value=t)}Seek(t){this._isStopped||this.HasEnded()||(this._isPaused?this._resumePosition=t:(this.Pause(),this._resumePosition=t,this.Resume()))}GetResumePosition(){return this._resumePosition}SetSuspended(t){t?this.IsPlaying()?(this._resumeMe=!0,this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._bufferSource.stop(0)):this._resumeMe=!1:this._resumeMe&&(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,this._resumeMe=!1)}_LoadAdditionalState(t){super._LoadAdditionalState(t),this._resumePosition=t.resumePosition}};class c{constructor(e){this._audioDomHandler=e,this._audioContext=e.GetAudioContext(),this._index=-1,this._type=this._tag="",this._params=null}Release(){this._audioContext=null}_SetIndex(e){this._index=e}GetIndex(){return this._index}_SetTag(e){this._tag=e}GetTag(){return this._tag}CreateGain(){return this._audioContext.createGain()}GetInputNode(){}ConnectTo(e){}SetAudioParam(e,i,s,n){if(e.cancelScheduledValues(0),n===0)e.value=i;else{var o=this._audioContext.currentTime;switch(n+=o,s){case 0:e.setValueAtTime(i,n);break;case 1:e.setValueAtTime(e.value,o),e.linearRampToValueAtTime(i,n);break;case 2:e.setValueAtTime(e.value,o),e.exponentialRampToValueAtTime(i,n)}}}GetState(){return{type:this._type,tag:this._tag,params:this._params}}}self.C3AudioFilterFX=class extends c{constructor(t,e,i,s,n,o,a){super(t),this._type="filter",this._params=[e,i,s,n,o,a],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=a,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-a,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type=e,this._filterNode.frequency.value=i,this._filterNode.detune.value=s,this._filterNode.Q.value=n,this._filterNode.gain.vlaue=o,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._filterNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(t){this._wetNode.disconnect(),this._wetNode.connect(t),this._dryNode.disconnect(),this._dryNode.connect(t)}GetInputNode(){return this._inputNode}SetParam(t,e,i,s){switch(t){case 0:e=Math.max(Math.min(e/100,1),0),this._params[5]=e,this.SetAudioParam(this._wetNode.gain,e,i,s),this.SetAudioParam(this._dryNode.gain,1-e,i,s);break;case 1:this._params[1]=e,this.SetAudioParam(this._filterNode.frequency,e,i,s);break;case 2:this._params[2]=e,this.SetAudioParam(this._filterNode.detune,e,i,s);break;case 3:this._params[3]=e,this.SetAudioParam(this._filterNode.Q,e,i,s);break;case 4:this._params[4]=e,this.SetAudioParam(this._filterNode.gain,e,i,s)}}};self.C3AudioDelayFX=class extends c{constructor(t,e,i,s){super(t),this._type="delay",this._params=[e,i,s],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=s,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-s,this._mainNode=this.CreateGain(),this._delayNode=this._audioContext.createDelay(e),this._delayNode.delayTime.value=e,this._delayGainNode=this.CreateGain(),this._delayGainNode.gain.value=i,this._inputNode.connect(this._mainNode),this._inputNode.connect(this._dryNode),this._mainNode.connect(this._wetNode),this._mainNode.connect(this._delayNode),this._delayNode.connect(this._delayGainNode),this._delayGainNode.connect(this._mainNode)}Release(){this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),this._mainNode.disconnect(),this._delayNode.disconnect(),this._delayGainNode.disconnect(),super.Release()}ConnectTo(t){this._wetNode.disconnect(),this._wetNode.connect(t),this._dryNode.disconnect(),this._dryNode.connect(t)}GetInputNode(){return this._inputNode}SetParam(t,e,i,s){const n=self.AudioDOMHandler.DbToLinear;switch(t){case 0:e=Math.max(Math.min(e/100,1),0),this._params[2]=e,this.SetAudioParam(this._wetNode.gain,e,i,s),this.SetAudioParam(this._dryNode.gain,1-e,i,s);break;case 4:this._params[1]=n(e),this.SetAudioParam(this._delayGainNode.gain,n(e),i,s);break;case 5:this._params[0]=e,this.SetAudioParam(this._delayNode.delayTime,e,i,s)}}};self.C3AudioConvolveFX=class extends c{constructor(t,e,i,s){super(t),this._type="convolution",this._params=[i,s],this._bufferType=this._bufferUrl=this._bufferOriginalUrl="",this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=s,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-s,this._convolveNode=this._audioContext.createConvolver(),this._convolveNode.normalize=i,this._convolveNode.buffer=e,this._inputNode.connect(this._convolveNode),this._inputNode.connect(this._dryNode),this._convolveNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._convolveNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(t){this._wetNode.disconnect(),this._wetNode.connect(t),this._dryNode.disconnect(),this._dryNode.connect(t)}GetInputNode(){return this._inputNode}SetParam(t,e,i,s){switch(t){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._wetNode.gain,e,i,s),this.SetAudioParam(this._dryNode.gain,1-e,i,s)}}_SetBufferInfo(t,e,i){this._bufferOriginalUrl=t,this._bufferUrl=e,this._bufferType=i}GetState(){const t=super.GetState();return t.bufferOriginalUrl=this._bufferOriginalUrl,t.bufferUrl="",t.bufferType=this._bufferType,t}};self.C3AudioFlangerFX=class extends c{constructor(t,e,i,s,n,o){super(t),this._type="flanger",this._params=[e,i,s,n,o],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-o/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=o/2,this._feedbackNode=this.CreateGain(),this._feedbackNode.gain.value=n,this._delayNode=this._audioContext.createDelay(e+i),this._delayNode.delayTime.value=e,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=s,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=i,this._inputNode.connect(this._delayNode),this._inputNode.connect(this._dryNode),this._delayNode.connect(this._wetNode),this._delayNode.connect(this._feedbackNode),this._feedbackNode.connect(this._delayNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._delayNode.delayTime),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._delayNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),this._feedbackNode.disconnect(),super.Release()}ConnectTo(t){this._wetNode.disconnect(),this._wetNode.connect(t),this._dryNode.disconnect(),this._dryNode.connect(t)}GetInputNode(){return this._inputNode}SetParam(t,e,i,s){switch(t){case 0:e=Math.max(Math.min(e/100,1),0),this._params[4]=e,this.SetAudioParam(this._wetNode.gain,e/2,i,s),this.SetAudioParam(this._dryNode.gain,1-e/2,i,s);break;case 6:this._params[1]=e/1e3,this.SetAudioParam(this._oscGainNode.gain,e/1e3,i,s);break;case 7:this._params[2]=e,this.SetAudioParam(this._oscNode.frequency,e,i,s);break;case 8:this._params[3]=e/100,this.SetAudioParam(this._feedbackNode.gain,e/100,i,s)}}};self.C3AudioPhaserFX=class extends c{constructor(t,e,i,s,n,o,a){super(t),this._type="phaser",this._params=[e,i,s,n,o,a],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-a/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=a/2,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type="allpass",this._filterNode.frequency.value=e,this._filterNode.detune.value=i,this._filterNode.Q.value=s,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=o,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=n,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._filterNode.frequency),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._filterNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),super.Release()}ConnectTo(t){this._wetNode.disconnect(),this._wetNode.connect(t),this._dryNode.disconnect(),this._dryNode.connect(t)}GetInputNode(){return this._inputNode}SetParam(t,e,i,s){switch(t){case 0:e=Math.max(Math.min(e/100,1),0),this._params[5]=e,this.SetAudioParam(this._wetNode.gain,e/2,i,s),this.SetAudioParam(this._dryNode.gain,1-e/2,i,s);break;case 1:this._params[0]=e,this.SetAudioParam(this._filterNode.frequency,e,i,s);break;case 2:this._params[1]=e,this.SetAudioParam(this._filterNode.detune,e,i,s);break;case 3:this._params[2]=e,this.SetAudioParam(this._filterNode.Q,e,i,s);break;case 6:this._params[3]=e,this.SetAudioParam(this._oscGainNode.gain,e,i,s);break;case 7:this._params[4]=e,this.SetAudioParam(this._oscNode.frequency,e,i,s)}}};self.C3AudioGainFX=class extends c{constructor(t,e){super(t),this._type="gain",this._params=[e],this._node=this.CreateGain(),this._node.gain.value=e}Release(){this._node.disconnect(),super.Release()}ConnectTo(t){this._node.disconnect(),this._node.connect(t)}GetInputNode(){return this._node}SetParam(t,e,i,s){const n=self.AudioDOMHandler.DbToLinear;switch(t){case 4:this._params[0]=n(e),this.SetAudioParam(this._node.gain,n(e),i,s)}}};self.C3AudioStereoPanFX=class extends c{constructor(t,e){super(t),this._type="stereopan",this._params=[e],this._node=this._audioContext.createStereoPanner(),this._node.pan.value=e}Release(){this._node.disconnect(),super.Release()}ConnectTo(t){this._node.disconnect(),this._node.connect(t)}GetInputNode(){return this._node}SetParam(t,e,i,s){switch(e=Math.min(Math.max(e/100,-1),1),t){case 9:this._params[0]=e,this.SetAudioParam(this._node.pan,e,i,s)}}};self.C3AudioTremoloFX=class extends c{constructor(t,e,i){super(t),this._type="tremolo",this._params=[e,i],this._node=this.CreateGain(),this._node.gain.value=1-i/2,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=e,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=i/2,this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._node.gain),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._node.disconnect(),super.Release()}ConnectTo(t){this._node.disconnect(),this._node.connect(t)}GetInputNode(){return this._node}SetParam(t,e,i,s){switch(t){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._node.gain,1-e/2,i,s),this.SetAudioParam(this._oscGainNode.gain,e/2,i,s);break;case 7:this._params[0]=e,this.SetAudioParam(this._oscNode.frequency,e,i,s)}}};self.C3AudioRingModFX=class extends c{constructor(t,e,i){super(t),this._type="ringmod",this._params=[e,i],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=i,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-i,this._ringNode=this.CreateGain(),this._ringNode.gain.value=0,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=e,this._oscNode.connect(this._ringNode.gain),this._oscNode.start(0),this._inputNode.connect(this._ringNode),this._inputNode.connect(this._dryNode),this._ringNode.connect(this._wetNode)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._ringNode.disconnect(),this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(t){this._wetNode.disconnect(),this._wetNode.connect(t),this._dryNode.disconnect(),this._dryNode.connect(t)}GetInputNode(){return this._inputNode}SetParam(t,e,i,s){switch(t){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._wetNode.gain,e,i,s),this.SetAudioParam(this._dryNode.gain,1-e,i,s);break;case 7:this._params[0]=e,this.SetAudioParam(this._oscNode.frequency,e,i,s)}}};self.C3AudioDistortionFX=class extends c{constructor(t,e,i,s,n,o){super(t),this._type="distortion",this._params=[e,i,s,n,o],this._inputNode=this.CreateGain(),this._preGain=this.CreateGain(),this._postGain=this.CreateGain(),this._SetDrive(s,n),this._wetNode=this.CreateGain(),this._wetNode.gain.value=o,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-o,this._waveShaper=this._audioContext.createWaveShaper(),this._curve=new Float32Array(65536),this._GenerateColortouchCurve(e,i),this._waveShaper.curve=this._curve,this._inputNode.connect(this._preGain),this._inputNode.connect(this._dryNode),this._preGain.connect(this._waveShaper),this._waveShaper.connect(this._postGain),this._postGain.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._preGain.disconnect(),this._waveShaper.disconnect(),this._postGain.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}_SetDrive(t,e){.01>t&&(t=.01),this._preGain.gain.value=t,this._postGain.gain.value=Math.pow(1/t,.6)*e}_GenerateColortouchCurve(t,e){for(let i=0;32768>i;++i){let s=i/32768;s=this._Shape(s,t,e),this._curve[32768+i]=s,this._curve[32768-i-1]=-s}}_Shape(t,e,i){i=1.05*i*e-e;const s=0>t?-1:1;return t=0>t?-t:t,(t<e?t:e+i*self.AudioDOMHandler.e4(t-e,1/i))*s}ConnectTo(t){this._wetNode.disconnect(),this._wetNode.connect(t),this._dryNode.disconnect(),this._dryNode.connect(t)}GetInputNode(){return this._inputNode}SetParam(t,e,i,s){switch(t){case 0:e=Math.max(Math.min(e/100,1),0),this._params[4]=e,this.SetAudioParam(this._wetNode.gain,e,i,s),this.SetAudioParam(this._dryNode.gain,1-e,i,s)}}};self.C3AudioCompressorFX=class extends c{constructor(t,e,i,s,n,o){super(t),this._type="compressor",this._params=[e,i,s,n,o],this._node=this._audioContext.createDynamicsCompressor(),this._node.threshold.value=e,this._node.knee.value=i,this._node.ratio.value=s,this._node.attack.value=n,this._node.release.value=o}Release(){this._node.disconnect(),super.Release()}ConnectTo(t){this._node.disconnect(),this._node.connect(t)}GetInputNode(){return this._node}SetParam(t,e,i,s){}};self.C3AudioAnalyserFX=class extends c{constructor(t,e,i){super(t),this._type="analyser",this._params=[e,i],this._node=this._audioContext.createAnalyser(),this._node.fftSize=e,this._node.smoothingTimeConstant=i,this._freqBins=new Float32Array(this._node.frequencyBinCount),this._signal=new Uint8Array(e),this._rms=this._peak=0,this._audioDomHandler._AddAnalyser(this)}Release(){this._audioDomHandler._RemoveAnalyser(this),this._node.disconnect(),super.Release()}Tick(){this._node.getFloatFrequencyData(this._freqBins),this._node.getByteTimeDomainData(this._signal);const t=this._node.fftSize;let e=this._peak=0;for(var i=0;i<t;++i){let s=(this._signal[i]-128)/128;0>s&&(s=-s),this._peak<s&&(this._peak=s),e+=s*s}i=self.AudioDOMHandler.LinearToDb,this._peak=i(this._peak),this._rms=i(Math.sqrt(e/t))}ConnectTo(t){this._node.disconnect(),this._node.connect(t)}GetInputNode(){return this._node}SetParam(t,e,i,s){}GetData(){return{tag:this.GetTag(),index:this.GetIndex(),peak:this._peak,rms:this._rms,binCount:this._node.frequencyBinCount,freqBins:this._freqBins}}};
