import"./B5Qt9EMX.js";{class f{constructor(){this._broadcastChannel=typeof BroadcastChannel>"u"?null:new BroadcastChannel("offline"),this._queuedMessages=[],this._onMessageCallback=null,this._broadcastChannel&&(this._broadcastChannel.onmessage=s=>this._OnBroadcastChannelMessage(s))}_OnBroadcastChannelMessage(s){if(this._onMessageCallback){this._onMessageCallback(s);return}this._queuedMessages.push(s)}SetMessageCallback(s){this._onMessageCallback=s;for(let e of this._queuedMessages)this._onMessageCallback(e);this._queuedMessages.length=0}}window.OfflineClientInfo=new f}window.DOMHandler=class{constructor(l,s){this._iRuntime=l,this._componentId=s,this._hasTickCallback=!1,this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(l,s,e,i){this._iRuntime.PostToRuntimeComponent(this._componentId,l,s,e,i)}PostToRuntimeAsync(l,s,e,i){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,l,s,e,i)}_PostToRuntimeMaybeSync(l,s,e){this._iRuntime.UsesWorker()?this.PostToRuntime(l,s,e):this._iRuntime._GetLocalRuntime()._OnMessageFromDOM({type:"event",component:this._componentId,handler:l,dispatchOpts:e||null,data:s,responseId:null})}AddRuntimeMessageHandler(l,s){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,l,s)}AddRuntimeMessageHandlers(l){for(const[s,e]of l)this.AddRuntimeMessageHandler(s,e)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}},window.RateLimiter=class{constructor(l,s){this._callback=l,this._interval=s,this._timerId=-1,this._lastCallTime=-1/0,this._timerCallFunc=()=>this._OnTimer(),this._ignoreReset=!1,this._canRunImmediate=!1}SetCanRunImmediate(l){this._canRunImmediate=!!l}Call(){if(this._timerId!==-1)return;const l=Date.now(),s=l-this._lastCallTime,e=this._interval;s>=e&&this._canRunImmediate?(this._lastCallTime=l,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(e-s,4))}_RunCallback(){this._ignoreReset=!0,this._callback(),this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._lastCallTime=Date.now())}_OnTimer(){this._timerId=-1,this._lastCallTime=Date.now(),this._RunCallback()}_CancelTimer(){this._timerId!==-1&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer(),this._callback=null,this._timerCallFunc=null}};{class f{constructor(s){this._elem=s,this._hadFirstUpdate=!1,this._isVisibleFlag=!0,this._wantHtmlIndex=-1,this._actualHtmlIndex=-1,this._htmlZIndex=-1}SetVisibleFlag(s){this._isVisibleFlag=!!s}GetVisibleFlag(){return this._isVisibleFlag}HadFirstUpdate(){return this._hadFirstUpdate}SetHadFirstUpdate(){this._hadFirstUpdate=!0}GetWantHTMLIndex(){return this._wantHtmlIndex}SetWantHTMLIndex(s){this._wantHtmlIndex=s}GetActualHTMLIndex(){return this._actualHtmlIndex}SetActualHTMLIndex(s){this._actualHtmlIndex=s}SetHTMLZIndex(s){this._htmlZIndex=s}GetHTMLZIndex(){return this._htmlZIndex}GetElement(){return this._elem}}window.DOMElementHandler=class extends self.DOMHandler{constructor(s,e){super(s,e),this._elementMap=new Map,this._autoAttach=!0,this.AddRuntimeMessageHandlers([["create",i=>this._OnCreate(i)],["destroy",i=>this._OnDestroy(i)],["set-visible",i=>this._OnSetVisible(i)],["update-position",i=>this._OnUpdatePosition(i)],["update-state",i=>this._OnUpdateState(i)],["focus",i=>this._OnSetFocus(i)],["set-css-style",i=>this._OnSetCssStyle(i)],["set-attribute",i=>this._OnSetAttribute(i)],["remove-attribute",i=>this._OnRemoveAttribute(i)]]),this.AddDOMElementMessageHandler("get-element",i=>i)}SetAutoAttach(s){this._autoAttach=!!s}AddDOMElementMessageHandler(s,e){this.AddRuntimeMessageHandler(s,i=>{const n=i.elementId,r=this.GetElementById(n);return e(r,i)})}_OnCreate(s){const e=s.elementId,i=this.CreateElement(e,s),n=new f(i);this._elementMap.set(e,n),i.style.boxSizing="border-box",i.style.display="none",n.SetVisibleFlag(s.isVisible);const r=this._GetFocusElement(i);r.addEventListener("focus",u=>this._OnFocus(e)),r.addEventListener("blur",u=>this._OnBlur(e));const c=s.htmlIndex;if(n.SetWantHTMLIndex(c),n.SetHTMLZIndex(s.htmlZIndex),this._autoAttach){const u=this.GetRuntimeInterface().GetAvailableHTMLIndex(c);n.SetActualHTMLIndex(u),this.GetRuntimeInterface().GetHTMLWrapElement(u).appendChild(i)}}CreateElement(s,e){throw new Error("required override")}DestroyElement(s){}_OnDestroy(s){const e=s.elementId,i=this.GetElementById(e);this.DestroyElement(i),this._autoAttach&&i.parentElement.removeChild(i),this._elementMap.delete(e)}PostToRuntimeElement(s,e,i){i||(i={}),i.elementId=e,this.PostToRuntime(s,i)}_PostToRuntimeElementMaybeSync(s,e,i){i||(i={}),i.elementId=e,this._PostToRuntimeMaybeSync(s,i)}_OnSetVisible(s){if(!this._autoAttach)return;const e=this._elementMap.get(s.elementId),i=e.GetElement();e.HadFirstUpdate()?i.style.display=s.isVisible?"":"none":e.SetVisibleFlag(s.isVisible)}_OnUpdatePosition(s){if(!this._autoAttach)return;const e=this._elementMap.get(s.elementId),i=e.GetElement(),n=this.GetRuntimeInterface();i.style.left=s.left+"px",i.style.top=s.top+"px",i.style.width=s.width+"px",i.style.height=s.height+"px";const r=s.fontSize;r!==null&&(i.style.fontSize=r+"em");const c=s.htmlIndex;e.SetWantHTMLIndex(c);const u=n.GetAvailableHTMLIndex(c);u!==e.GetActualHTMLIndex()&&(i.remove(),n.GetHTMLWrapElement(u).appendChild(i),e.SetActualHTMLIndex(u),n._UpdateHTMLElementsZOrder());const p=s.htmlZIndex;p!==e.GetHTMLZIndex()&&(e.SetHTMLZIndex(p),n._UpdateHTMLElementsZOrder()),e.HadFirstUpdate()||(e.SetHadFirstUpdate(),e.GetVisibleFlag()&&(i.style.display=""))}_OnHTMLLayersChanged(){if(this._autoAttach)for(const s of this._elementMap.values()){const e=this.GetRuntimeInterface().GetAvailableHTMLIndex(s.GetWantHTMLIndex()),i=s.GetActualHTMLIndex();if(e!==-1&&i!==-1&&e!==i){const n=s.GetElement();n.remove(),this.GetRuntimeInterface().GetHTMLWrapElement(e).appendChild(n),s.SetActualHTMLIndex(e)}}}_GetAllElementStatesForZOrderUpdate(){return this._autoAttach?[...this._elementMap.values()]:null}_OnUpdateState(s){const e=this.GetElementById(s.elementId);this.UpdateState(e,s)}UpdateState(s,e){throw new Error("required override")}_GetFocusElement(s){return s}_OnFocus(s){this.PostToRuntimeElement("elem-focused",s)}_OnBlur(s){this.PostToRuntimeElement("elem-blurred",s)}_OnSetFocus(s){const e=this._GetFocusElement(this.GetElementById(s.elementId));s.focus?e.focus():e.blur()}_OnSetCssStyle(s){const e=this.GetElementById(s.elementId),i=s.prop,n=s.val;i.startsWith("--")?e.style.setProperty(i,n):e.style[i]=n}_OnSetAttribute(s){this.GetElementById(s.elementId).setAttribute(s.name,s.val)}_OnRemoveAttribute(s){this.GetElementById(s.elementId).removeAttribute(s.name)}GetElementById(s){const e=this._elementMap.get(s);if(!e)throw new Error(`no element with id ${s}`);return e.GetElement()}}}{let i=function(a){const t=document.createElement("script");return t.async=!1,t.type="module",a.isStringSrc?new Promise(o=>{const d="c3_resolve_"+e;++e,self[d]=o,t.textContent=a.str+`

self["${d}"]();`,document.head.appendChild(t)}):new Promise((o,d)=>{t.onload=o,t.onerror=d,t.src=a,document.head.appendChild(t)})},p=function(a){return new Promise((t,o)=>{const d=new FileReader;d.onload=h=>t(h.target.result),d.onerror=h=>o(h),d.readAsArrayBuffer(a)})},N=function(a){return x.has(a)};const f=/(iphone|ipod|ipad|macos|macintosh|mac os x)/i.test(navigator.userAgent),l=/android/i.test(navigator.userAgent),s=/safari/i.test(navigator.userAgent)&&!/(chrome|chromium|edg\/|OPR\/|nwjs)/i.test(navigator.userAgent);let e=0;async function n(){if(!navigator.userActivation||typeof OffscreenCanvas>"u")return!1;try{const a=`
	self.addEventListener("message", () =>
	{
		try {
			const offscreenCanvas = new OffscreenCanvas(32, 32);
			const gl = offscreenCanvas.getContext("webgl");
			self.postMessage(!!gl);
		}
		catch (err)
		{
			console.warn("Feature detection worker error:", err);
			self.postMessage(false);
		}
	});`;let t=!1;const o=new Blob([a],{type:"text/javascript"}),d=new Worker(URL.createObjectURL(o),{get type(){t=!0}}),h=await new Promise(_=>{d.addEventListener("message",m=>{d.terminate(),_(m.data)}),d.postMessage("")});return t&&h}catch(a){return console.warn("Error feature detecting worker mode: ",a),!1}}let r=new Audio;const c={"audio/webm; codecs=opus":!!r.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!r.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!r.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!r.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!r.canPlayType("audio/mp4"),"audio/mpeg":!!r.canPlayType("audio/mpeg")};r=null;async function u(a){const t=await p(a);return new TextDecoder("utf-8").decode(t)}const T=[];let M=0;const R=8;window.RealFile=window.File;const C=[],A=new Map,E=new Map;let O=0;const k=[];self.runOnStartup=function(t){if(typeof t!="function")throw new Error("runOnStartup called without a function");k.push(t)};const x=new Set(["cordova","playable-ad","instant-games"]);let b=!1;window.RuntimeInterface=class L{constructor(t){if(this._useWorker=t.useWorker,this._messageChannelPort=null,this._runtimeBaseUrl="",this._scriptFolder=t.scriptFolder,this._workerScriptURLs={},this._worker=null,this._localRuntime=null,this._domHandlers=[],this._runtimeDomHandler=null,this._isFirstSizeUpdate=!0,this._canvasLayers=[],this._pendingRemoveElements=[],this._pendingUpdateHTMLZOrder=!1,this._updateHTMLZOrderRAFCallback=()=>this._DoUpdateHTMLElementsZOrder(),this._isExportingToVideo=!1,this._exportToVideoDuration=0,this._jobScheduler=null,this._rafId=-1,this._rafFunc=()=>this._OnRAFCallback(),this._rafCallbacks=new Set,this._wrapperInitResolve=null,this._wrapperComponentIds=[],this._exportType=t.exportType,this._isFileProtocol=location.protocol.substr(0,4)==="file",this._directoryHandles=[],(this._exportType==="playable-ad"||this._exportType==="instant-games")&&(this._useWorker=!1),s&&(this._useWorker=!1),this._exportType==="cordova"&&this._useWorker&&l){const o=/Chrome\/(\d+)/i.exec(navigator.userAgent);(!o||!(parseInt(o[1],10)>=90))&&(this._useWorker=!1)}this.IsAnyWebView2Wrapper()?self.chrome.webview.addEventListener("message",o=>this._OnWrapperMessage(o.data,o.additionalObjects)):this._exportType==="macos-wkwebview"&&(self.C3WrapperOnMessage=o=>this._OnWrapperMessage(o)),this._localFileBlobs=null,this._localFileStrings=null,this._exportType==="html5"&&!window.isSecureContext&&console.warn("[Construct] Warning: the browser indicates this is not a secure context. Some features may be unavailable. Use secure (HTTPS) hosting to ensure all features are available."),this.AddRuntimeComponentMessageHandler("canvas","update-size",o=>this._OnUpdateCanvasSize(o)),this.AddRuntimeComponentMessageHandler("canvas","set-html-layer-count",o=>this._OnSetHTMLLayerCount(o)),this.AddRuntimeComponentMessageHandler("canvas","cleanup-html-layers",()=>this._OnCleanUpHTMLLayers()),this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",o=>this._OnCordovaFetchLocalFile(o)),this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",o=>this._OnCreateJobWorker(o)),this.AddRuntimeComponentMessageHandler("runtime","send-wrapper-extension-message",o=>this._OnSendWrapperExtensionMessage(o)),this._exportType==="cordova"?document.addEventListener("deviceready",()=>this._Init(t)):this._Init(t)}Release(){this._CancelAnimationFrame(),this._messageChannelPort&&(this._messageChannelPort.onmessage=null,this._messageChannelPort=null),this._worker&&(this._worker.terminate(),this._worker=null),this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null);for(const{canvas:t,htmlWrap:o}of this._canvasLayers)t.remove(),o.remove();this._canvasLayers.length=0}GetMainCanvas(){return this._canvasLayers[0].canvas}GetAvailableHTMLIndex(t){return Math.min(t,this._canvasLayers.length-1)}GetHTMLWrapElement(t){if(t<0||t>=this._canvasLayers.length)throw new RangeError("invalid canvas layer");return this._canvasLayers[t].htmlWrap}_GetHTMLWrapElement(t){return this.GetHTMLWrapElement(t)}GetRuntimeBaseURL(){return this._runtimeBaseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsFileProtocol(){return this._isFileProtocol}GetScriptFolder(){return this._scriptFolder}IsiOSCordova(){return f&&this._exportType==="cordova"}IsiOSWebView(){const t=navigator.userAgent;return f&&N(this._exportType)||navigator.standalone||/crios\/|fxios\/|edgios\//i.test(t)}IsAndroid(){return l}IsAndroidWebView(){return l&&N(this._exportType)}IsWindowsWebView2(){return this._exportType==="windows-webview2"||!!(this._exportType==="preview"&&window.chrome&&window.chrome.webview&&window.chrome.webview.postMessage)}IsAnyWebView2Wrapper(){return this.IsWindowsWebView2()||this._exportType==="xbox-uwp-webview2"}async _Init(t){if(this._useWorker&&(await n()||(this._useWorker=!1)),this._exportType==="macos-wkwebview")this._SendWrapperMessage({type:"ready"});else if(this.IsAnyWebView2Wrapper()){this._SetupWebView2Polyfills();const d=await this._InitWrapper();this._wrapperComponentIds=d.registeredComponentIds}if(this._exportType==="playable-ad"){this._localFileBlobs=self.c3_base64files,this._localFileStrings={},await this._ConvertDataUrisToBlobs();for(let d=0,h=t.engineScripts.length;d<h;++d){const _=t.engineScripts[d];this._localFileStrings.hasOwnProperty(_)?t.engineScripts[d]={isStringSrc:!0,str:this._localFileStrings[_]}:this._localFileBlobs.hasOwnProperty(_)&&(t.engineScripts[d]=URL.createObjectURL(this._localFileBlobs[_]))}t.workerDependencyScripts=[]}if(this._exportType==="nwjs"&&self.nw&&self.nw.App.manifest["c3-steam-mode"]){let d=0;this._AddRAFCallback(()=>{d++,document.documentElement.style.opacity=d%2===0?"1":"0.999"})}if(t.runtimeBaseUrl)this._runtimeBaseUrl=t.runtimeBaseUrl;else{const d=location.origin;this._runtimeBaseUrl=(d==="null"?"file:///":d)+location.pathname;const h=this._runtimeBaseUrl.lastIndexOf("/");h!==-1&&(this._runtimeBaseUrl=this._runtimeBaseUrl.substr(0,h+1))}t.workerScripts&&(this._workerScriptURLs=t.workerScripts);const o=new MessageChannel;if(this._messageChannelPort=o.port1,this._messageChannelPort.onmessage=d=>this._OnMessageFromRuntime(d.data),window.c3_addPortMessageHandler&&window.c3_addPortMessageHandler(d=>this._OnMessageFromDebugger(d)),this._jobScheduler=new self.JobSchedulerDOM(this),await this._jobScheduler.Init(),typeof window.StatusBar=="object"&&window.StatusBar.hide(),typeof window.AndroidFullScreen=="object")try{await new Promise((d,h)=>{window.AndroidFullScreen.immersiveMode(d,h)})}catch(d){console.error("Failed to enter Android immersive mode: ",d)}this._useWorker?await this._InitWorker(t,o.port2):await this._InitDOM(t,o.port2)}_GetWorkerURL(t){let o;return this._workerScriptURLs.hasOwnProperty(t)?o=this._workerScriptURLs[t]:t.endsWith("/workermain.js")&&this._workerScriptURLs.hasOwnProperty("workermain.js")?o=this._workerScriptURLs["workermain.js"]:this._exportType==="playable-ad"&&this._localFileBlobs.hasOwnProperty(t)?o=this._localFileBlobs[t]:o=t,o instanceof Blob&&(o=URL.createObjectURL(o)),o}async CreateWorker(t,o,d){if(t.startsWith("blob:"))return new Worker(t,d);if(this._exportType==="cordova"&&this._isFileProtocol){let m="";d.isC3MainWorker?m=t:m=this._scriptFolder+t;const g=await this.CordovaFetchLocalFileAsArrayBuffer(m),y=new Blob([g],{type:"application/javascript"});return new Worker(URL.createObjectURL(y),d)}const h=new URL(t,o);if(location.origin!==h.origin){const m=await fetch(h);if(!m.ok)throw new Error("failed to fetch worker script");const g=await m.blob();return new Worker(URL.createObjectURL(g),d)}else return new Worker(h,d)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}GetCssDisplayMode(){if(this.IsAnyWebView2Wrapper())return"standalone";const t=this.GetExportType();return new Set(["cordova","nwjs","macos-wkwebview"]).has(t)?"standalone":window.matchMedia("(display-mode: fullscreen)").matches?"fullscreen":window.matchMedia("(display-mode: standalone)").matches?"standalone":window.matchMedia("(display-mode: minimal-ui)").matches?"minimal-ui":navigator.standalone?"standalone":"browser"}_GetCommonRuntimeOptions(t){return{runtimeBaseUrl:this._runtimeBaseUrl,previewUrl:location.href,windowInnerWidth:this._GetWindowInnerWidth(),windowInnerHeight:this._GetWindowInnerHeight(),cssDisplayMode:this.GetCssDisplayMode(),devicePixelRatio:window.devicePixelRatio,isFullscreen:L.IsDocumentFullscreen(),projectData:t.projectData,previewImageBlobs:window.cr_previewImageBlobs||this._localFileBlobs,previewProjectFileBlobs:window.cr_previewProjectFileBlobs,previewProjectFileSWUrls:window.cr_previewProjectFiles,swClientId:window.cr_swClientId||"",exportType:t.exportType,isDebug:new URLSearchParams(self.location.search).has("debug"),ife:!!self.ife,jobScheduler:this._jobScheduler.GetPortData(),supportedAudioFormats:c,opusWasmScriptUrl:window.cr_opusWasmScriptUrl||this._scriptFolder+"opus.wasm.js",opusWasmBinaryUrl:window.cr_opusWasmBinaryUrl||this._scriptFolder+"opus.wasm.wasm",isFileProtocol:this._isFileProtocol,isiOSCordova:this.IsiOSCordova(),isiOSWebView:this.IsiOSWebView(),isWindowsWebView2:this.IsWindowsWebView2(),isAnyWebView2Wrapper:this.IsAnyWebView2Wrapper(),wrapperComponentIds:this._wrapperComponentIds,isFBInstantAvailable:typeof self.FBInstant<"u"}}async _InitWorker(t,o){const d=this._GetWorkerURL(t.workerMainUrl);this._exportType==="preview"?(this._worker=new Worker("previewworker.js",{type:"module",name:"Runtime"}),await new Promise((w,S)=>{const P=v=>{this._worker.removeEventListener("message",P),v.data&&v.data.type==="ok"?w():S()};this._worker.addEventListener("message",P),this._worker.postMessage({type:"construct-worker-init",import:new URL(d,this._runtimeBaseUrl).toString()})})):this._worker=await this.CreateWorker(d,this._runtimeBaseUrl,{type:"module",name:"Runtime",isC3MainWorker:!0});const h=document.createElement("canvas");h.style.display="none";const _=h.transferControlToOffscreen();document.body.appendChild(h);const m=document.createElement("div");m.className="c3htmlwrap",document.body.appendChild(m),this._canvasLayers.push({canvas:h,htmlWrap:m}),window.c3canvas=h,self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders();let g=t.workerDependencyScripts||[],y=t.engineScripts;if(g=await Promise.all(g.map(w=>this._MaybeGetCordovaScriptURL(w))),y=await Promise.all(y.map(w=>this._MaybeGetCordovaScriptURL(w))),this._exportType==="cordova")for(let w=0,S=t.projectScripts.length;w<S;++w){const P=t.projectScripts[w],v=P[0];(v===t.mainProjectScript||v==="scriptsInEvents.js"||v.endsWith("/scriptsInEvents.js"))&&(P[1]=await this._MaybeGetCordovaScriptURL(v))}this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(t),{type:"init-runtime",isInWorker:!0,messagePort:o,canvas:_,workerDependencyScripts:g,engineScripts:y,projectScripts:t.projectScripts,mainProjectScript:t.mainProjectScript,projectScriptsStatus:self.C3_ProjectScriptsStatus}),[o,_,...this._jobScheduler.GetPortTransferables()]),this._domHandlers=C.map(w=>new w(this)),this._FindRuntimeDOMHandler(),this._runtimeDomHandler._AddDefaultCanvasEventHandlers(h),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(m),this._runtimeDomHandler._EnableWindowResizeEvent(),self.c3_callFunction=(w,S)=>this._runtimeDomHandler._InvokeFunctionFromJS(w,S),this._exportType==="preview"&&(self.goToLastErrorScript=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(t,o){const d=document.createElement("canvas");d.style.display="none",document.body.appendChild(d);const h=document.createElement("div");h.className="c3htmlwrap",document.body.appendChild(h),this._canvasLayers.push({canvas:d,htmlWrap:h}),window.c3canvas=d,self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders(),this._domHandlers=C.map(S=>new S(this)),this._FindRuntimeDOMHandler(),this._runtimeDomHandler._AddDefaultCanvasEventHandlers(d),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(h);let _=t.engineScripts.map(S=>typeof S=="string"?new URL(S,this._runtimeBaseUrl).toString():S);if(Array.isArray(t.workerDependencyScripts)){const S=[...t.workerDependencyScripts].map(P=>P instanceof Blob?URL.createObjectURL(P):P);_.unshift(...S)}_=await Promise.all(_.map(S=>this._MaybeGetCordovaScriptURL(S))),await Promise.all(_.map(S=>i(S)));const m=self.C3_ProjectScriptsStatus,g=t.mainProjectScript,y=t.projectScripts;for(let[S,P]of y)if(P||(P=S),S===g)try{P=await this._MaybeGetCordovaScriptURL(P),await i(P),this._exportType==="preview"&&!m[S]&&this._ReportProjectMainScriptError(S,"main script did not run to completion")}catch(v){this._ReportProjectMainScriptError(S,v)}else(S==="scriptsInEvents.js"||S.endsWith("/scriptsInEvents.js"))&&(P=await this._MaybeGetCordovaScriptURL(P),await i(P));if(this._exportType==="preview"&&typeof self.C3.ScriptsInEvents!="object"){this._RemoveLoadingMessage();const S="Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax.";console.error("[C3 runtime] "+S),alert(S);return}const w=Object.assign(this._GetCommonRuntimeOptions(t),{isInWorker:!1,messagePort:o,canvas:d,runOnStartupFunctions:k});this._runtimeDomHandler._EnableWindowResizeEvent(),this._OnBeforeCreateRuntime(),this._localRuntime=self.C3_CreateRuntime(w),await self.C3_InitRuntime(this._localRuntime,w)}_ReportProjectMainScriptError(t,o){this._RemoveLoadingMessage(),console.error(`[Preview] Failed to load project main script (${t}): `,o),alert(`Failed to load project main script (${t}). Check all your JavaScript code has valid syntax. Press F12 and check the console for error details.`)}_OnBeforeCreateRuntime(){this._RemoveLoadingMessage()}_RemoveLoadingMessage(){const t=window.cr_previewLoadingElem;t&&(t.parentElement.removeChild(t),window.cr_previewLoadingElem=null)}async _OnCreateJobWorker(t){const o=await this._jobScheduler._CreateJobWorker();return{outputPort:o,transferables:[o]}}_OnUpdateCanvasSize(t){if(this.IsExportingToVideo())return;const o=t.styleWidth+"px",d=t.styleHeight+"px",h=t.marginLeft+"px",_=t.marginTop+"px";for(const{canvas:m,htmlWrap:g}of this._canvasLayers)m.style.width=o,m.style.height=d,m.style.marginLeft=h,m.style.marginTop=_,g.style.width=o,g.style.height=d,g.style.marginLeft=h,g.style.marginTop=_,this._isFirstSizeUpdate&&(m.style.display="",g.style.display="");document.documentElement.style.setProperty("--construct-scale",t.displayScale),this._isFirstSizeUpdate=!1}_OnSetHTMLLayerCount(t){const o=t.count,d=t.immediate,h=t.styleWidth+"px",_=t.styleHeight+"px",m=t.marginLeft+"px",g=t.marginTop+"px",y=[],w=[];if(o<this._canvasLayers.length)for(;this._canvasLayers.length>o;){const{canvas:S,htmlWrap:P}=this._canvasLayers.pop();P.remove(),this._useWorker&&!d?this._pendingRemoveElements.push(S):S.remove()}else if(o>this._canvasLayers.length)for(let S=0,P=o-this._canvasLayers.length;S<P;++S){const v=document.createElement("canvas");if(v.classList.add("c3overlay"),this._useWorker){const G=v.transferControlToOffscreen();y.push(G),w.push(G)}else y.push(v);document.body.appendChild(v);const I=document.createElement("div");I.classList.add("c3htmlwrap","c3overlay"),document.body.appendChild(I),v.style.width=h,v.style.height=_,v.style.marginLeft=m,v.style.marginTop=g,I.style.width=h,I.style.height=_,I.style.marginLeft=m,I.style.marginTop=g,this._runtimeDomHandler._AddDefaultCanvasEventHandlers(v),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(I),this._canvasLayers.push({canvas:v,htmlWrap:I})}for(const S of this._domHandlers)S instanceof window.DOMElementHandler&&S._OnHTMLLayersChanged();return this._UpdateHTMLElementsZOrder(),{addedCanvases:y,transferables:w}}_OnCleanUpHTMLLayers(){for(const t of this._pendingRemoveElements)t.remove();this._pendingRemoveElements.length=0}_UpdateHTMLElementsZOrder(){this._pendingUpdateHTMLZOrder||(this._pendingUpdateHTMLZOrder=!0,this._AddRAFCallback(this._updateHTMLZOrderRAFCallback))}_DoUpdateHTMLElementsZOrder(){this._RemoveRAFCallback(this._updateHTMLZOrderRAFCallback),this._pendingUpdateHTMLZOrder=!1;let t=[];for(const m of this._domHandlers)if(m instanceof window.DOMElementHandler){const g=m._GetAllElementStatesForZOrderUpdate();g&&t.push(...g)}t.sort((m,g)=>{const y=m.GetActualHTMLIndex(),w=g.GetActualHTMLIndex();if(y!==w)return y-w;const S=m.GetHTMLZIndex(),P=g.GetHTMLZIndex();return S-P});let o=0,d=0,h=0,_=t.length;for(;h<_;++h){const m=t[h];m.GetActualHTMLIndex()!==o&&(this._DoUpdateHTMLElementsZOrderOnHTMLLayer(o,t.slice(d,h)),o=m.GetActualHTMLIndex(),d=h)}d<h&&this._DoUpdateHTMLElementsZOrderOnHTMLLayer(o,t.slice(d,h))}_DoUpdateHTMLElementsZOrderOnHTMLLayer(t,o){if(o.length<=1||t>=this._canvasLayers.length)return;const d=o.map(S=>S.GetElement()),h=new Set(d),_=this.GetHTMLWrapElement(t),m=Array.from(_.children).filter(S=>h.has(S));let g=0,y=Math.min(d.length,m.length);for(;g<y&&d[g]===m[g];++g);let w=g;for(;w<y;++w)m[w].remove();for(w=g;w<y;++w)_.appendChild(d[w])}_GetLocalRuntime(){if(this._useWorker)throw new Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(t,o,d,h,_){this._messageChannelPort.postMessage({type:"event",component:t,handler:o,dispatchOpts:h||null,data:d,responseId:null},_)}PostToRuntimeComponentAsync(t,o,d,h,_){const m=O++,g=new Promise((y,w)=>{E.set(m,{resolve:y,reject:w})});return this._messageChannelPort.postMessage({type:"event",component:t,handler:o,dispatchOpts:h||null,data:d,responseId:m},_),g}_OnMessageFromRuntime(t){const o=t.type;if(o==="event")return this._OnEventFromRuntime(t);if(o==="result")this._OnResultFromRuntime(t);else if(o==="runtime-ready")this._OnRuntimeReady();else if(o==="alert-error")this._RemoveLoadingMessage(),alert(t.message);else if(o==="creating-runtime")this._OnBeforeCreateRuntime();else throw new Error(`unknown message '${o}'`)}_OnEventFromRuntime(t){const o=t.component,d=t.handler,h=t.data,_=t.responseId,m=A.get(o);if(!m){console.warn(`[DOM] No event handlers for component '${o}'`);return}const g=m.get(d);if(!g){console.warn(`[DOM] No handler '${d}' for component '${o}'`);return}let y=null;try{y=g(h)}catch(w){console.error(`Exception in '${o}' handler '${d}':`,w),_!==null&&this._PostResultToRuntime(_,!1,""+w);return}if(_===null)return y;y&&y.then?y.then(w=>this._PostResultToRuntime(_,!0,w)).catch(w=>{console.error(`Rejection from '${o}' handler '${d}':`,w),this._PostResultToRuntime(_,!1,""+w)}):this._PostResultToRuntime(_,!0,y)}_PostResultToRuntime(t,o,d){let h;d&&d.transferables&&(h=d.transferables),this._messageChannelPort.postMessage({type:"result",responseId:t,isOk:o,result:d},h)}_OnResultFromRuntime(t){const o=t.responseId,d=t.isOk,h=t.result,_=E.get(o);d?_.resolve(h):_.reject(h),E.delete(o)}AddRuntimeComponentMessageHandler(t,o,d){let h=A.get(t);if(h||(h=new Map,A.set(t,h)),h.has(o))throw new Error(`[DOM] Component '${t}' already has handler '${o}'`);h.set(o,d)}static AddDOMHandlerClass(t){if(C.includes(t))throw new Error("DOM handler already added");C.push(t)}_FindRuntimeDOMHandler(){for(const t of this._domHandlers)if(t.GetComponentID()==="runtime"){this._runtimeDomHandler=t;return}throw new Error("cannot find runtime DOM handler")}_OnMessageFromDebugger(t){this.PostToRuntimeComponent("debugger","message",t)}_OnRuntimeReady(){for(const t of this._domHandlers)t.Attach()}static IsDocumentFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||b)}static _SetWrapperIsFullscreenFlag(t){b=!!t}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(t){this._rafCallbacks.add(t),this._RequestAnimationFrame()}_RemoveRAFCallback(t){this._rafCallbacks.delete(t),this._rafCallbacks.size===0&&this._CancelAnimationFrame()}_RequestAnimationFrame(){this._rafId===-1&&this._rafCallbacks.size>0&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){this._rafId!==-1&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const t of this._rafCallbacks)t();this._RequestAnimationFrame()}TryPlayMedia(t){this._runtimeDomHandler.TryPlayMedia(t)}RemovePendingPlay(t){this._runtimeDomHandler.RemovePendingPlay(t)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(t){this._runtimeDomHandler.SetSilent(t)}IsAudioFormatSupported(t){return!!c[t]}async _WasmDecodeWebMOpus(t){const o=await this.PostToRuntimeComponentAsync("runtime","opus-decode",{arrayBuffer:t},null,[t]);return new Float32Array(o)}SetIsExportingToVideo(t){this._isExportingToVideo=!0,this._exportToVideoDuration=t}IsExportingToVideo(){return this._isExportingToVideo}GetExportToVideoDuration(){return this._exportToVideoDuration}IsAbsoluteURL(t){return/^(?:[a-z\-]+:)?\/\//.test(t)||t.substr(0,5)==="data:"||t.substr(0,5)==="blob:"}IsRelativeURL(t){return!this.IsAbsoluteURL(t)}async _MaybeGetCordovaScriptURL(t){if(this._exportType==="cordova"&&(t.startsWith("file:")||this._isFileProtocol&&this.IsRelativeURL(t))){let o=t;o.startsWith(this._runtimeBaseUrl)&&(o=o.substr(this._runtimeBaseUrl.length));const d=await this.CordovaFetchLocalFileAsArrayBuffer(o),h=new Blob([d],{type:"application/javascript"});return URL.createObjectURL(h)}else return t}async _OnCordovaFetchLocalFile(t){const o=t.filename;switch(t.as){case"text":return await this.CordovaFetchLocalFileAsText(o);case"buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(o);default:throw new Error("unsupported type")}}_GetPermissionAPI(){const t=window.cordova&&window.cordova.plugins&&window.cordova.plugins.permissions;if(typeof t!="object")throw new Error("Permission API is not loaded");return t}_MapPermissionID(t,o){const d=t[o];if(typeof d!="string")throw new Error("Invalid permission name");return d}_HasPermission(t){const o=this._GetPermissionAPI();return new Promise((d,h)=>o.checkPermission(this._MapPermissionID(o,t),_=>d(!!_.hasPermission),h))}_RequestPermission(t){const o=this._GetPermissionAPI();return new Promise((d,h)=>o.requestPermission(this._MapPermissionID(o,t),_=>d(!!_.hasPermission),h))}async RequestPermissions(t){if(this.GetExportType()!=="cordova"||this.IsiOSCordova())return!0;for(const o of t){if(await this._HasPermission(o))continue;if(await this._RequestPermission(o)===!1)return!1}return!0}async RequirePermissions(...t){if(await this.RequestPermissions(t)===!1)throw new Error("Permission not granted")}CordovaFetchLocalFile(t){const o=window.cordova.file.applicationDirectory+"www/"+t;return new Promise((d,h)=>{window.resolveLocalFileSystemURL(o,_=>{_.file(d,h)},h)})}async CordovaFetchLocalFileAsText(t){const o=await this.CordovaFetchLocalFile(t);return await u(o)}_CordovaMaybeStartNextArrayBufferRead(){if(!T.length||M>=R)return;M++;const t=T.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(t.filename,t.successCallback,t.errorCallback)}CordovaFetchLocalFileAsArrayBuffer(t){return new Promise((o,d)=>{T.push({filename:t,successCallback:h=>{M--,this._CordovaMaybeStartNextArrayBufferRead(),o(h)},errorCallback:h=>{M--,this._CordovaMaybeStartNextArrayBufferRead(),d(h)}}),this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(t,o,d){try{const h=await this.CordovaFetchLocalFile(t),_=await p(h);o(_)}catch(h){d(h)}}_OnWrapperMessage(t,o){if(t==="entered-fullscreen")L._SetWrapperIsFullscreenFlag(!0),this._runtimeDomHandler._OnFullscreenChange();else if(t==="exited-fullscreen")L._SetWrapperIsFullscreenFlag(!1),this._runtimeDomHandler._OnFullscreenChange();else if(typeof t=="object"){const d=t.type;d==="directory-handles"?this._directoryHandles=o:d==="wrapper-init-response"?(this._wrapperInitResolve(t),this._wrapperInitResolve=null):d==="extension-message"?this.PostToRuntimeComponent("runtime","wrapper-extension-message",t):console.warn("Unknown wrapper message: ",t)}else console.warn("Unknown wrapper message: ",t)}_OnSendWrapperExtensionMessage(t){this._SendWrapperMessage({type:"extension-message",componentId:t.componentId,messageId:t.messageId,params:t.params||[],asyncId:t.asyncId})}_SendWrapperMessage(t){this.IsAnyWebView2Wrapper()?window.chrome.webview.postMessage(JSON.stringify(t)):this._exportType==="macos-wkwebview"&&window.webkit.messageHandlers.C3Wrapper.postMessage(JSON.stringify(t))}_SetupWebView2Polyfills(){window.moveTo=(t,o)=>{this._SendWrapperMessage({type:"set-window-position",windowX:Math.ceil(t),windowY:Math.ceil(o)})},window.resizeTo=(t,o)=>{this._SendWrapperMessage({type:"set-window-size",windowWidth:Math.ceil(t),windowHeight:Math.ceil(o)})}}_InitWrapper(){return this.IsAnyWebView2Wrapper()?new Promise(t=>{this._wrapperInitResolve=t,this._SendWrapperMessage({type:"wrapper-init"})}):Promise.resolve()}_GetDirectoryHandles(){return this._directoryHandles}async _ConvertDataUrisToBlobs(){const t=[];for(const[o,d]of Object.entries(this._localFileBlobs))t.push(this._ConvertDataUriToBlobs(o,d));await Promise.all(t)}async _ConvertDataUriToBlobs(t,o){if(typeof o=="object")this._localFileBlobs[t]=new Blob([o.str],{type:o.type}),this._localFileStrings[t]=o.str;else{let d=await this._FetchDataUri(o);d||(d=this._DataURIToBinaryBlobSync(o)),this._localFileBlobs[t]=d}}async _FetchDataUri(t){try{return await(await fetch(t)).blob()}catch(o){return console.warn("Failed to fetch a data: URI. Falling back to a slower workaround. This is probably because the Content Security Policy unnecessarily blocked it. Allow data: URIs in your CSP to avoid this.",o),null}}_DataURIToBinaryBlobSync(t){const o=this._ParseDataURI(t);return this._BinaryStringToBlob(o.data,o.mime_type)}_ParseDataURI(t){const o=t.indexOf(",");if(o<0)throw new URIError("expected comma in data: uri");const d=t.substring(5,o),h=t.substring(o+1),_=d.split(";"),m=_[0]||"",g=_[1],y=_[2];let w;return g==="base64"||y==="base64"?w=atob(h):w=decodeURIComponent(h),{mime_type:m,data:w}}_BinaryStringToBlob(t,o){let d=t.length,h=d>>2,_=new Uint8Array(d),m=new Uint32Array(_.buffer,0,h),g,y;for(g=0,y=0;g<h;++g)m[g]=t.charCodeAt(y++)|t.charCodeAt(y++)<<8|t.charCodeAt(y++)<<16|t.charCodeAt(y++)<<24;let w=d&3;for(;w--;)_[y]=t.charCodeAt(y),++y;return new Blob([_],{type:o})}}}{let l=function(b){return b.sourceCapabilities&&b.sourceCapabilities.firesTouchEvents||b.originalEvent&&b.originalEvent.sourceCapabilities&&b.originalEvent.sourceCapabilities.firesTouchEvents},r=function(b){return new Promise((a,t)=>{const o=document.createElement("link");o.onload=()=>a(o),o.onerror=d=>t(d),o.rel="stylesheet",o.href=b,document.head.appendChild(o)})},c=function(b){return new Promise((a,t)=>{const o=new Image;o.onload=()=>a(o),o.onerror=d=>t(d),o.src=b})},p=function(b){do{if(b.parentNode&&b.hasAttribute("contenteditable"))return!0;b=b.parentNode}while(b);return!1},M=function(b){return T.has(b.tagName.toLowerCase())||p(b)},C=function(b){if(!b.target.tagName)return;const a=b.target.tagName.toLowerCase();R.has(a)&&b.preventDefault()},A=function(b){b.target.tagName&&b.target.classList.contains("c3htmlwrap")&&b.preventDefault()},E=function(b){(b.metaKey||b.ctrlKey)&&b.preventDefault()},k=function(){try{return window.parent&&window.parent.document.hasFocus()}catch{return!1}};const f=self.RuntimeInterface,s=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),e={dispatchRuntimeEvent:!0,dispatchUserScriptEvent:!0},i={dispatchUserScriptEvent:!0},n={dispatchRuntimeEvent:!0};async function u(b){const a=URL.createObjectURL(b);try{return await c(a)}finally{URL.revokeObjectURL(a)}}const T=new Set(["input","textarea","datalist","select"]),R=new Set(["canvas","body","html"]);self.C3_GetSvgImageSize=async function(b){const a=await u(b);if(a.width>0&&a.height>0)return[a.width,a.height];{a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.visibility="hidden",document.body.appendChild(a);const t=a.getBoundingClientRect();return document.body.removeChild(a),[t.width,t.height]}},self.C3_RasterSvgImageBlob=async function(b,a,t,o,d){const h=await u(b),_=document.createElement("canvas");return _.width=o,_.height=d,_.getContext("2d").drawImage(h,0,0,a,t),_};let O=!1;document.addEventListener("pause",()=>O=!0),document.addEventListener("resume",()=>O=!1);const x="runtime",N=class extends self.DOMHandler{constructor(a){super(a,x),this._enableWindowResizeEvent=!1,this._simulatedResizeTimerId=-1,this._targetOrientation="any",this._attachedDeviceOrientationEvent=!1,this._attachedDeviceMotionEvent=!1,this._pageVisibilityIsHidden=!1,this._screenReaderTextWrap=document.createElement("div"),this._screenReaderTextWrap.className="c3-screen-reader-text",this._screenReaderTextWrap.setAttribute("aria-live","polite"),document.body.appendChild(this._screenReaderTextWrap),this._debugHighlightElem=null,this._isExportToVideo=!1,this._exportVideoProgressMessage="",this._exportVideoUpdateTimerId=-1,this._enableAndroidVKDetection=!1,this._lastWindowWidth=a._GetWindowInnerWidth(),this._lastWindowHeight=a._GetWindowInnerHeight(),this._virtualKeyboardHeight=0,this._vkTranslateYOffset=0,a.AddRuntimeComponentMessageHandler("runtime","invoke-download",o=>this._OnInvokeDownload(o)),a.AddRuntimeComponentMessageHandler("runtime","load-webfonts",o=>this._OnLoadWebFonts(o)),a.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",o=>this._OnRasterSvgImage(o)),a.AddRuntimeComponentMessageHandler("runtime","get-svg-image-size",o=>this._OnGetSvgImageSize(o)),a.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",o=>this._OnSetTargetOrientation(o)),a.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW()),a.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",o=>this._OnPostToDebugger(o)),a.AddRuntimeComponentMessageHandler("runtime","go-to-script",o=>this._OnPostToDebugger(o)),a.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking()),a.AddRuntimeComponentMessageHandler("runtime","debug-highlight",o=>this._OnDebugHighlight(o)),a.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent()),a.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent()),a.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",o=>this._OnAddStylesheet(o)),a.AddRuntimeComponentMessageHandler("runtime","script-create-worker",o=>this._OnScriptCreateWorker(o)),a.AddRuntimeComponentMessageHandler("runtime","alert",o=>this._OnAlert(o)),a.AddRuntimeComponentMessageHandler("runtime","screen-reader-text",o=>this._OnScreenReaderTextEvent(o)),a.AddRuntimeComponentMessageHandler("runtime","hide-cordova-splash",()=>this._OnHideCordovaSplash()),a.AddRuntimeComponentMessageHandler("runtime","set-exporting-to-video",o=>this._SetExportingToVideo(o)),a.AddRuntimeComponentMessageHandler("runtime","export-to-video-progress",o=>this._OnExportVideoProgress(o)),a.AddRuntimeComponentMessageHandler("runtime","exported-to-video",o=>this._OnExportedToVideo(o)),a.AddRuntimeComponentMessageHandler("runtime","exported-to-image-sequence",o=>this._OnExportedToImageSequence(o));const t=new Set(["input","textarea","datalist"]);if(window.addEventListener("contextmenu",o=>{const d=o.target,h=d.tagName.toLowerCase();!t.has(h)&&!p(d)&&o.preventDefault()}),window.addEventListener("selectstart",C),window.addEventListener("gesturehold",C),window.addEventListener("touchstart",C,{passive:!1}),window.addEventListener("pointerdown",C,{passive:!1}),this._mousePointerLastButtons=0,window.addEventListener("mousedown",o=>{o.button===1&&o.preventDefault()}),window.addEventListener("mousewheel",E,{passive:!1}),window.addEventListener("wheel",E,{passive:!1}),window.addEventListener("resize",()=>this._OnWindowResize()),window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("fullscreenerror",o=>this._OnFullscreenError(o)),window.addEventListener("webkitfullscreenerror",o=>this._OnFullscreenError(o)),window.addEventListener("mozfullscreenerror",o=>this._OnFullscreenError(o)),a.IsiOSWebView()){let o=1/0;window.visualViewport.addEventListener("resize",()=>{const d=window.visualViewport.height;d>o&&(document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0),o=d}),document.documentElement.setAttribute("ioswebview","")}this._mediaPendingPlay=new Set,this._mediaRemovedPendingPlay=new WeakSet,this._isSilent=!1}_AddDefaultCanvasEventHandlers(a){a.addEventListener("selectstart",C),a.addEventListener("gesturehold",C),a.addEventListener("pointerdown",C)}_AddDefaultHTMLWrapEventHandlers(a){a.addEventListener("selectstart",A),a.addEventListener("gesturehold",A),a.addEventListener("touchstart",A)}_OnBeforeStartTicking(){return self.setTimeout(()=>{this._enableAndroidVKDetection=!0},1e3),this._iRuntime.GetExportType()==="cordova"?(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):document.addEventListener("visibilitychange",()=>this._OnVisibilityChange(document.visibilityState==="hidden")),this._pageVisibilityIsHidden=!!(document.visibilityState==="hidden"||O),{isSuspended:this._pageVisibilityIsHidden}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus")),window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{parentHasFocus:k()}),this._mousePointerLastButtons=0}),window.addEventListener("focusin",t=>{M(t.target)&&this._PostRuntimeEvent("keyboard-blur")}),window.addEventListener("keydown",t=>this._OnKeyEvent("keydown",t)),window.addEventListener("keyup",t=>this._OnKeyEvent("keyup",t)),window.addEventListener("mousedown",t=>this._OnMouseEvent("mousedown",t,i)),window.addEventListener("mousemove",t=>this._OnMouseEvent("mousemove",t,i)),window.addEventListener("mouseup",t=>this._OnMouseEvent("mouseup",t,i)),window.addEventListener("dblclick",t=>this._OnMouseEvent("dblclick",t,e)),window.addEventListener("wheel",t=>this._OnMouseWheelEvent("wheel",t,e)),window.addEventListener("pointerdown",t=>{this._HandlePointerDownFocus(t),this._OnPointerEvent("pointerdown",t)}),this._iRuntime.UsesWorker()&&typeof window.onpointerrawupdate<"u"&&self===self.top?window.addEventListener("pointerrawupdate",t=>this._OnPointerRawUpdate(t)):window.addEventListener("pointermove",t=>this._OnPointerEvent("pointermove",t)),window.addEventListener("pointerup",t=>this._OnPointerEvent("pointerup",t)),window.addEventListener("pointercancel",t=>this._OnPointerEvent("pointercancel",t));const a=()=>this._PlayPendingMedia();window.addEventListener("pointerup",a,!0),window.addEventListener("touchend",a,!0),window.addEventListener("click",a,!0),window.addEventListener("keydown",a,!0),window.addEventListener("gamepadconnected",a,!0),this._iRuntime.IsAndroid()&&!this._iRuntime.IsAndroidWebView()&&navigator.virtualKeyboard&&(navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.addEventListener("geometrychange",()=>{this._OnAndroidVirtualKeyboardChange(this._GetWindowInnerHeight(),navigator.virtualKeyboard.boundingRect.height)})),this._iRuntime.IsiOSWebView()&&(document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0)}_OnAndroidVirtualKeyboardChange(a,t){if(document.body.style.position="",document.body.style.overflow="",document.body.style.transform="",this._vkTranslateYOffset=0,t>0){const o=document.activeElement;if(o){const d=o.getBoundingClientRect(),h=(d.top+d.bottom)/2,_=(a-t)/2;let m=h-_;m>t&&(m=t),m<0&&(m=0),m>0&&(document.body.style.position="absolute",document.body.style.overflow="visible",document.body.style.transform=`translateY(${-m}px)`,this._vkTranslateYOffset=m)}}}_PostRuntimeEvent(a,t){this.PostToRuntime(a,t||null,n)}_GetWindowInnerWidth(){return this._iRuntime._GetWindowInnerWidth()}_GetWindowInnerHeight(){return this._iRuntime._GetWindowInnerHeight()}_EnableWindowResizeEvent(){this._enableWindowResizeEvent=!0,this._lastWindowWidth=this._iRuntime._GetWindowInnerWidth(),this._lastWindowHeight=this._iRuntime._GetWindowInnerHeight()}_OnWindowResize(){if(this._isExportToVideo||!this._enableWindowResizeEvent)return;const a=this._GetWindowInnerWidth(),t=this._GetWindowInnerHeight();if(this._iRuntime.IsAndroidWebView())if(this._enableAndroidVKDetection)if(this._lastWindowWidth===a&&t<this._lastWindowHeight){this._virtualKeyboardHeight=this._lastWindowHeight-t,this._OnAndroidVirtualKeyboardChange(this._lastWindowHeight,this._virtualKeyboardHeight);return}else this._virtualKeyboardHeight>0&&(this._virtualKeyboardHeight=0,this._OnAndroidVirtualKeyboardChange(t,this._virtualKeyboardHeight)),this._lastWindowWidth=a,this._lastWindowHeight=t;else this._lastWindowWidth=a,this._lastWindowHeight=t;this.PostToRuntime("window-resize",{innerWidth:a,innerHeight:t,devicePixelRatio:window.devicePixelRatio,isFullscreen:f.IsDocumentFullscreen(),cssDisplayMode:this._iRuntime.GetCssDisplayMode()}),this._iRuntime.IsiOSWebView()&&(this._simulatedResizeTimerId!==-1&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(a,t,0))}_ScheduleSimulatedResize(a,t,o){this._simulatedResizeTimerId!==-1&&clearTimeout(this._simulatedResizeTimerId),this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(a,t,o),48)}_OnSimulatedResize(a,t,o){const d=this._GetWindowInnerWidth(),h=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1,d!=a||h!=t?this.PostToRuntime("window-resize",{innerWidth:d,innerHeight:h,devicePixelRatio:window.devicePixelRatio,isFullscreen:f.IsDocumentFullscreen(),cssDisplayMode:this._iRuntime.GetCssDisplayMode()}):o<10&&this._ScheduleSimulatedResize(d,h,o+1)}_OnSetTargetOrientation(a){this._targetOrientation=a.targetOrientation}_TrySetTargetOrientation(){const a=this._targetOrientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(a).catch(t=>console.warn("[Construct] Failed to lock orientation: ",t));else try{let t=!1;screen.lockOrientation?t=screen.lockOrientation(a):screen.webkitLockOrientation?t=screen.webkitLockOrientation(a):screen.mozLockOrientation?t=screen.mozLockOrientation(a):screen.msLockOrientation&&(t=screen.msLockOrientation(a)),t||console.warn("[Construct] Failed to lock orientation")}catch(t){console.warn("[Construct] Failed to lock orientation: ",t)}}_OnFullscreenChange(){if(this._isExportToVideo)return;const a=f.IsDocumentFullscreen();a&&this._targetOrientation!=="any"&&this._TrySetTargetOrientation(),this.PostToRuntime("fullscreenchange",{isFullscreen:a,innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnFullscreenError(a){console.warn("[Construct] Fullscreen request failed: ",a),this.PostToRuntime("fullscreenerror",{isFullscreen:f.IsDocumentFullscreen(),innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnVisibilityChange(a){if(this._pageVisibilityIsHidden!==a&&(this._pageVisibilityIsHidden=a,a?this._iRuntime._CancelAnimationFrame():this._iRuntime._RequestAnimationFrame(),this.PostToRuntime("visibilitychange",{hidden:a}),!a&&this._iRuntime.IsiOSWebView())){const t=()=>{document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0};setTimeout(t,50),setTimeout(t,100),setTimeout(t,250),setTimeout(t,500)}}_OnKeyEvent(a,t){if(t.key==="Backspace"&&C(t),this._iRuntime.GetExportType()==="nwjs"&&t.key==="u"&&(t.ctrlKey||t.metaKey)&&t.preventDefault(),this._isExportToVideo)return;const o=s.get(t.code)||t.code;this._PostToRuntimeMaybeSync(a,{code:o,key:t.key,which:t.which,repeat:t.repeat,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,timeStamp:t.timeStamp},e)}_OnMouseWheelEvent(a,t,o){this._isExportToVideo||this.PostToRuntime(a,{clientX:t.clientX,clientY:t.clientY+this._vkTranslateYOffset,pageX:t.pageX,pageY:t.pageY+this._vkTranslateYOffset,deltaX:t.deltaX,deltaY:t.deltaY,deltaZ:t.deltaZ,deltaMode:t.deltaMode,timeStamp:t.timeStamp},o)}_OnMouseEvent(a,t,o){this._isExportToVideo||l(t)||this._PostToRuntimeMaybeSync(a,{button:t.button,buttons:t.buttons,clientX:t.clientX,clientY:t.clientY+this._vkTranslateYOffset,pageX:t.pageX,pageY:t.pageY+this._vkTranslateYOffset,movementX:t.movementX||0,movementY:t.movementY||0,timeStamp:t.timeStamp},o)}_OnPointerEvent(a,t){if(this._isExportToVideo)return;let o=0;t.pointerType==="mouse"&&(o=this._mousePointerLastButtons),this._PostToRuntimeMaybeSync(a,{pointerId:t.pointerId,pointerType:t.pointerType,button:t.button,buttons:t.buttons,lastButtons:o,clientX:t.clientX,clientY:t.clientY+this._vkTranslateYOffset,pageX:t.pageX,pageY:t.pageY+this._vkTranslateYOffset,movementX:t.movementX||0,movementY:t.movementY||0,width:t.width||0,height:t.height||0,pressure:t.pressure||0,tangentialPressure:t.tangentialPressure||0,tiltX:t.tiltX||0,tiltY:t.tiltY||0,twist:t.twist||0,timeStamp:t.timeStamp},e),t.pointerType==="mouse"&&(this._mousePointerLastButtons=t.buttons)}_OnPointerRawUpdate(a){this._OnPointerEvent("pointermove",a)}_OnTouchEvent(a,t){if(!this._isExportToVideo)for(let o=0,d=t.changedTouches.length;o<d;++o){const h=t.changedTouches[o];this._PostToRuntimeMaybeSync(a,{pointerId:h.identifier,pointerType:"touch",button:0,buttons:0,lastButtons:0,clientX:h.clientX,clientY:h.clientY+this._vkTranslateYOffset,pageX:h.pageX,pageY:h.pageY+this._vkTranslateYOffset,movementX:t.movementX||0,movementY:t.movementY||0,width:(h.radiusX||h.webkitRadiusX||0)*2,height:(h.radiusY||h.webkitRadiusY||0)*2,pressure:h.force||h.webkitForce||0,tangentialPressure:0,tiltX:0,tiltY:0,twist:h.rotationAngle||0,timeStamp:t.timeStamp},e)}}_HandlePointerDownFocus(a){window!==window.top&&window.focus(),this._IsElementCanvasOrDocument(a.target)&&document.activeElement&&!this._IsElementCanvasOrDocument(document.activeElement)&&document.activeElement.blur()}_IsElementCanvasOrDocument(a){return!a||a===document||a===window||a===document.body||a.tagName.toLowerCase()==="canvas"}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",a=>this._OnDeviceOrientation(a)),window.addEventListener("deviceorientationabsolute",a=>this._OnDeviceOrientationAbsolute(a)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",a=>this._OnDeviceMotion(a)))}_OnDeviceOrientation(a){this._isExportToVideo||this.PostToRuntime("deviceorientation",{absolute:!!a.absolute,alpha:a.alpha||0,beta:a.beta||0,gamma:a.gamma||0,timeStamp:a.timeStamp,webkitCompassHeading:a.webkitCompassHeading,webkitCompassAccuracy:a.webkitCompassAccuracy},e)}_OnDeviceOrientationAbsolute(a){this._isExportToVideo||this.PostToRuntime("deviceorientationabsolute",{absolute:!!a.absolute,alpha:a.alpha||0,beta:a.beta||0,gamma:a.gamma||0,timeStamp:a.timeStamp},e)}_OnDeviceMotion(a){if(this._isExportToVideo)return;let t=null;const o=a.acceleration;o&&(t={x:o.x||0,y:o.y||0,z:o.z||0});let d=null;const h=a.accelerationIncludingGravity;h&&(d={x:h.x||0,y:h.y||0,z:h.z||0});let _=null;const m=a.rotationRate;m&&(_={alpha:m.alpha||0,beta:m.beta||0,gamma:m.gamma||0}),this.PostToRuntime("devicemotion",{acceleration:t,accelerationIncludingGravity:d,rotationRate:_,interval:a.interval,timeStamp:a.timeStamp},e)}_OnInvokeDownload(a){const t=a.url,o=a.filename,d=document.createElement("a"),h=document.body;d.textContent=o,d.href=t,d.download=o,h.appendChild(d),d.click(),h.removeChild(d)}async _OnLoadWebFonts(a){const t=a.webfonts;await Promise.all(t.map(async o=>{const d=new FontFace(o.name,`url('${o.url}')`);document.fonts.add(d),await d.load()}))}async _OnRasterSvgImage(a){const t=a.blob,o=a.imageWidth,d=a.imageHeight,h=a.surfaceWidth,_=a.surfaceHeight,m=a.imageBitmapOpts,g=await self.C3_RasterSvgImageBlob(t,o,d,h,_);let y;return m?y=await createImageBitmap(g,m):y=await createImageBitmap(g),{imageBitmap:y,transferables:[y]}}async _OnGetSvgImageSize(a){return await self.C3_GetSvgImageSize(a.blob)}async _OnAddStylesheet(a){await r(a.url)}_PlayPendingMedia(){const a=[...this._mediaPendingPlay];if(this._mediaPendingPlay.clear(),!this._isSilent)for(const t of a){const o=t.play();o&&o.catch(d=>{this._mediaRemovedPendingPlay.has(t)||this._mediaPendingPlay.add(t)})}}TryPlayMedia(a){if(typeof a.play!="function")throw new Error("missing play function");this._mediaRemovedPendingPlay.delete(a);let t;try{t=a.play()}catch{this._mediaPendingPlay.add(a);return}t&&t.catch(o=>{this._mediaRemovedPendingPlay.has(a)||this._mediaPendingPlay.add(a)})}RemovePendingPlay(a){this._mediaPendingPlay.delete(a),this._mediaRemovedPendingPlay.add(a)}SetSilent(a){this._isSilent=!!a}_OnHideCordovaSplash(){navigator.splashscreen&&navigator.splashscreen.hide&&navigator.splashscreen.hide()}_OnDebugHighlight(a){if(!a.show){this._debugHighlightElem&&(this._debugHighlightElem.style.display="none");return}this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));const o=this._debugHighlightElem;o.style.display="",o.style.left=a.left-1+"px",o.style.top=a.top-1+"px",o.style.width=a.width+2+"px",o.style.height=a.height+2+"px",o.textContent=a.name}_OnRegisterSW(){window.C3_RegisterSW&&window.C3_RegisterSW()}_OnPostToDebugger(a){window.c3_postToMessagePort&&(a.from="runtime",window.c3_postToMessagePort(a))}_InvokeFunctionFromJS(a,t){return this.PostToRuntimeAsync("js-invoke-function",{name:a,params:t})}_OnScriptCreateWorker(a){const t=a.url,o=a.opts,d=a.port2;new Worker(t,o).postMessage({type:"construct-worker-init",port2:d},[d])}_OnAlert(a){alert(a.message)}_OnScreenReaderTextEvent(a){const t=a.type;if(t==="create"){const o=document.createElement("p");o.id="c3-sr-"+a.id,o.textContent=a.text,this._screenReaderTextWrap.appendChild(o)}else if(t==="update"){const o=document.getElementById("c3-sr-"+a.id);o?o.textContent=a.text:console.warn(`[Construct] Missing screen reader text with id ${a.id}`)}else if(t==="release"){const o=document.getElementById("c3-sr-"+a.id);o?o.remove():console.warn(`[Construct] Missing screen reader text with id ${a.id}`)}else console.warn(`[Construct] Unknown screen reader text update '${t}'`)}_SetExportingToVideo(a){this._isExportToVideo=!0;const t=document.createElement("h1");t.id="exportToVideoMessage",t.textContent=a.message,document.body.prepend(t),document.body.classList.add("exportingToVideo"),this.GetRuntimeInterface().GetMainCanvas().style.display="",this._iRuntime.SetIsExportingToVideo(a.duration)}_OnExportVideoProgress(a){this._exportVideoProgressMessage=a.message,this._exportVideoUpdateTimerId===-1&&(this._exportVideoUpdateTimerId=setTimeout(()=>this._DoUpdateExportVideoProgressMessage(),250))}_DoUpdateExportVideoProgressMessage(){this._exportVideoUpdateTimerId=-1;const a=document.getElementById("exportToVideoMessage");a&&(a.textContent=this._exportVideoProgressMessage)}_OnExportedToVideo(a){window.c3_postToMessagePort({type:"exported-video",arrayBuffer:a.arrayBuffer,contentType:a.contentType,time:a.time})}_OnExportedToImageSequence(a){window.c3_postToMessagePort({type:"exported-image-sequence",blobArr:a.blobArr,time:a.time,gif:a.gif})}};f.AddDOMHandlerClass(N)}{const f="dispatchworker.js",l="jobworker.js";self.JobSchedulerDOM=class{constructor(e){this._runtimeInterface=e,this._baseUrl=e.GetRuntimeBaseURL(),e.GetExportType()==="preview"?this._baseUrl+="workers/":this._baseUrl+=e.GetScriptFolder(),this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16),this._dispatchWorker=null,this._jobWorkers=[],this._inputPort=null,this._outputPort=null}_GetWorkerScriptFolder(){return this._runtimeInterface.GetExportType()==="playable-ad"?this._runtimeInterface.GetScriptFolder():""}async Init(){if(this._hasInitialised)throw new Error("already initialised");this._hasInitialised=!0;const e=this._runtimeInterface._GetWorkerURL(this._GetWorkerScriptFolder()+f);this._dispatchWorker=await this._runtimeInterface.CreateWorker(e,this._baseUrl,{name:"DispatchWorker"});const i=new MessageChannel;this._inputPort=i.port1,this._dispatchWorker.postMessage({type:"_init","in-port":i.port2},[i.port2]),this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const e=this._jobWorkers.length,i=this._runtimeInterface._GetWorkerURL(this._GetWorkerScriptFolder()+l),n=await this._runtimeInterface.CreateWorker(i,this._baseUrl,{name:"JobWorker"+e}),r=new MessageChannel,c=new MessageChannel;return this._dispatchWorker.postMessage({type:"_addJobWorker",port:r.port1},[r.port1]),n.postMessage({type:"init",number:e,"dispatch-port":r.port2,"output-port":c.port2},[r.port2,c.port2]),this._jobWorkers.push(n),c.port1}GetPortData(){return{inputPort:this._inputPort,outputPort:this._outputPort,maxNumWorkers:this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}}}window.C3_Is_Supported&&(window.c3_runtimeInterface=new self.RuntimeInterface({useWorker:!1,workerMainUrl:"workermain.js",engineScripts:["scripts/c3runtime.js"],projectScripts:[],mainProjectScript:"",scriptFolder:"scripts/",workerDependencyScripts:[],exportType:"html5"}));{const f="touch",l=class extends self.DOMHandler{constructor(e){super(e,f),this.AddRuntimeMessageHandler("request-permission",i=>this._OnRequestPermission(i))}async _OnRequestPermission(e){const i=e.type;let n=!0;i===0?n=await this._RequestOrientationPermission():i===1&&(n=await this._RequestMotionPermission()),this.PostToRuntime("permission-result",{type:i,result:n})}async _RequestOrientationPermission(){if(!self.DeviceOrientationEvent||!self.DeviceOrientationEvent.requestPermission)return!0;try{return await self.DeviceOrientationEvent.requestPermission()==="granted"}catch(e){return console.warn("[Touch] Failed to request orientation permission: ",e),!1}}async _RequestMotionPermission(){if(!self.DeviceMotionEvent||!self.DeviceMotionEvent.requestPermission)return!0;try{return await self.DeviceMotionEvent.requestPermission()==="granted"}catch(e){return console.warn("[Touch] Failed to request motion permission: ",e),!1}}};self.RuntimeInterface.AddDOMHandlerClass(l)}{const f="localstorage",l=class extends self.DOMHandler{constructor(e){super(e,f),this.AddRuntimeMessageHandlers([["init",()=>this._Init()],["request-persistent",()=>this._OnRequestPersistent()]])}async _Init(){let e=!1;try{e=await navigator.storage.persisted()}catch(i){e=!1,console.warn("[Construct] Error checking storage persisted state: ",i)}return{isPersistent:e}}async _OnRequestPersistent(){try{return{isOk:!0,isPersistent:await navigator.storage.persist()}}catch(e){return console.error("[Construct] Error requesting persistent storage: ",e),{isOk:!1}}}};self.RuntimeInterface.AddDOMHandlerClass(l)}{const f=180/Math.PI,l="audio";self.AudioDOMHandler=class extends self.DOMHandler{constructor(e){super(e,l),this._audioContext=null,this._destinationNode=null,this._hasUnblocked=!1,this._hasAttachedUnblockEvents=!1,this._unblockFunc=()=>this._UnblockAudioContext(),this._audioBuffers=[],this._audioInstances=[],this._lastAudioInstance=null,this._lastPlayedTags=[],this._loadedAudioUrls=new Set,this._lastTickCount=-1,this._pendingTags=new Map,this._masterVolume=1,this._isSilent=!1,this._timeScaleMode=0,this._timeScale=1,this._gameTime=0,this._panningModel="HRTF",this._distanceModel="inverse",this._refDistance=600,this._maxDistance=1e4,this._rolloffFactor=1,this._lastListenerPos=[0,0,0],this._lastListenerOrientation=[0,0,-1,0,1,0],this._playMusicAsSound=!1,this._hasAnySoftwareDecodedMusic=!1,this._supportsWebMOpus=this._iRuntime.IsAudioFormatSupported("audio/webm; codecs=opus"),this._effects=new Map,this._analysers=new Set,this._isPendingPostFxState=!1,this._hasStartedOfflineRender=!1,this._microphoneTag="",this._microphoneSource=null,self.C3Audio_OnMicrophoneStream=(i,n)=>this._OnMicrophoneStream(i,n),this._destMediaStreamNode=null,self.C3Audio_GetOutputStream=()=>this._OnGetOutputStream(),self.C3Audio_DOMInterface=this,this.AddRuntimeMessageHandlers([["create-audio-context",i=>this._CreateAudioContext(i)],["play",i=>this._Play(i)],["stop",i=>this._Stop(i)],["stop-all",()=>this._StopAll()],["set-paused",i=>this._SetPaused(i)],["set-volume",i=>this._SetVolume(i)],["fade-volume",i=>this._FadeVolume(i)],["set-master-volume",i=>this._SetMasterVolume(i)],["set-muted",i=>this._SetMuted(i)],["set-silent",i=>this._SetSilent(i)],["set-looping",i=>this._SetLooping(i)],["set-playback-rate",i=>this._SetPlaybackRate(i)],["set-stereo-pan",i=>this._SetStereoPan(i)],["seek",i=>this._Seek(i)],["preload",i=>this._Preload(i)],["unload",i=>this._Unload(i)],["unload-all",()=>this._UnloadAll()],["set-suspended",i=>this._SetSuspended(i)],["add-effect",i=>this._AddEffect(i)],["set-effect-param",i=>this._SetEffectParam(i)],["remove-effects",i=>this._RemoveEffects(i)],["tick",i=>this._OnTick(i)],["load-state",i=>this._OnLoadState(i)],["offline-render-audio",i=>this._OnOfflineRenderAudio(i)],["offline-render-finish",()=>this._OnOfflineRenderFinish()]])}async _CreateAudioContext(e){if(e.usePlayMusicAsSoundWorkaround&&(this._playMusicAsSound=!0),this._timeScaleMode=e.timeScaleMode,this._panningModel=["equalpower","HRTF","soundfield"][e.panningModel],this._distanceModel=["linear","inverse","exponential"][e.distanceModel],this._refDistance=e.refDistance,this._maxDistance=e.maxDistance,this._rolloffFactor=e.rolloffFactor,this._iRuntime.IsExportingToVideo()){this._playMusicAsSound=!0;const n=48e3;this._audioContext=new OfflineAudioContext({numberOfChannels:2,sampleRate:n,length:Math.ceil(this._iRuntime.GetExportToVideoDuration()*n)})}else{const n={latencyHint:e.latencyHint};if(this.SupportsWebMOpus()||(n.sampleRate=48e3),typeof AudioContext<"u")this._audioContext=new AudioContext(n);else if(typeof webkitAudioContext<"u")this._audioContext=new webkitAudioContext(n);else throw new Error("Web Audio API not supported");this._AttachUnblockEvents(),this._audioContext.onstatechange=()=>{this._audioContext.state!=="running"&&this._AttachUnblockEvents(),this.PostToRuntime("audiocontext-state",{audioContextState:this._audioContext.state})}}this._destinationNode=this._audioContext.createGain(),this._destinationNode.connect(this._audioContext.destination);const i=e.listenerPos;this._lastListenerPos[0]=i[0],this._lastListenerPos[1]=i[1],this._lastListenerPos[2]=i[2],this._audioContext.listener.setPosition(i[0],i[1],i[2]),this._audioContext.listener.setOrientation(...this._lastListenerOrientation),self.C3_GetAudioContextCurrentTime=()=>this.GetAudioCurrentTime();try{await Promise.all(e.preloadList.map(n=>this._GetAudioBuffer(n.originalUrl,n.url,n.type,!1)))}catch(n){console.error("[Construct] Preloading sounds failed: ",n)}return{sampleRate:this._audioContext.sampleRate,audioContextState:this._audioContext.state,outputLatency:this._audioContext.outputLatency||0}}_AttachUnblockEvents(){this._hasAttachedUnblockEvents||(this._hasUnblocked=!1,window.addEventListener("pointerup",this._unblockFunc,!0),window.addEventListener("touchend",this._unblockFunc,!0),window.addEventListener("click",this._unblockFunc,!0),window.addEventListener("keydown",this._unblockFunc,!0),this._hasAttachedUnblockEvents=!0)}_DetachUnblockEvents(){this._hasAttachedUnblockEvents&&(this._hasUnblocked=!0,window.removeEventListener("pointerup",this._unblockFunc,!0),window.removeEventListener("touchend",this._unblockFunc,!0),window.removeEventListener("click",this._unblockFunc,!0),window.removeEventListener("keydown",this._unblockFunc,!0),this._hasAttachedUnblockEvents=!1)}_UnblockAudioContext(){if(this._hasUnblocked)return;const e=this._audioContext;e.state==="suspended"&&e.resume&&e.resume();const i=e.createBuffer(1,220,22050),n=e.createBufferSource();n.buffer=i,n.connect(e.destination),n.start(0),e.state==="running"&&this._DetachUnblockEvents()}_MatchTagLists(e,i){for(const n of i){let r=!1;for(const c of e)if(self.AudioDOMHandler.EqualsNoCase(c,n)){r=!0;break}if(!r)return!1}return!0}GetAudioContext(){return this._audioContext}GetAudioCurrentTime(){return this._audioContext.currentTime}GetDestinationNode(){return this._destinationNode}GetAudioContextExtern(){return this.GetAudioContext()}GetDestinationNodeExtern(){return this.GetDestinationNode()}GetDestinationForTag(e){const i=this._effects.get(e.toLowerCase());return i?i[0].GetInputNode():this.GetDestinationNode()}AddEffectForTag(e,i){e=e.toLowerCase();let n=this._effects.get(e);n||(n=[],this._effects.set(e,n)),i._SetIndex(n.length),i._SetTag(e),n.push(i),this._ReconnectEffects(e)}_ReconnectEffects(e){e=e.toLowerCase();let i=this.GetDestinationNode();const n=this._effects.get(e);if(n&&n.length){i=n[0].GetInputNode();for(let r=0,c=n.length;r<c;++r){const u=n[r];r+1===c?u.ConnectTo(this.GetDestinationNode()):u.ConnectTo(n[r+1].GetInputNode())}}for(const r of this.audioInstancesByEffectTag(e))r.Reconnect(i);this._microphoneSource&&this._microphoneTag===e&&(this._microphoneSource.disconnect(),this._microphoneSource.connect(i))}GetMasterVolume(){return this._masterVolume}IsSilent(){return this._isSilent}GetTimeScaleMode(){return this._timeScaleMode}GetTimeScale(){return this._timeScale}GetGameTime(){return this._gameTime}IsPlayMusicAsSound(){return this._playMusicAsSound}SupportsWebMOpus(){return this._supportsWebMOpus}_SetHasAnySoftwareDecodedMusic(){this._hasAnySoftwareDecodedMusic=!0}GetPanningModel(){return this._panningModel}GetDistanceModel(){return this._distanceModel}GetReferenceDistance(){return this._refDistance}GetMaxDistance(){return this._maxDistance}GetRolloffFactor(){return this._rolloffFactor}DecodeAudioData(e,i){return i?this._iRuntime._WasmDecodeWebMOpus(e).then(n=>{const r=this._audioContext.createBuffer(1,n.length,48e3);return r.getChannelData(0).set(n),r}):new Promise((n,r)=>{this._audioContext.decodeAudioData(e,n,r)})}TryPlayMedia(e){this._iRuntime.TryPlayMedia(e)}RemovePendingPlay(e){this._iRuntime.RemovePendingPlay(e)}ReleaseInstancesForBuffer(e){let i=0;for(let n=0,r=this._audioInstances.length;n<r;++n){const c=this._audioInstances[n];this._audioInstances[i]=c,c.GetBuffer()===e?c.Release():++i}this._audioInstances.length=i}ReleaseAllMusicBuffers(){let e=0;for(let i=0,n=this._audioBuffers.length;i<n;++i){const r=this._audioBuffers[i];this._audioBuffers[e]=r,r.IsMusic()?r.Release():++e}this._audioBuffers.length=e}*audioInstancesMatchingTags(e){if(e.length>0)for(const i of this._audioInstances)this._MatchTagLists(i.GetTags(),e)&&(yield i);else this._lastAudioInstance&&!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}*audioInstancesByEffectTag(e){if(e)for(const i of this._audioInstances)self.AudioDOMHandler.EqualsNoCase(i.GetEffectTag(),e)&&(yield i);else this._lastAudioInstance&&!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}async _GetAudioBuffer(e,i,n,r,c){for(const p of this._audioBuffers)if(p.GetUrl()===i)return await p.Load(),p;if(c)return null;r&&(this._playMusicAsSound||this._hasAnySoftwareDecodedMusic)&&this.ReleaseAllMusicBuffers();const u=self.C3AudioBuffer.Create(this,e,i,n,r);return this._audioBuffers.push(u),await u.Load(),this._loadedAudioUrls.has(e)||(this.PostToRuntime("buffer-metadata",{originalUrl:e,duration:u.GetDuration()}),this._loadedAudioUrls.add(e)),u}async _GetAudioInstance(e,i,n,r,c){for(const T of this._audioInstances)if(T.GetUrl()===i&&(T.CanBeRecycled()||c))return T.SetTags(r),T;const p=(await this._GetAudioBuffer(e,i,n,c)).CreateInstance(r);return this._audioInstances.push(p),p}_AddPendingTags(e){const i=e.join(" ");let n=this._pendingTags.get(i);if(!n){let r=null;n={pendingCount:0,promise:new Promise(u=>r=u),resolve:r},this._pendingTags.set(i,n)}n.pendingCount++}_RemovePendingTags(e){const i=e.join(" "),n=this._pendingTags.get(i);if(!n)throw new Error("expected pending tag");n.pendingCount--,n.pendingCount===0&&(n.resolve(),this._pendingTags.delete(i))}TagsReady(e){const i=(e.length===0?this._lastPlayedTags:e).join(" "),n=this._pendingTags.get(i);return n?n.promise:Promise.resolve()}_MaybeStartTicking(){if(this._analysers.size>0){this._StartTicking();return}for(const e of this._audioInstances)if(e.IsActive()){this._StartTicking();return}}Tick(){for(const n of this._analysers)n.Tick();const e=this.GetAudioCurrentTime();for(const n of this._audioInstances)n.Tick(e);const i=this._audioInstances.filter(n=>n.IsActive()).map(n=>n.GetState());this.PostToRuntime("state",{tickCount:this._lastTickCount,outputLatency:this._audioContext.outputLatency||0,audioInstances:i,analysers:[...this._analysers].map(n=>n.GetData())}),i.length===0&&this._analysers.size===0&&this._StopTicking()}PostTrigger(e,i,n){this.PostToRuntime("trigger",{type:e,tags:i,aiid:n})}async _Play(e){const i=e.originalUrl,n=e.url,r=e.type,c=e.isMusic,u=e.tags,p=e.isLooping,T=e.vol,M=e.pos,R=e.panning,C=e.stereoPan;let A=e.off;if(A>0&&!e.trueClock)if(this._audioContext.getOutputTimestamp){const E=this._audioContext.getOutputTimestamp();A=A-E.performanceTime/1e3+E.contextTime}else A=A-performance.now()/1e3+this._audioContext.currentTime;this._lastPlayedTags=u.slice(0),this._AddPendingTags(u);try{this._lastAudioInstance=await this._GetAudioInstance(i,n,r,u,c),R?(this._lastAudioInstance.SetPannerEnabled(!0),this._lastAudioInstance.SetPan(R.x,R.y,R.z,R.angle,R.innerAngle,R.outerAngle,R.outerGain),R.hasOwnProperty("uid")&&this._lastAudioInstance.SetUID(R.uid)):typeof C=="number"&&C!==0?(this._lastAudioInstance.SetStereoPannerEnabled(!0),this._lastAudioInstance.SetStereoPan(C)):(this._lastAudioInstance.SetPannerEnabled(!1),this._lastAudioInstance.SetStereoPannerEnabled(!1)),this._lastAudioInstance.Play(p,T,M,A)}catch(E){console.error("[Construct] Audio: error starting playback: ",E);return}finally{this._RemovePendingTags(u)}this._StartTicking()}_Stop(e){const i=e.tags;for(const n of this.audioInstancesMatchingTags(i))n.Stop()}_StopAll(){for(const e of this._audioInstances)e.Stop()}_SetPaused(e){const i=e.tags,n=e.paused;for(const r of this.audioInstancesMatchingTags(i))n?r.Pause():r.Resume();this._MaybeStartTicking()}_SetVolume(e){const i=e.tags,n=e.vol;for(const r of this.audioInstancesMatchingTags(i))r.SetVolume(n)}_SetStereoPan(e){const i=e.tags,n=e.p;for(const r of this.audioInstancesMatchingTags(i))r.SetStereoPannerEnabled(!0),r.SetStereoPan(n)}async _FadeVolume(e){const i=e.tags,n=e.vol,r=e.duration,c=e.stopOnEnd;await this.TagsReady(i);for(const u of this.audioInstancesMatchingTags(i))u.FadeVolume(n,r,c);this._MaybeStartTicking()}_SetMasterVolume(e){this._masterVolume=e.vol,this._destinationNode.gain.value=this._masterVolume}_SetMuted(e){const i=e.tags,n=e.isMuted;for(const r of this.audioInstancesMatchingTags(i))r.SetMuted(n)}_SetSilent(e){this._isSilent=e.isSilent,this._iRuntime.SetSilent(this._isSilent);for(const i of this._audioInstances)i._UpdateMuted()}_SetLooping(e){const i=e.tags,n=e.isLooping;for(const r of this.audioInstancesMatchingTags(i))r.SetLooping(n)}async _SetPlaybackRate(e){const i=e.tags,n=e.rate;await this.TagsReady(i);for(const r of this.audioInstancesMatchingTags(i))r.SetPlaybackRate(n)}async _Seek(e){const i=e.tags,n=e.pos;await this.TagsReady(i);for(const r of this.audioInstancesMatchingTags(i))r.Seek(n)}async _Preload(e){const i=e.originalUrl,n=e.url,r=e.type,c=e.isMusic;try{await this._GetAudioInstance(i,n,r,"",c)}catch(u){console.error("[Construct] Audio: error preloading: ",u)}}async _Unload(e){const i=e.url,n=e.type,r=e.isMusic,c=await this._GetAudioBuffer("",i,n,r,!0);if(!c)return;c.Release();const u=this._audioBuffers.indexOf(c);u!==-1&&this._audioBuffers.splice(u,1)}_UnloadAll(){for(const e of this._audioBuffers)e.Release();this._audioBuffers.length=0}_SetSuspended(e){const i=e.isSuspended;!i&&this._audioContext.resume&&this._audioContext.resume();for(const n of this._audioInstances)n.SetSuspended(i);i&&this._audioContext.suspend&&this._audioContext.suspend()}_OnTick(e){if(this._timeScale=e.timeScale,this._gameTime=e.gameTime,this._lastTickCount=e.tickCount,this._timeScaleMode!==0)for(const r of this._audioInstances)r._UpdatePlaybackRate();const i=e.listenerPos;i&&(this._lastListenerPos[0]!==i[0]||this._lastListenerPos[1]!==i[1]||this._lastListenerPos[2]!==i[2])&&(this._lastListenerPos[0]=i[0],this._lastListenerPos[1]=i[1],this._lastListenerPos[2]=i[2],this._audioContext.listener.setPosition(i[0],i[1],i[2]));const n=e.listenerOrientation;if(n&&(this._lastListenerOrientation[0]!==n[0]||this._lastListenerOrientation[1]!==n[1]||this._lastListenerOrientation[2]!==n[2]||this._lastListenerOrientation[3]!==n[3]||this._lastListenerOrientation[4]!==n[4]||this._lastListenerOrientation[5]!==n[5])){for(let r=0;r<6;++r)this._lastListenerOrientation[r]=n[r];this._audioContext.listener.setOrientation(...this._lastListenerOrientation)}for(const r of e.instPans){const c=r.uid;for(const u of this._audioInstances)u.GetUID()===c&&u.SetPanXYZA(r.x,r.y,r.z,r.angle)}}async _AddEffect(e){const i=e.type,n=e.hasOwnProperty("tags")?e.tags:[e.tag],r=e.params;let c,u;if(i==="convolution")try{u=await this._GetAudioBuffer(e.bufferOriginalUrl,e.bufferUrl,e.bufferType,!1)}catch(p){console.log("[Construct] Audio: error loading convolution: ",p);return}for(const p of n){if(i==="filter")c=new self.C3AudioFilterFX(this,...r);else if(i==="delay")c=new self.C3AudioDelayFX(this,...r);else if(i==="convolution")c=new self.C3AudioConvolveFX(this,u.GetAudioBuffer(),...r),c._SetBufferInfo(e.bufferOriginalUrl,e.bufferUrl,e.bufferType);else if(i==="flanger")c=new self.C3AudioFlangerFX(this,...r);else if(i==="phaser")c=new self.C3AudioPhaserFX(this,...r);else if(i==="gain")c=new self.C3AudioGainFX(this,...r);else if(i==="stereopan")c=new self.C3AudioStereoPanFX(this,...r);else if(i==="tremolo")c=new self.C3AudioTremoloFX(this,...r);else if(i==="ringmod")c=new self.C3AudioRingModFX(this,...r);else if(i==="distortion")c=new self.C3AudioDistortionFX(this,...r);else if(i==="compressor")c=new self.C3AudioCompressorFX(this,...r);else if(i==="analyser")c=new self.C3AudioAnalyserFX(this,...r);else throw new Error("invalid effect type");this.AddEffectForTag(p,c)}this._PostUpdatedFxState()}_SetEffectParam(e){const i=e.tags,n=e.index,r=e.param,c=e.value,u=e.ramp,p=e.time;for(const T of i){const M=this._effects.get(T.toLowerCase());!M||n<0||n>=M.length||M[n].SetParam(r,c,u,p)}this._PostUpdatedFxState()}_RemoveEffects(e){const i=e.tags;for(const n of i){const r=n.toLowerCase(),c=this._effects.get(r);if(!c||!c.length)return;for(const u of c)u.Release();this._effects.delete(r),this._ReconnectEffects(r)}}_AddAnalyser(e){this._analysers.add(e),this._MaybeStartTicking()}_RemoveAnalyser(e){this._analysers.delete(e)}_PostUpdatedFxState(){this._isPendingPostFxState||(this._isPendingPostFxState=!0,Promise.resolve().then(()=>this._DoPostUpdatedFxState()))}_DoPostUpdatedFxState(){const e={};for(const[i,n]of this._effects)e[i]=n.map(r=>r.GetState());this.PostToRuntime("fxstate",{fxstate:e}),this._isPendingPostFxState=!1}async _OnLoadState(e){const i=e.saveLoadMode;if(i!==3){const u=[];for(const p of this._audioInstances)p.IsMusic()&&i===1||!p.IsMusic()&&i===2?u.push(p):p.Release();this._audioInstances=u}for(const u of this._effects.values())for(const p of u)p.Release();this._effects.clear(),this._timeScale=e.timeScale,this._gameTime=e.gameTime;const n=e.listenerPos;this._lastListenerPos[0]=n[0],this._lastListenerPos[1]=n[1],this._lastListenerPos[2]=n[2],this._audioContext.listener.setPosition(n[0],n[1],n[2]);const r=e.listenerOrientation;if(Array.isArray(r)){for(let u=0;u<6;++u)this._lastListenerOrientation[u]=r[u];this._audioContext.listener.setOrientation(...this._lastListenerOrientation)}this._isSilent=e.isSilent,this._iRuntime.SetSilent(this._isSilent),this._masterVolume=e.masterVolume,this._destinationNode.gain.value=this._masterVolume;const c=[];for(const u of Object.values(e.effects))c.push(Promise.all(u.map(p=>this._AddEffect(p))));await Promise.all(c),await Promise.all(e.playing.map(u=>this._LoadAudioInstance(u,i))),this._MaybeStartTicking()}async _LoadAudioInstance(e,i){if(i===3)return;const n=e.bufferOriginalUrl,r=e.bufferUrl,c=e.bufferType,u=e.isMusic,p=e.tags,T=e.isLooping,M=e.volume,R=e.playbackTime;if(u&&i===1||!u&&i===2)return;let C=null;try{C=await this._GetAudioInstance(n,r,c,p,u)}catch(A){console.error("[Construct] Audio: error loading audio state: ",A);return}C.LoadPanState(e.pan),C.LoadStereoPanState(e.stereoPan),C.Play(T,M,R,0),e.isPlaying||C.Pause(),C._LoadAdditionalState(e)}_OnMicrophoneStream(e,i){this._microphoneSource&&this._microphoneSource.disconnect(),this._microphoneTag=i.toLowerCase(),this._microphoneSource=this._audioContext.createMediaStreamSource(e),this._microphoneSource.connect(this.GetDestinationForTag(this._microphoneTag))}_OnGetOutputStream(){return this._destMediaStreamNode||(this._destMediaStreamNode=this._audioContext.createMediaStreamDestination(),this._destinationNode.connect(this._destMediaStreamNode)),this._destMediaStreamNode.stream}async _OnOfflineRenderAudio(e){try{const i=e.time,n=this._audioContext.suspend(i);this._hasStartedOfflineRender?this._audioContext.resume():(this._audioContext.startRendering().then(r=>this._OnOfflineRenderCompleted(r)).catch(r=>this._OnOfflineRenderError(r)),this._hasStartedOfflineRender=!0),await n}catch(i){this._OnOfflineRenderError(i)}}_OnOfflineRenderFinish(){this._audioContext.resume()}_OnOfflineRenderCompleted(e){const i=[];for(let n=0,r=e.numberOfChannels;n<r;++n){const c=e.getChannelData(n);i.push(c.buffer)}this._iRuntime.PostToRuntimeComponent("runtime","offline-audio-render-completed",{duration:e.duration,length:e.length,numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate,channelData:i},null,i)}_OnOfflineRenderError(e){console.error("[Audio] Offline rendering error: ",e)}static EqualsNoCase(e,i){return e===i||e.normalize().toLowerCase()===i.normalize().toLowerCase()}static ToDegrees(e){return e*f}static DbToLinearNoCap(e){return Math.pow(10,e/20)}static DbToLinear(e){return Math.max(Math.min(self.AudioDOMHandler.DbToLinearNoCap(e),1),0)}static LinearToDbNoCap(e){return Math.log(e)/Math.log(10)*20}static LinearToDb(e){return self.AudioDOMHandler.LinearToDbNoCap(Math.max(Math.min(e,1),0))}static e4(e,i){return 1-Math.exp(-i*e)}},self.RuntimeInterface.AddDOMHandlerClass(self.AudioDOMHandler)}self.C3AudioBuffer=class{constructor(l,s,e,i,n){this._audioDomHandler=l,this._originalUrl=s,this._url=e,this._type=i,this._isMusic=n,this._api="",this._loadState="not-loaded",this._loadPromise=null}Release(){this._loadState="not-loaded",this._audioDomHandler=null,this._loadPromise=null}static Create(l,s,e,i,n){const r=i==="audio/webm; codecs=opus"&&!l.SupportsWebMOpus();return n&&r&&l._SetHasAnySoftwareDecodedMusic(),!n||l.IsPlayMusicAsSound()||r?new self.C3WebAudioBuffer(l,s,e,i,n,r):new self.C3Html5AudioBuffer(l,s,e,i,n)}CreateInstance(l){return this._api==="html5"?new self.C3Html5AudioInstance(this._audioDomHandler,this,l):new self.C3WebAudioInstance(this._audioDomHandler,this,l)}_Load(){}Load(){return this._loadPromise||(this._loadPromise=this._Load()),this._loadPromise}IsLoaded(){}IsLoadedAndDecoded(){}HasFailedToLoad(){return this._loadState==="failed"}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetApi(){return this._api}GetOriginalUrl(){return this._originalUrl}GetUrl(){return this._url}GetContentType(){return this._type}IsMusic(){return this._isMusic}GetDuration(){}};self.C3Html5AudioBuffer=class extends self.C3AudioBuffer{constructor(l,s,e,i,n){super(l,s,e,i,n),this._api="html5",this._audioElem=new Audio,this._audioElem.crossOrigin="anonymous",this._audioElem.autoplay=!1,this._audioElem.preload="auto",this._loadResolve=null,this._loadReject=null,this._reachedCanPlayThrough=!1,this._audioElem.addEventListener("canplaythrough",()=>this._reachedCanPlayThrough=!0),this._outNode=this.GetAudioContext().createGain(),this._mediaSourceNode=null,this._audioElem.addEventListener("canplay",()=>{this._loadResolve&&(this._loadState="loaded",this._loadResolve(),this._loadResolve=null,this._loadReject=null),!(this._mediaSourceNode||!this._audioElem)&&(this._mediaSourceNode=this.GetAudioContext().createMediaElementSource(this._audioElem),this._mediaSourceNode.connect(this._outNode))}),this.onended=null,this._audioElem.addEventListener("ended",()=>{this.onended&&this.onended()}),this._audioElem.addEventListener("error",r=>this._OnError(r))}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._outNode.disconnect(),this._outNode=null,this._mediaSourceNode.disconnect(),this._mediaSourceNode=null,this._audioElem&&!this._audioElem.paused&&this._audioElem.pause(),this.onended=null,this._audioElem=null,super.Release()}_Load(){return this._loadState="loading",new Promise((l,s)=>{this._loadResolve=l,this._loadReject=s,this._audioElem.src=this._url})}_OnError(l){console.error(`[Construct] Audio '${this._url}' error: `,l),this._loadReject&&(this._loadState="failed",this._loadReject(l),this._loadResolve=null,this._loadReject=null)}IsLoaded(){const l=this._audioElem.readyState>=4;return l&&(this._reachedCanPlayThrough=!0),l||this._reachedCanPlayThrough}IsLoadedAndDecoded(){return this.IsLoaded()}GetAudioElement(){return this._audioElem}GetOutputNode(){return this._outNode}GetDuration(){return this._audioElem.duration}};self.C3WebAudioBuffer=class extends self.C3AudioBuffer{constructor(l,s,e,i,n,r){super(l,s,e,i,n),this._api="webaudio",this._audioData=null,this._audioBuffer=null,this._needsSoftwareDecode=!!r}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._audioData=null,this._audioBuffer=null,super.Release()}async _Fetch(){if(this._audioData)return this._audioData;const l=this._audioDomHandler.GetRuntimeInterface();if(l.GetExportType()==="cordova"&&l.IsRelativeURL(this._url)&&l.IsFileProtocol())this._audioData=await l.CordovaFetchLocalFileAsArrayBuffer(this._url);else{const s=await fetch(this._url);if(!s.ok)throw new Error(`error fetching audio data: ${s.status} ${s.statusText}`);this._audioData=await s.arrayBuffer()}}async _Decode(){if(this._audioBuffer)return this._audioBuffer;this._audioBuffer=await this._audioDomHandler.DecodeAudioData(this._audioData,this._needsSoftwareDecode),this._audioData=null}async _Load(){try{this._loadState="loading",await this._Fetch(),await this._Decode(),this._loadState="loaded"}catch(l){this._loadState="failed",console.error(`[Construct] Failed to load audio '${this._url}': `,l)}}IsLoaded(){return!!(this._audioData||this._audioBuffer)}IsLoadedAndDecoded(){return!!this._audioBuffer}GetAudioBuffer(){return this._audioBuffer}GetDuration(){return this._audioBuffer?this._audioBuffer.duration:0}};{let f=0;self.C3AudioInstance=class{constructor(s,e,i){this._audioDomHandler=s,this._buffer=e,this._tags=i,this._aiId=f++,this._gainNode=this.GetAudioContext().createGain(),this._gainNode.connect(this.GetDestinationNode()),this._pannerNode=null,this._isPannerEnabled=!1,this._pannerPosition=[0,0,0],this._pannerOrientation=[0,0,0],this._pannerConeParams=[0,0,0],this._stereoPannerNode=null,this._isStereoPannerEnabled=!1,this._stereoPan=0,this._isStopped=!0,this._isPaused=!1,this._resumeMe=!1,this._isLooping=!1,this._volume=1,this._isMuted=!1,this._playbackRate=1;const n=this._audioDomHandler.GetTimeScaleMode();this._isTimescaled=n===1&&!this.IsMusic()||n===2,this._instUid=-1,this._fadeEndTime=-1,this._stopOnFadeEnd=!1}Release(){this._audioDomHandler=null,this._buffer=null,this._pannerNode&&(this._pannerNode.disconnect(),this._pannerNode=null),this._stereoPannerNode&&(this._stereoPannerNode.disconnect(),this._stereoPannerNode=null),this._gainNode.disconnect(),this._gainNode=null}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}SetTags(s){this._tags=s}GetTags(){return this._tags}GetEffectTag(){return this._tags.length>0?this._tags[0]:""}GetDestinationNode(){return this._audioDomHandler.GetDestinationForTag(this.GetEffectTag())}GetCurrentTime(){return this._isTimescaled?this._audioDomHandler.GetGameTime():performance.now()/1e3}GetOriginalUrl(){return this._buffer.GetOriginalUrl()}GetUrl(){return this._buffer.GetUrl()}GetContentType(){return this._buffer.GetContentType()}GetBuffer(){return this._buffer}IsMusic(){return this._buffer.IsMusic()}GetAiId(){return this._aiId}HasEnded(){}CanBeRecycled(){}IsPlaying(){return!this._isStopped&&!this._isPaused&&!this.HasEnded()}IsActive(){return!this._isStopped&&!this.HasEnded()}GetPlaybackTime(){}GetDuration(s){let e=this._buffer.GetDuration();return s&&(e/=this._playbackRate||.001),e}Play(s,e,i,n){}Stop(){}Pause(){}IsPaused(){return this._isPaused}Resume(){}SetVolume(s){this._volume=s,this._gainNode.gain.cancelScheduledValues(0),this._fadeEndTime=-1,this._gainNode.gain.value=this.GetOutputVolume()}FadeVolume(s,e,i){if(this.IsMuted())return;const n=this._gainNode.gain;n.cancelScheduledValues(0);const r=this._audioDomHandler.GetAudioCurrentTime(),c=r+e;n.setValueAtTime(n.value,r),n.linearRampToValueAtTime(s,c),this._volume=s,this._fadeEndTime=c,this._stopOnFadeEnd=i}_UpdateVolume(){this.SetVolume(this._volume)}Tick(s){this._fadeEndTime!==-1&&s>=this._fadeEndTime&&(this._fadeEndTime=-1,this._stopOnFadeEnd&&this.Stop(),this._audioDomHandler.PostTrigger("fade-ended",this._tags,this._aiId))}GetOutputVolume(){const s=this._volume;return isFinite(s)?s:0}SetMuted(s){s=!!s,this._isMuted!==s&&(this._isMuted=s,this._UpdateMuted())}IsMuted(){return this._isMuted}IsSilent(){return this._audioDomHandler.IsSilent()}_UpdateMuted(){}SetLooping(s){}IsLooping(){return this._isLooping}SetPlaybackRate(s){this._playbackRate!==s&&(this._playbackRate=s,this._UpdatePlaybackRate())}_UpdatePlaybackRate(){}GetPlaybackRate(){return this._playbackRate}Seek(s){}SetSuspended(s){}SetPannerEnabled(s){s=!!s,this._isPannerEnabled!==s&&(this._isPannerEnabled=s,this._isPannerEnabled?(this.SetStereoPannerEnabled(!1),this._pannerNode||(this._pannerNode=this.GetAudioContext().createPanner(),this._pannerNode.panningModel=this._audioDomHandler.GetPanningModel(),this._pannerNode.distanceModel=this._audioDomHandler.GetDistanceModel(),this._pannerNode.refDistance=this._audioDomHandler.GetReferenceDistance(),this._pannerNode.maxDistance=this._audioDomHandler.GetMaxDistance(),this._pannerNode.rolloffFactor=this._audioDomHandler.GetRolloffFactor()),this._gainNode.disconnect(),this._gainNode.connect(this._pannerNode),this._pannerNode.connect(this.GetDestinationNode())):(this._pannerNode.disconnect(),this._gainNode.disconnect(),this._gainNode.connect(this.GetDestinationNode())))}SetPan(s,e,i,n,r,c,u){if(!this._isPannerEnabled)return;this.SetPanXYZA(s,e,i,n);const p=self.AudioDOMHandler.ToDegrees;this._pannerConeParams[0]!==p(r)&&(this._pannerConeParams[0]=p(r),this._pannerNode.coneInnerAngle=p(r)),this._pannerConeParams[1]!==p(c)&&(this._pannerConeParams[1]=p(c),this._pannerNode.coneOuterAngle=p(c)),this._pannerConeParams[2]!==u&&(this._pannerConeParams[2]=u,this._pannerNode.coneOuterGain=u)}SetPanXYZA(s,e,i,n){if(!this._isPannerEnabled)return;const r=this._pannerPosition,c=this._pannerOrientation,u=Math.cos(n),p=Math.sin(n);(r[0]!==s||r[1]!==e||r[2]!==i)&&(r[0]=s,r[1]=e,r[2]=i,this._pannerNode.setPosition(...r)),(c[0]!==u||c[1]!==p||c[2]!==0)&&(c[0]=u,c[1]=p,c[2]=0,this._pannerNode.setOrientation(...c))}SetStereoPannerEnabled(s){s=!!s,this._isStereoPannerEnabled!==s&&(this._isStereoPannerEnabled=s,this._isStereoPannerEnabled?(this.SetPannerEnabled(!1),this._stereoPannerNode=this.GetAudioContext().createStereoPanner(),this._gainNode.disconnect(),this._gainNode.connect(this._stereoPannerNode),this._stereoPannerNode.connect(this.GetDestinationNode())):(this._stereoPannerNode.disconnect(),this._stereoPannerNode=null,this._gainNode.disconnect(),this._gainNode.connect(this.GetDestinationNode())))}SetStereoPan(s){this._isStereoPannerEnabled&&this._stereoPan!==s&&(this._stereoPannerNode.pan.value=s,this._stereoPan=s)}SetUID(s){this._instUid=s}GetUID(){return this._instUid}GetResumePosition(){}Reconnect(s){const e=this._stereoPannerNode||this._pannerNode||this._gainNode;e.disconnect(),e.connect(s)}GetState(){return{aiid:this.GetAiId(),tags:this._tags,duration:this.GetDuration(),volume:this._fadeEndTime===-1?this._volume:this._gainNode.gain.value,isPlaying:this.IsPlaying(),playbackTime:this.GetPlaybackTime(),playbackRate:this.GetPlaybackRate(),uid:this._instUid,bufferOriginalUrl:this.GetOriginalUrl(),bufferUrl:"",bufferType:this.GetContentType(),isMusic:this.IsMusic(),isLooping:this.IsLooping(),isMuted:this.IsMuted(),resumePosition:this.GetResumePosition(),pan:this.GetPanState(),stereoPan:this.GetStereoPanState()}}_LoadAdditionalState(s){this.SetPlaybackRate(s.playbackRate),this.SetMuted(s.isMuted)}GetPanState(){if(!this._pannerNode)return null;const s=this._pannerNode;return{pos:this._pannerPosition,orient:this._pannerOrientation,cia:s.coneInnerAngle,coa:s.coneOuterAngle,cog:s.coneOuterGain,uid:this._instUid}}LoadPanState(s){if(!s){this.SetPannerEnabled(!1);return}this.SetPannerEnabled(!0);const e=this._pannerNode,i=s.pos;this._pannerPosition[0]=i[0],this._pannerPosition[1]=i[1],this._pannerPosition[2]=i[2];const n=s.orient;this._pannerOrientation[0]=n[0],this._pannerOrientation[1]=n[1],this._pannerOrientation[2]=n[2],e.setPosition(...this._pannerPosition),e.setOrientation(...this._pannerOrientation),this._pannerConeParams[0]=s.cia,this._pannerConeParams[1]=s.coa,this._pannerConeParams[2]=s.cog,e.coneInnerAngle=s.cia,e.coneOuterAngle=s.coa,e.coneOuterGain=s.cog,this._instUid=s.uid}GetStereoPanState(){return this._stereoPannerNode?this._stereoPan:null}LoadStereoPanState(s){if(typeof s!="number"){this.SetStereoPannerEnabled(!1);return}this.SetStereoPannerEnabled(!0),this.SetStereoPan(s)}}}self.C3Html5AudioInstance=class extends self.C3AudioInstance{constructor(l,s,e){super(l,s,e),this._buffer.GetOutputNode().connect(this._gainNode),this._buffer.onended=()=>this._OnEnded()}Release(){this.Stop(),this._buffer.GetOutputNode().disconnect(),super.Release()}GetAudioElement(){return this._buffer.GetAudioElement()}_OnEnded(){this._isStopped=!0,this._instUid=-1,this._audioDomHandler.PostTrigger("ended",this._tags,this._aiId)}HasEnded(){return this.GetAudioElement().ended}CanBeRecycled(){return this._isStopped?!0:this.HasEnded()}GetPlaybackTime(){let l=this.GetAudioElement().currentTime;return this._isLooping||(l=Math.min(l,this.GetDuration())),l}Play(l,s,e,i){const n=this.GetAudioElement();if(n.playbackRate!==1&&(n.playbackRate=1),n.loop!==l&&(n.loop=l),this.SetVolume(s),this._isMuted=!1,n.muted&&(n.muted=!1),n.currentTime!==e)try{n.currentTime=e}catch(r){console.warn(`[Construct] Exception seeking audio '${this._buffer.GetUrl()}' to position '${e}': `,r)}this._audioDomHandler.TryPlayMedia(n),this._isStopped=!1,this._isPaused=!1,this._isLooping=l,this._playbackRate=1}Stop(){const l=this.GetAudioElement();l.paused||l.pause(),this._audioDomHandler.RemovePendingPlay(l),this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){if(this._isPaused||this._isStopped||this.HasEnded())return;const l=this.GetAudioElement();l.paused||l.pause(),this._audioDomHandler.RemovePendingPlay(l),this._isPaused=!0}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._isPaused=!1)}_UpdateMuted(){this.GetAudioElement().muted=this._isMuted||this.IsSilent()}SetLooping(l){l=!!l,this._isLooping!==l&&(this._isLooping=l,this.GetAudioElement().loop=l)}_UpdatePlaybackRate(){let l=this._playbackRate;this._isTimescaled&&(l*=this._audioDomHandler.GetTimeScale());try{this.GetAudioElement().playbackRate=l}catch(s){console.warn(`[Construct] Unable to set playback rate '${l}':`,s)}}Seek(l){if(!(this._isStopped||this.HasEnded()))try{this.GetAudioElement().currentTime=l}catch(s){console.warn(`[Construct] Error seeking audio to '${l}': `,s)}}GetResumePosition(){return this.GetPlaybackTime()}SetSuspended(l){l?this.IsPlaying()?(this.GetAudioElement().pause(),this._resumeMe=!0):this._resumeMe=!1:this._resumeMe&&(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._resumeMe=!1)}};self.C3WebAudioInstance=class extends self.C3AudioInstance{constructor(l,s,e){super(l,s,e),this._bufferSource=null,this._onended_handler=i=>this._OnEnded(i),this._hasPlaybackEnded=!0,this._activeSource=null,this._playStartTime=0,this._playFromSeekPos=0,this._resumePosition=0,this._muteVol=1}Release(){this.Stop(),this._ReleaseBufferSource(),this._onended_handler=null,super.Release()}_ReleaseBufferSource(){this._bufferSource&&(this._bufferSource.onended=null,this._bufferSource.disconnect(),this._bufferSource.buffer=null),this._bufferSource=null,this._activeSource=null}_OnEnded(l){this._isPaused||this._resumeMe||l.target===this._activeSource&&(this._hasPlaybackEnded=!0,this._isStopped=!0,this._instUid=-1,this._ReleaseBufferSource(),this._audioDomHandler.PostTrigger("ended",this._tags,this._aiId))}HasEnded(){return!this._isStopped&&this._bufferSource&&this._bufferSource.loop||this._isPaused?!1:this._hasPlaybackEnded}CanBeRecycled(){return!this._bufferSource||this._isStopped?!0:this.HasEnded()}GetPlaybackTime(){let l=0;return this._isPaused?l=this._resumePosition:l=this._playFromSeekPos+(this.GetCurrentTime()-this._playStartTime)*this._playbackRate,this._isLooping||(l=Math.min(l,this.GetDuration())),l}Play(l,s,e,i){this._isMuted=!1,this._muteVol=1,this.SetVolume(s),this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=l,this._bufferSource.start(i,e),this._hasPlaybackEnded=!1,this._isStopped=!1,this._isPaused=!1,this._isLooping=l,this._playbackRate=1,this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=e}Stop(){if(this._bufferSource)try{this._bufferSource.stop(0)}catch{}this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){this._isPaused||this._isStopped||this.HasEnded()||(this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._isPaused=!0,this._bufferSource.stop(0))}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,this._isPaused=!1)}GetOutputVolume(){return super.GetOutputVolume()*this._muteVol}_UpdateMuted(){this._muteVol=this._isMuted||this.IsSilent()?0:1,this._UpdateVolume()}SetLooping(l){l=!!l,this._isLooping!==l&&(this._isLooping=l,this._bufferSource&&(this._bufferSource.loop=l))}_UpdatePlaybackRate(){let l=this._playbackRate;this._isTimescaled&&(l*=this._audioDomHandler.GetTimeScale()),this._bufferSource&&(this._bufferSource.playbackRate.value=l)}Seek(l){this._isStopped||this.HasEnded()||(this._isPaused?this._resumePosition=l:(this.Pause(),this._resumePosition=l,this.Resume()))}GetResumePosition(){return this._resumePosition}SetSuspended(l){l?this.IsPlaying()?(this._resumeMe=!0,this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._bufferSource.stop(0)):this._resumeMe=!1:this._resumeMe&&(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,this._resumeMe=!1)}_LoadAdditionalState(l){super._LoadAdditionalState(l),this._resumePosition=l.resumePosition}};{class f{constructor(s){this._audioDomHandler=s,this._audioContext=s.GetAudioContext(),this._index=-1,this._tag="",this._type="",this._params=null}Release(){this._audioContext=null}_SetIndex(s){this._index=s}GetIndex(){return this._index}_SetTag(s){this._tag=s}GetTag(){return this._tag}CreateGain(){return this._audioContext.createGain()}GetInputNode(){}ConnectTo(s){}SetAudioParam(s,e,i,n){if(s.cancelScheduledValues(0),n===0){s.value=e;return}const r=this._audioContext.currentTime;switch(n+=r,i){case 0:s.setValueAtTime(e,n);break;case 1:s.setValueAtTime(s.value,r),s.linearRampToValueAtTime(e,n);break;case 2:s.setValueAtTime(s.value,r),s.exponentialRampToValueAtTime(e,n);break}}GetState(){return{type:this._type,tag:this._tag,params:this._params}}}self.C3AudioFilterFX=class extends f{constructor(s,e,i,n,r,c,u){super(s),this._type="filter",this._params=[e,i,n,r,c,u],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=u,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-u,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type=e,this._filterNode.frequency.value=i,this._filterNode.detune.value=n,this._filterNode.Q.value=r,this._filterNode.gain.vlaue=c,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._filterNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(s){this._wetNode.disconnect(),this._wetNode.connect(s),this._dryNode.disconnect(),this._dryNode.connect(s)}GetInputNode(){return this._inputNode}SetParam(s,e,i,n){switch(s){case 0:e=Math.max(Math.min(e/100,1),0),this._params[5]=e,this.SetAudioParam(this._wetNode.gain,e,i,n),this.SetAudioParam(this._dryNode.gain,1-e,i,n);break;case 1:this._params[1]=e,this.SetAudioParam(this._filterNode.frequency,e,i,n);break;case 2:this._params[2]=e,this.SetAudioParam(this._filterNode.detune,e,i,n);break;case 3:this._params[3]=e,this.SetAudioParam(this._filterNode.Q,e,i,n);break;case 4:this._params[4]=e,this.SetAudioParam(this._filterNode.gain,e,i,n);break}}},self.C3AudioDelayFX=class extends f{constructor(s,e,i,n){super(s),this._type="delay",this._params=[e,i,n],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=n,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-n,this._mainNode=this.CreateGain(),this._delayNode=this._audioContext.createDelay(e),this._delayNode.delayTime.value=e,this._delayGainNode=this.CreateGain(),this._delayGainNode.gain.value=i,this._inputNode.connect(this._mainNode),this._inputNode.connect(this._dryNode),this._mainNode.connect(this._wetNode),this._mainNode.connect(this._delayNode),this._delayNode.connect(this._delayGainNode),this._delayGainNode.connect(this._mainNode)}Release(){this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),this._mainNode.disconnect(),this._delayNode.disconnect(),this._delayGainNode.disconnect(),super.Release()}ConnectTo(s){this._wetNode.disconnect(),this._wetNode.connect(s),this._dryNode.disconnect(),this._dryNode.connect(s)}GetInputNode(){return this._inputNode}SetParam(s,e,i,n){const r=self.AudioDOMHandler.DbToLinear;switch(s){case 0:e=Math.max(Math.min(e/100,1),0),this._params[2]=e,this.SetAudioParam(this._wetNode.gain,e,i,n),this.SetAudioParam(this._dryNode.gain,1-e,i,n);break;case 4:this._params[1]=r(e),this.SetAudioParam(this._delayGainNode.gain,r(e),i,n);break;case 5:this._params[0]=e,this.SetAudioParam(this._delayNode.delayTime,e,i,n);break}}},self.C3AudioConvolveFX=class extends f{constructor(s,e,i,n){super(s),this._type="convolution",this._params=[i,n],this._bufferOriginalUrl="",this._bufferUrl="",this._bufferType="",this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=n,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-n,this._convolveNode=this._audioContext.createConvolver(),this._convolveNode.normalize=i,this._convolveNode.buffer=e,this._inputNode.connect(this._convolveNode),this._inputNode.connect(this._dryNode),this._convolveNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._convolveNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(s){this._wetNode.disconnect(),this._wetNode.connect(s),this._dryNode.disconnect(),this._dryNode.connect(s)}GetInputNode(){return this._inputNode}SetParam(s,e,i,n){switch(s){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._wetNode.gain,e,i,n),this.SetAudioParam(this._dryNode.gain,1-e,i,n);break}}_SetBufferInfo(s,e,i){this._bufferOriginalUrl=s,this._bufferUrl=e,this._bufferType=i}GetState(){const s=super.GetState();return s.bufferOriginalUrl=this._bufferOriginalUrl,s.bufferUrl="",s.bufferType=this._bufferType,s}},self.C3AudioFlangerFX=class extends f{constructor(s,e,i,n,r,c){super(s),this._type="flanger",this._params=[e,i,n,r,c],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-c/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=c/2,this._feedbackNode=this.CreateGain(),this._feedbackNode.gain.value=r,this._delayNode=this._audioContext.createDelay(e+i),this._delayNode.delayTime.value=e,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=n,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=i,this._inputNode.connect(this._delayNode),this._inputNode.connect(this._dryNode),this._delayNode.connect(this._wetNode),this._delayNode.connect(this._feedbackNode),this._feedbackNode.connect(this._delayNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._delayNode.delayTime),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._delayNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),this._feedbackNode.disconnect(),super.Release()}ConnectTo(s){this._wetNode.disconnect(),this._wetNode.connect(s),this._dryNode.disconnect(),this._dryNode.connect(s)}GetInputNode(){return this._inputNode}SetParam(s,e,i,n){switch(s){case 0:e=Math.max(Math.min(e/100,1),0),this._params[4]=e,this.SetAudioParam(this._wetNode.gain,e/2,i,n),this.SetAudioParam(this._dryNode.gain,1-e/2,i,n);break;case 6:this._params[1]=e/1e3,this.SetAudioParam(this._oscGainNode.gain,e/1e3,i,n);break;case 7:this._params[2]=e,this.SetAudioParam(this._oscNode.frequency,e,i,n);break;case 8:this._params[3]=e/100,this.SetAudioParam(this._feedbackNode.gain,e/100,i,n);break}}},self.C3AudioPhaserFX=class extends f{constructor(s,e,i,n,r,c,u){super(s),this._type="phaser",this._params=[e,i,n,r,c,u],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-u/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=u/2,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type="allpass",this._filterNode.frequency.value=e,this._filterNode.detune.value=i,this._filterNode.Q.value=n,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=c,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=r,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._filterNode.frequency),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._filterNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),super.Release()}ConnectTo(s){this._wetNode.disconnect(),this._wetNode.connect(s),this._dryNode.disconnect(),this._dryNode.connect(s)}GetInputNode(){return this._inputNode}SetParam(s,e,i,n){switch(s){case 0:e=Math.max(Math.min(e/100,1),0),this._params[5]=e,this.SetAudioParam(this._wetNode.gain,e/2,i,n),this.SetAudioParam(this._dryNode.gain,1-e/2,i,n);break;case 1:this._params[0]=e,this.SetAudioParam(this._filterNode.frequency,e,i,n);break;case 2:this._params[1]=e,this.SetAudioParam(this._filterNode.detune,e,i,n);break;case 3:this._params[2]=e,this.SetAudioParam(this._filterNode.Q,e,i,n);break;case 6:this._params[3]=e,this.SetAudioParam(this._oscGainNode.gain,e,i,n);break;case 7:this._params[4]=e,this.SetAudioParam(this._oscNode.frequency,e,i,n);break}}},self.C3AudioGainFX=class extends f{constructor(s,e){super(s),this._type="gain",this._params=[e],this._node=this.CreateGain(),this._node.gain.value=e}Release(){this._node.disconnect(),super.Release()}ConnectTo(s){this._node.disconnect(),this._node.connect(s)}GetInputNode(){return this._node}SetParam(s,e,i,n){const r=self.AudioDOMHandler.DbToLinear;switch(s){case 4:this._params[0]=r(e),this.SetAudioParam(this._node.gain,r(e),i,n);break}}},self.C3AudioStereoPanFX=class extends f{constructor(s,e){super(s),this._type="stereopan",this._params=[e],this._node=this._audioContext.createStereoPanner(),this._node.pan.value=e}Release(){this._node.disconnect(),super.Release()}ConnectTo(s){this._node.disconnect(),this._node.connect(s)}GetInputNode(){return this._node}SetParam(s,e,i,n){switch(e=Math.min(Math.max(e/100,-1),1),s){case 9:this._params[0]=e,this.SetAudioParam(this._node.pan,e,i,n);break}}},self.C3AudioTremoloFX=class extends f{constructor(s,e,i){super(s),this._type="tremolo",this._params=[e,i],this._node=this.CreateGain(),this._node.gain.value=1-i/2,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=e,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=i/2,this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._node.gain),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._node.disconnect(),super.Release()}ConnectTo(s){this._node.disconnect(),this._node.connect(s)}GetInputNode(){return this._node}SetParam(s,e,i,n){switch(s){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._node.gain,1-e/2,i,n),this.SetAudioParam(this._oscGainNode.gain,e/2,i,n);break;case 7:this._params[0]=e,this.SetAudioParam(this._oscNode.frequency,e,i,n);break}}},self.C3AudioRingModFX=class extends f{constructor(s,e,i){super(s),this._type="ringmod",this._params=[e,i],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=i,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-i,this._ringNode=this.CreateGain(),this._ringNode.gain.value=0,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=e,this._oscNode.connect(this._ringNode.gain),this._oscNode.start(0),this._inputNode.connect(this._ringNode),this._inputNode.connect(this._dryNode),this._ringNode.connect(this._wetNode)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._ringNode.disconnect(),this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(s){this._wetNode.disconnect(),this._wetNode.connect(s),this._dryNode.disconnect(),this._dryNode.connect(s)}GetInputNode(){return this._inputNode}SetParam(s,e,i,n){switch(s){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._wetNode.gain,e,i,n),this.SetAudioParam(this._dryNode.gain,1-e,i,n);break;case 7:this._params[0]=e,this.SetAudioParam(this._oscNode.frequency,e,i,n);break}}},self.C3AudioDistortionFX=class extends f{constructor(s,e,i,n,r,c){super(s),this._type="distortion",this._params=[e,i,n,r,c],this._inputNode=this.CreateGain(),this._preGain=this.CreateGain(),this._postGain=this.CreateGain(),this._SetDrive(n,r),this._wetNode=this.CreateGain(),this._wetNode.gain.value=c,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-c,this._waveShaper=this._audioContext.createWaveShaper(),this._curve=new Float32Array(65536),this._GenerateColortouchCurve(e,i),this._waveShaper.curve=this._curve,this._inputNode.connect(this._preGain),this._inputNode.connect(this._dryNode),this._preGain.connect(this._waveShaper),this._waveShaper.connect(this._postGain),this._postGain.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._preGain.disconnect(),this._waveShaper.disconnect(),this._postGain.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}_SetDrive(s,e){s<.01&&(s=.01),this._preGain.gain.value=s,this._postGain.gain.value=Math.pow(1/s,.6)*e}_GenerateColortouchCurve(s,e){for(let r=0;r<32768;++r){let c=r/32768;c=this._Shape(c,s,e),this._curve[32768+r]=c,this._curve[32768-r-1]=-c}}_Shape(s,e,i){const r=1.05*i*e-e,c=s<0?-1:1,u=s<0?-s:s;let p=u<e?u:e+r*self.AudioDOMHandler.e4(u-e,1/r);return p*=c,p}ConnectTo(s){this._wetNode.disconnect(),this._wetNode.connect(s),this._dryNode.disconnect(),this._dryNode.connect(s)}GetInputNode(){return this._inputNode}SetParam(s,e,i,n){switch(s){case 0:e=Math.max(Math.min(e/100,1),0),this._params[4]=e,this.SetAudioParam(this._wetNode.gain,e,i,n),this.SetAudioParam(this._dryNode.gain,1-e,i,n);break}}},self.C3AudioCompressorFX=class extends f{constructor(s,e,i,n,r,c){super(s),this._type="compressor",this._params=[e,i,n,r,c],this._node=this._audioContext.createDynamicsCompressor(),this._node.threshold.value=e,this._node.knee.value=i,this._node.ratio.value=n,this._node.attack.value=r,this._node.release.value=c}Release(){this._node.disconnect(),super.Release()}ConnectTo(s){this._node.disconnect(),this._node.connect(s)}GetInputNode(){return this._node}SetParam(s,e,i,n){}},self.C3AudioAnalyserFX=class extends f{constructor(s,e,i){super(s),this._type="analyser",this._params=[e,i],this._node=this._audioContext.createAnalyser(),this._node.fftSize=e,this._node.smoothingTimeConstant=i,this._freqBins=new Float32Array(this._node.frequencyBinCount),this._signal=new Uint8Array(e),this._peak=0,this._rms=0,this._audioDomHandler._AddAnalyser(this)}Release(){this._audioDomHandler._RemoveAnalyser(this),this._node.disconnect(),super.Release()}Tick(){this._node.getFloatFrequencyData(this._freqBins),this._node.getByteTimeDomainData(this._signal);const s=this._node.fftSize;this._peak=0;let e=0;for(let n=0;n<s;++n){let r=(this._signal[n]-128)/128;r<0&&(r=-r),this._peak<r&&(this._peak=r),e+=r*r}const i=self.AudioDOMHandler.LinearToDb;this._peak=i(this._peak),this._rms=i(Math.sqrt(e/s))}ConnectTo(s){this._node.disconnect(),this._node.connect(s)}GetInputNode(){return this._node}SetParam(s,e,i,n){}GetData(){return{tag:this.GetTag(),index:this.GetIndex(),peak:this._peak,rms:this._rms,binCount:this._node.frequencyBinCount,freqBins:this._freqBins}}}}{const f="mouse",l=class extends self.DOMHandler{constructor(e){super(e,f),this.AddRuntimeMessageHandlers([["cursor",i=>this._OnChangeCursorStyle(i)],["request-pointer-lock",()=>this._OnRequestPointerLock()],["release-pointer-lock",()=>this._OnReleasePointerLock()]]),document.addEventListener("pointerlockchange",i=>this._OnPointerLockChange()),document.addEventListener("pointerlockerror",i=>this._OnPointerLockError())}_OnChangeCursorStyle(e){document.documentElement.style.cursor=e}_OnRequestPointerLock(){this._iRuntime.GetMainCanvas().requestPointerLock()}_OnReleasePointerLock(){document.exitPointerLock()}_OnPointerLockChange(){this.PostToRuntime("pointer-lock-change",{"has-pointer-lock":!!document.pointerLockElement})}_OnPointerLockError(){this.PostToRuntime("pointer-lock-error",{"has-pointer-lock":!!document.pointerLockElement})}};self.RuntimeInterface.AddDOMHandlerClass(l)}window.C3_RegisterSW=async function(){if(navigator.serviceWorker)try{const l=await navigator.serviceWorker.register("sw.js",{scope:"./"});console.info("Registered service worker on "+l.scope)}catch(l){console.warn("Failed to register service worker: ",l)}};
